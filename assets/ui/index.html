<!-- Included from: ./root.html -->
<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700&family=EB+Garamond:wght@400;500;600&display=swap" rel="stylesheet">

<!-- Global Functions Accessor -->
 <script>
  window.lumberjackSimulator = {};
 </script>

<!-- Style Overrides -->
<style>
  /* 
    Hide the default player nametag name, but we still
     want to use it for when in-game chat messages are visible.
  */
  .hytopia-nametag:not(.has-chat) {
    opacity: 0 !important;
  }
</style>

<!-- Included from: ./shared/item-stats.html -->
<!-- Shared Item Stats System -->
<script>
/**
 * Centralized Item Stats System
 * Provides consistent stat formatting across all UI components
 */
window.ItemStats = (function() {
  'use strict';

  // Parse color formatting in text: [HEXCODE]text[/] -> <span style="color: #HEXCODE">text</span>
  // Parse line breaks: [b] -> <br>
  function parseText(text) {
    if (!text) return text;
    
    // First, replace [b] with <br> for line breaks
    text = text.replace(/\[b\]/g, '<br>');
    
    // Then, handle color formatting [HEXCODE]text[/] pattern
    const colorPattern = /\[([A-Fa-f0-9]{6})\](.*?)\[\/\]/g;
    
    return text.replace(colorPattern, (match, hexCode, content) => {
      return `<span style="color: #${hexCode}">${content}</span>`;
    });
  }

  function generateItemStats(itemData, options = {}) {
    const config = {
      includeDescription: true,
      includePricing: false,
      showBuyPrice: false,
      showSellPrice: false,
      buyPriceLabel: 'Price: ',
      sellPriceLabel: 'Sells For: ',
      notBuyableLabel: 'Not Buyable',
      notSellableLabel: 'Not Sellable',
      statsClass: 'item-stats',
      descriptionClass: 'item-description',
      priceClass: 'item-price',
      ...options
    };

    const sections = [];
    
    // Item stats (weapons and wearables)
    const stats = [];
    
    // Weapon damage (no "when equipped" needed since weapons are used directly)
    if (itemData.damage && itemData.damage !== 0) {
      if (itemData.damageVariance && itemData.damageVariance !== 0) {
        const min = Math.floor(itemData.damage * (1 - itemData.damageVariance));
        const max = Math.floor(itemData.damage * (1 + itemData.damageVariance));
        stats.push(`${min}-${max} damage`);
      } else {
        stats.push(`${itemData.damage} damage`);
      }
    }
    
    // Wearable stats
    const wearableStats = [];
    if (itemData.damageBonus && itemData.damageBonus !== 0) {
      wearableStats.push(`+${itemData.damageBonus} damage dealt`);
    }
    if (itemData.damageBonusPercent && itemData.damageBonusPercent !== 0) {
      wearableStats.push(`+${itemData.damageBonusPercent}% damage dealt`);
    }
    if (itemData.damageReduction && itemData.damageReduction !== 0) {
      wearableStats.push(`-${itemData.damageReduction} damage taken`);
    }
    if (itemData.damageReductionPercent && itemData.damageReductionPercent !== 0) {
      wearableStats.push(`-${itemData.damageReductionPercent * 100}% damage taken`);
    }
    
    // Collect all stat lines first
    const allStatLines = [];
    
    // Add wearable stats
    if (wearableStats.length > 0) {
      allStatLines.push(...wearableStats);
    }
    
    // Add custom stat texts
    if (itemData.statTexts && itemData.statTexts.length > 0) {
      for (const statText of itemData.statTexts) {
        const parsedStatText = parseText(statText);
        allStatLines.push(parsedStatText);
      }
    }
    
    // Add header and stats together if we have stats
    if (allStatLines.length > 0) {
      if (itemData.statsHeader) {
        const headerText = parseText(itemData.statsHeader);
        stats.push(`<div class="stats-header">${headerText}</div>${allStatLines.join('<br>')}`);
      } else {
        stats.push(allStatLines.join('<br>'));
      }
    }
    
    if (stats.length > 0) {
      sections.push(`<div class="${config.statsClass}">${stats.join('<br>')}</div>`);
    }
    
    // Item description
    if (config.includeDescription && itemData.description) {
      const parsedDescription = parseText(itemData.description);
      sections.push(`<div class="${config.descriptionClass}">${parsedDescription}</div>`);
    }
    
    // Price information
    if (config.includePricing) {
      if (config.showBuyPrice && itemData.buyPrice !== undefined) {
        const price = itemData.buyPrice || 0;
        if (price > 0) {
          sections.push(`<div class="${config.priceClass}">${config.buyPriceLabel}${price.toLocaleString()} gold</div>`);
        } else {
          sections.push(`<div class="${config.priceClass}">${config.notBuyableLabel}</div>`);
        }
      }
      
      if (config.showSellPrice && itemData.sellPrice !== undefined) {
        const price = itemData.sellPrice || 0;
        if (price > 0) {
          sections.push(`<div class="${config.priceClass}">${config.sellPriceLabel}${price.toLocaleString()} gold</div>`);
        } else {
          sections.push(`<div class="${config.priceClass}">${config.notSellableLabel}</div>`);
        }
      }
    }
    
    return sections.join('');
  }

  function hasItemStats(itemData) {
    return itemData.description || 
           itemData.sellPrice !== undefined ||
           itemData.buyPrice !== undefined ||
           itemData.damageBonus !== undefined ||
           itemData.damageBonusPercent !== undefined ||
           itemData.damageReduction !== undefined ||
           itemData.damageReductionPercent !== undefined ||
           itemData.damage !== undefined ||
           itemData.damageVariance !== undefined ||
           (itemData.statTexts && itemData.statTexts.length > 0) ||
           itemData.statsHeader;
  }

  // Public API
  return {
    parseText: parseText,
    generateItemStats: generateItemStats,
    hasItemStats: hasItemStats
  };
})();
</script>

<style>
  /* Shared Item Stats Styles */
  .item-stats {
    margin-top: 6px;
    font-size: 11px;
    line-height: 1.4;
    color: #7dd87d;
    font-weight: 500;
  }

  .stats-header {
    color: #999999;
    font-weight: 500;
    margin-bottom: 3px;
    font-size: 11px;
  }

  .item-description {
    color: #cccccc;
    margin-top: 6px;
    font-size: 11px;
    line-height: 1.4;
  }

  .item-price {
    color: #ffd700;
    margin-top: 6px;
    font-weight: 500;
    font-size: 11px;
  }

  /* Crafting-specific stat styles */
  .crafting-item-stats {
    margin-top: 4px;
    font-size: 9px;
    line-height: 1.3;
    color: #7dd87d;
    font-weight: 500;
  }

  .crafting-item-stats .stats-header {
    color: #999999;
    font-weight: 500;
    margin-bottom: 2px;
    font-size: 9px;
  }

  .crafting-item-description {
    margin-top: 4px;
    font-size: 9px;
    line-height: 1.3;
    color: var(--crafting-text-muted, #cccccc);
  }

  /* Mobile styles */
  body.mobile .crafting-item-stats {
    font-size: 8px;
    margin-top: 3px;
  }

  body.mobile .crafting-item-stats .stats-header {
    font-size: 8px;
  }

  body.mobile .crafting-item-description {
    font-size: 8px;
    margin-top: 3px;
  }
</style> 

<!-- Included from: ./shared/item-tooltips.html -->
<!-- Shared Item Tooltip System -->
<script>
/**
 * Centralized Item Tooltip System
 * Provides consistent tooltip functionality across all UI components
 */
window.ItemTooltips = (function() {
  'use strict';

  // Parse color formatting in text: [HEXCODE]text[/] -> <span style="color: #HEXCODE">text</span>
  // Parse line breaks: [b] -> <br>
  function parseText(text) {
    if (!text) return text;
    
    // First, replace [b] with <br> for line breaks
    text = text.replace(/\[b\]/g, '<br>');
    
    // Then, handle color formatting [HEXCODE]text[/] pattern
    const colorPattern = /\[([A-Fa-f0-9]{6})\](.*?)\[\/\]/g;
    
    return text.replace(colorPattern, (match, hexCode, content) => {
      return `<span style="color: #${hexCode}">${content}</span>`;
    });
  }

  // Get rarity color based on item rarity (matches backpack.html rarity colors)
  function getRarityColor(rarity) {
    if (!rarity) return null;
    
    const rarityColors = {
      'common': '#9CA3AF',
      'uncommon': '#22C55E',
      'rare': '#3B82F6',
      'epic': '#A855F7',
      'legendary': '#F59E0B'
    };
    
    return rarityColors[rarity.toLowerCase()] || null;
  }

  function hasTooltipData(itemData) {
    // Use shared ItemStats system if available, otherwise use basic check
    if (window.ItemStats) {
      return itemData.name || window.ItemStats.hasItemStats(itemData);
    }
    
    // Fallback check if ItemStats not available
    return itemData.name || 
           itemData.description || 
           itemData.sellPrice !== undefined ||
           itemData.buyPrice !== undefined ||
           itemData.damageBonus !== undefined ||
           itemData.damageBonusPercent !== undefined ||
           itemData.damageReduction !== undefined ||
           itemData.damageReductionPercent !== undefined ||
           itemData.damage !== undefined ||
           itemData.damageVariance !== undefined ||
           (itemData.statTexts && itemData.statTexts.length > 0) ||
           itemData.statsHeader;
  }

  function createTooltip(slot, itemData, options = {}) {
    if (!hasTooltipData(itemData)) return;

    // Default options
    const config = {
      tooltipClass: 'item-tooltip',
      contentClass: 'item-tooltip-content',
      showBuyPrice: false,
      showSellPrice: true,
      buyPriceLabel: 'Price: ',
      sellPriceLabel: 'Sells For: ',
      notBuyableLabel: 'Not Buyable',
      notSellableLabel: 'Not Sellable',
      ...options
    };

    const tooltip = document.createElement('div');
    tooltip.className = config.tooltipClass;
    
    const content = document.createElement('div');
    content.className = config.contentClass;
    
    const sections = [];
    
    // Item name with rarity coloring
    if (itemData.name) {
      const rarityColor = getRarityColor(itemData.rarity);
      const nameStyle = rarityColor ? ` style="color: ${rarityColor}"` : '';
      sections.push(`<div class="tooltip-name"${nameStyle}>${itemData.name}</div>`);
    }
    
    // Use shared ItemStats system for consistent stat generation
    if (window.ItemStats) {
      const itemStatsHTML = window.ItemStats.generateItemStats(itemData, {
        includeDescription: true,
        includePricing: false,
        statsClass: 'tooltip-stats',
        descriptionClass: 'tooltip-description',
        priceClass: 'tooltip-value'
      });
      
      if (itemStatsHTML) {
        sections.push(itemStatsHTML);
      }
    } else {
      // Fallback: Item description only if ItemStats not available
      if (itemData.description) {
        const parsedDescription = parseText(itemData.description);
        sections.push(`<div class="tooltip-description">${parsedDescription}</div>`);
      }
    }
    
    // Price information
    if (config.showBuyPrice && itemData.buyPrice !== undefined) {
      const price = itemData.buyPrice || 0;
      if (price > 0) {
        sections.push(`<div class="tooltip-value">${config.buyPriceLabel}${price.toLocaleString()} gold</div>`);
      } else {
        sections.push(`<div class="tooltip-value">${config.notBuyableLabel}</div>`);
      }
    }
    
    if (config.showSellPrice && itemData.sellPrice !== undefined) {
      const price = itemData.sellPrice || 0;
      if (price > 0) {
        sections.push(`<div class="tooltip-value">${config.sellPriceLabel}${price.toLocaleString()} gold</div>`);
      } else {
        sections.push(`<div class="tooltip-value">${config.notSellableLabel}</div>`);
      }
    }
    
    content.innerHTML = sections.join('');
    tooltip.appendChild(content);
    slot.appendChild(tooltip);
  }

  function removeTooltip(slot, tooltipClass = 'item-tooltip') {
    const existingTooltip = slot.querySelector(`.${tooltipClass}`);
    if (existingTooltip) existingTooltip.remove();
  }

  // Mobile tooltip handling
  let mobileTooltipActive = false;
  
  function initializeMobileTooltips() {
    // Check if we're on mobile
    const isMobile = document.body.classList.contains('mobile');
    if (!isMobile) return;
    
    // Add click handler to document for event delegation
    document.addEventListener('click', handleMobileTooltipClick, true);
  }
  
  function handleMobileTooltipClick(e) {
    // List of tooltip container selectors - include quest reward enabled class
    const tooltipContainers = [
      '.backpack-slot', '.backpack-hotbar-slot', '.backpack-wearable-slot',
      '.hud-hotbar-slot', '.merchant-slot', '.merchant-hotbar-slot', 
      '.crafting-slot', '.crafting-requirement-item', 
      '.quests-reward-item', '.quests-reward-item-tooltip-enabled'
    ];
    
    // Check if click is on a tooltip container
    const container = e.target.closest(tooltipContainers.join(', '));
    
    if (container) {
      // Find tooltip in this container
      const tooltip = container.querySelector([
        '.item-tooltip', '.backpack-item-tooltip', '.merchant-item-tooltip',
        '.crafting-item-tooltip', '.crafting-requirement-tooltip', '.quests-reward-item-tooltip'
      ].join(', '));
      
      if (tooltip) {
        // Close any other open tooltips
        closeAllMobileTooltips();
        
        // Show this tooltip
        tooltip.classList.add('mobile-tooltip-visible');
        mobileTooltipActive = true;
      }
    } else {
      // Click outside any container - close all tooltips
      closeAllMobileTooltips();
    }
  }
  
  function closeAllMobileTooltips() {
    const visibleTooltips = document.querySelectorAll('.mobile-tooltip-visible');
    if (visibleTooltips.length > 0) {
      visibleTooltips.forEach(tooltip => {
        tooltip.classList.remove('mobile-tooltip-visible');
      });
      mobileTooltipActive = false;
    }
  }
  
  // Initialize mobile tooltips when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeMobileTooltips);
  } else {
    initializeMobileTooltips();
  }

  // Public API
  return {
    parseText: parseText,
    hasTooltipData: hasTooltipData,
    createTooltip: createTooltip,
    removeTooltip: removeTooltip,
    closeAllMobileTooltips: closeAllMobileTooltips
  };
})();
</script>

<style>
  /* Shared Item Tooltip Styles */
  .item-tooltip {
    position: absolute;
    bottom: 100%;
    left: 50%;
    margin-bottom: 8px;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    z-index: 2000;
    pointer-events: none;
  }

  /* Tooltip visibility on hover - Generic classes */
  .backpack-slot:hover .item-tooltip,
  .backpack-hotbar-slot:hover .item-tooltip,
  .backpack-wearable-slot:hover .item-tooltip,
  .hud-hotbar-slot:hover .item-tooltip,
      .merchant-slot:hover .item-tooltip,
    .merchant-hotbar-slot:hover .item-tooltip,
    .crafting-slot:hover .item-tooltip,
    .crafting-requirement-item:hover .item-tooltip,

    .backpack-slot:hover .backpack-item-tooltip,
    .backpack-hotbar-slot:hover .backpack-item-tooltip,
    .backpack-wearable-slot:hover .backpack-item-tooltip,
    .merchant-slot:hover .merchant-item-tooltip,
    .merchant-hotbar-slot:hover .merchant-item-tooltip,
    .crafting-slot:hover .crafting-item-tooltip,
    .crafting-requirement-item:hover .crafting-requirement-tooltip,
    .quests-reward-item:hover .quests-reward-item-tooltip {
    opacity: 1;
    visibility: visible;
    transform: translateY(-8px);
  }

      .item-tooltip-content,
    .backpack-item-tooltip-content,
    .merchant-item-tooltip-content,
    .crafting-item-tooltip-content,
    .crafting-requirement-tooltip-content,
    .quests-reward-item-tooltip-content {
    background: linear-gradient(145deg, #2a2a2a, #1e1e1e);
    border: 2px solid #444;
    border-radius: 8px;
    padding: 10px 14px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.8), inset 0 1px 0 rgba(255, 255, 255, 0.1);
    font-size: 12px;
    font-weight: 500;
    color: #cccccc;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.9);
    white-space: normal;
    min-width: 150px;
    max-width: 300px;
    line-height: 1.4;
    position: relative;
    text-align: left;
    transform: translateX(-50%);
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  }

  /* Tooltip Caret */
      .item-tooltip-content::after,
    .backpack-item-tooltip-content::after,
    .merchant-item-tooltip-content::after,
    .crafting-item-tooltip-content::after,
    .crafting-requirement-tooltip-content::after,
    .quests-reward-item-tooltip-content::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 8px solid transparent;
    border-top-color: #444;
  }

      .item-tooltip-content::before,
    .backpack-item-tooltip-content::before,
    .merchant-item-tooltip-content::before,
    .crafting-item-tooltip-content::before,
    .crafting-requirement-tooltip-content::before,
    .quests-reward-item-tooltip-content::before {
    content: '';
    position: absolute;
    top: calc(100% - 2px);
    left: 50%;
    transform: translateX(-50%);
    border: 6px solid transparent;
    border-top-color: #2a2a2a;
          z-index: 1;
    }

    /* Tooltip Content Sections */
    .tooltip-name,
    .backpack-tooltip-name,
    .merchant-tooltip-name {
      font-weight: 600;
      color: #ffffff;
      font-size: 12px;
    }

  /* Tooltip Content Sections */
  .tooltip-name,
  .backpack-tooltip-name,
  .merchant-tooltip-name {
    font-weight: 600;
    color: #ffffff;
    font-size: 12px;
  }

  .tooltip-stats,
  .backpack-tooltip-stats {
    margin-top: 6px;
    font-size: 11px;
    line-height: 1.4;
    color: #7dd87d;
    font-weight: 500;
  }

  .tooltip-stats-header,
  .backpack-tooltip-stats-header {
    color: #999999;
    font-weight: 500;
    margin-bottom: 3px;
    font-size: 11px;
  }

  .tooltip-description,
  .backpack-tooltip-description,
  .merchant-tooltip-description {
    color: #cccccc;
    margin-top: 6px;
    font-size: 11px;
    line-height: 1.4;
  }

  .tooltip-value,
  .backpack-tooltip-value,
  .merchant-tooltip-value {
    color: #ffd700;
    margin-top: 6px;
    font-weight: 500;
    font-size: 11px;
  }

  /* Mobile - Control tooltip visibility on mobile devices */
  body.mobile .item-tooltip,
  body.mobile .backpack-item-tooltip,
  body.mobile .merchant-item-tooltip,
  body.mobile .crafting-item-tooltip,
  body.mobile .crafting-requirement-tooltip,
  body.mobile .quests-reward-item-tooltip {
    opacity: 0;
    visibility: hidden;
    transform: translateY(-4px);
    transition: all 0.2s ease;
  }

  /* Mobile tooltip visibility when tapped */
  body.mobile .mobile-tooltip-visible {
    opacity: 1 !important;
    visibility: visible !important;
    transform: translateY(-8px) !important;
  }

  /* Improve mobile tooltip positioning and touch targets */
  body.mobile .backpack-slot,
  body.mobile .backpack-hotbar-slot,
  body.mobile .backpack-wearable-slot,
  body.mobile .hud-hotbar-slot,
  body.mobile .merchant-slot,
  body.mobile .merchant-hotbar-slot,
  body.mobile .crafting-slot,
  body.mobile .crafting-requirement-item,
  body.mobile .quests-reward-item,
  body.mobile .quests-reward-item-tooltip-enabled {
    cursor: pointer;
    -webkit-tap-highlight-color: rgba(255, 255, 255, 0.1);
  }

  /* Center carets on mobile tooltips */
  body.mobile .item-tooltip-content::after,
  body.mobile .backpack-item-tooltip-content::after,
  body.mobile .merchant-item-tooltip-content::after,
  body.mobile .crafting-item-tooltip-content::after,
  body.mobile .crafting-requirement-tooltip-content::after,
  body.mobile .quests-reward-item-tooltip-content::after {
    left: 50% !important;
    transform: translateX(-50%) !important;
  }

  body.mobile .item-tooltip-content::before,
  body.mobile .backpack-item-tooltip-content::before,
  body.mobile .merchant-item-tooltip-content::before,
  body.mobile .crafting-item-tooltip-content::before,
  body.mobile .crafting-requirement-tooltip-content::before,
  body.mobile .quests-reward-item-tooltip-content::before {
    left: 50% !important;
    transform: translateX(-50%) !important;
  }

  /* Mobile tooltip content sizing */
  body.mobile .item-tooltip-content,
  body.mobile .backpack-item-tooltip-content,
  body.mobile .merchant-item-tooltip-content,
  body.mobile .crafting-item-tooltip-content,
  body.mobile .crafting-requirement-tooltip-content,
  body.mobile .quests-reward-item-tooltip-content {
    max-width: 220px;
    font-size: 11px;
    padding: 8px 10px;
  }

  /* Mouse Follower Tooltip (for backpack drag system) */
  .backpack-mouse-follower .item-tooltip {
    z-index: 2001;
  }
</style> 

<!-- Included from: ./menus/backpack.html -->
<!-- Backpack UI -->
<div class="backpack-overlay">
  <div class="backpack-container">
    <div class="backpack-header">
      <h2 class="backpack-title">Backpack</h2>
      <button class="backpack-close">×</button>
    </div>
    
    <div class="backpack-content">
      <!-- Character Wearables Panel -->
      <div class="backpack-wearables-panel">
        <div class="backpack-wearables-slots">
          <!-- Top row: Helmet -->
          <div class="backpack-wearable-slot-spacer"></div>
          <div class="backpack-wearable-slot" data-slot="helmet">
            <div class="backpack-wearable-slot-label">Helmet</div>
          </div>
          <div class="backpack-wearable-slot-spacer"></div>
          
          <!-- Middle row: Gloves, Armor, Accessory -->
          <div class="backpack-wearable-slot" data-slot="gloves">
            <div class="backpack-wearable-slot-label">Gloves</div>
          </div>
          <div class="backpack-wearable-slot" data-slot="armor">
            <div class="backpack-wearable-slot-label">Armor</div>
          </div>
          <div class="backpack-wearable-slot" data-slot="accessory">
            <div class="backpack-wearable-slot-label">Accessory</div>
          </div>
          
          <!-- Bottom row: Leggings -->
          <div class="backpack-wearable-slot-spacer"></div>
          <div class="backpack-wearable-slot" data-slot="leggings">
            <div class="backpack-wearable-slot-label">Leggings</div>
          </div>
          <div class="backpack-wearable-slot-spacer"></div>
          
          <!-- Bottom row: Boots -->
          <div class="backpack-wearable-slot-spacer"></div>
          <div class="backpack-wearable-slot" data-slot="boots">
            <div class="backpack-wearable-slot-label">Boots</div>
          </div>
          <div class="backpack-wearable-slot-spacer"></div>
        </div>
      </div>
      
      <!-- Main Backpack Grid -->
      <div class="backpack-grid-container">
        <div class="backpack-grid" id="backpack-grid">
          <!-- Grid slots will be generated by JavaScript -->
        </div>
      </div>
    </div>
  </div>
  
  <!-- Hotbar Container -->
  <div class="backpack-hotbar-container">
    <div class="backpack-hotbar-header">
      <h3 class="backpack-hotbar-title">Hotbar</h3>
    </div>
    <div class="backpack-hotbar-grid" id="backpack-hotbar-grid">
      <!-- Hotbar slots will be generated by JavaScript -->
    </div>
  </div>
</div>
<script>
  // Configuration
  const BACKPACK_CONFIG = {
    slots: 18,
    rowWidth: 6,
    hotbarSlots: 8
  };

  // Wearable slot to position mapping (matches Wearables.ts)
  const WEARABLE_SLOT_POSITIONS = {
    helmet: 0,
    armor: 1,
    gloves: 2,
    leggings: 3,
    boots: 4,
    accessory: 5
  };

  const mouseFollower = createMouseFollower();
  let heldItem = null;

  // Setup hytopia data handlers
  hytopia.onData(data => {
    if (data.type === 'toggleBackpack') {
      toggleBackpack();
    }
    
    if (data.type === 'hotbarUpdate') {
      updateHotbarSlot(data.position, data);
    }
    
    if (data.type === 'backpackUpdate') {
      updateBackpackSlot(data.position, data);
    }
    
    if (data.type === 'wearablesUpdate') {
      updateWearablesSlot(data.position, data);
    }
  });

  // Initialize backpack system
  function initializeBackpack() {
    createBackpackSlots();
    createHotbarSlots();
    setupEventListeners();
  }

  function createBackpackSlots() {
    const grid = document.getElementById('backpack-grid');
    grid.innerHTML = '';
    
    for (let i = 0; i < BACKPACK_CONFIG.slots; i++) {
      const slot = document.createElement('div');
      slot.className = 'backpack-slot';
      slot.dataset.slotIndex = i;
      slot.innerHTML = '<div class="backpack-slot-content"></div>';
      grid.appendChild(slot);
    }
  }

  function createHotbarSlots() {
    const grid = document.getElementById('backpack-hotbar-grid');
    grid.innerHTML = '';
    
    for (let i = 0; i < BACKPACK_CONFIG.hotbarSlots; i++) {
      const slot = document.createElement('div');
      slot.className = 'backpack-hotbar-slot';
      slot.dataset.hotbarIndex = i;
      slot.innerHTML = `<div class="backpack-hotbar-slot-content">${i + 1}</div>`;
      grid.appendChild(slot);
    }
  }

  // Helper function to get slot info
  function getSlotInfo(slot) {
      if (slot.dataset.slotIndex) {
        return { type: 'backpack', index: slot.dataset.slotIndex };
      } else if (slot.dataset.slot) {
        return { type: 'wearables', index: WEARABLE_SLOT_POSITIONS[slot.dataset.slot] };
      } else if (slot.dataset.hotbarIndex) {
        return { type: 'hotbar', index: slot.dataset.hotbarIndex };
      }
      return { type: 'unknown', index: null };
    }

    // Helper function to check if slot has content
    function hasContent(slot) {
      // For wearable slots, check if there's an item icon
      if (slot.classList.contains('backpack-wearable-slot')) {
        return slot.querySelector('.backpack-item-icon') !== null;
      }
      // For backpack and hotbar slots, check content containers
      const content = slot.querySelector('.backpack-slot-content, .backpack-hotbar-slot-content');
      return content && content.children.length > 0;
    }

    // Helper function to get slot content
    function getSlotContent(slot) {
      // For wearable slots, the slot itself is the content container
      if (slot.classList.contains('backpack-wearable-slot')) {
        return slot;
      }
      // For backpack and hotbar slots, get the content container
      return slot.querySelector('.backpack-slot-content, .backpack-hotbar-slot-content');
    }

    // Create and setup mouse follower
    function createMouseFollower() {
      const follower = document.createElement('div');
      follower.className = 'backpack-mouse-follower';
      document.body.appendChild(follower);
      
      document.addEventListener('mousemove', e => {
        if (heldItem) {
          follower.style.left = e.clientX + 'px';
          follower.style.top = e.clientY + 'px';
        }
      });
      
      return follower;
    }

    // Handle item pickup
    function pickupItem(slot, slotInfo, mouseX, mouseY) {
      if (!hasContent(slot)) return false;
      
      const content = getSlotContent(slot);
      const tooltip = slot.querySelector('.backpack-item-tooltip');
      
      // For wearable slots, we need to capture just the item content, not the whole slot
      let contentHTML;
      if (slot.classList.contains('backpack-wearable-slot')) {
        const icon = slot.querySelector('.backpack-item-icon');
        contentHTML = icon ? icon.outerHTML : '';
      } else {
        contentHTML = content.innerHTML;
      }
      
      heldItem = {
        sourceSlot: slot,
        sourceType: slotInfo.type,
        sourceIndex: slotInfo.index,
        content: contentHTML
      };
      
      // Copy content to mouse follower
      mouseFollower.innerHTML = contentHTML;
      
      // Copy tooltip if it exists and store reference for later restoration
      if (tooltip) {
        // Store tooltip data for restoration
        heldItem.tooltipData = {
          element: tooltip.cloneNode(true),
          parentSlot: slot
        };
        
        const tooltipClone = tooltip.cloneNode(true);
        tooltipClone.style.opacity = '1';
        tooltipClone.style.visibility = 'visible';
        tooltipClone.style.transform = 'translateY(-110%)';
        tooltipClone.style.position = 'absolute';
        tooltipClone.style.bottom = 'auto';
        tooltipClone.style.top = '-8px';
        
        // Remove mobile tooltip classes that might interfere
        tooltipClone.classList.remove('mobile-tooltip-visible');
        
        mouseFollower.appendChild(tooltipClone);
        
        // Completely remove original tooltip to prevent ghosting
        tooltip.remove();
      }
    
      // Position mouse follower at center of slot
      const slotRect = slot.getBoundingClientRect();
      const centerX = slotRect.left + slotRect.width / 2;
      const centerY = slotRect.top + slotRect.height / 2;
      
      mouseFollower.style.left = centerX + 15 + 'px';
      mouseFollower.style.top = centerY - 15 + 'px';
      mouseFollower.classList.add('active');
      slot.classList.add('backpack-slot-empty');
      
      return true;
    }

    // Handle item placement
    function placeItem(slotInfo) {
      hytopia.sendData({
        type: 'moveItem',
        fromType: heldItem.sourceType,
        fromIndex: heldItem.sourceIndex,
        toType: slotInfo.type,
        toIndex: slotInfo.index
      });
      resetHeldItem();
    }

    // Reset held item state
    function resetHeldItem() {
      if (!heldItem) return;

      heldItem.sourceSlot.classList.remove('backpack-slot-empty');
      
      // Restore original tooltip by recreating it
      if (heldItem.tooltipData) {
        const restoredTooltip = heldItem.tooltipData.element.cloneNode(true);
        heldItem.tooltipData.parentSlot.appendChild(restoredTooltip);
      }
      
      mouseFollower.classList.remove('active');
      mouseFollower.innerHTML = '';
      heldItem = null;
    }

    // Cancel held item
    function cancelHeldItem() {
      if (!heldItem) return;
      
      resetHeldItem();
    }

  function setupEventListeners() {
    const closeButton = document.querySelector('.backpack-close');
    closeButton.addEventListener('click', closeBackpack);

    // Setup slot click handlers
    document.querySelectorAll('.backpack-slot, .backpack-wearable-slot, .backpack-hotbar-slot')
      .forEach(slot => {
        slot.addEventListener('click', e => {
          e.preventDefault();
          e.stopPropagation();
          
          const slotInfo = getSlotInfo(slot);
          
          if (!heldItem) {
            pickupItem(slot, slotInfo, e.clientX, e.clientY);
          } else {
            placeItem(slotInfo);
          }
        });
      });

    // Setup cancel handlers
    document.addEventListener('contextmenu', e => {
      if (heldItem) {
        e.preventDefault();
        cancelHeldItem();
      }
    });

    document.addEventListener('keydown', e => {
      if (e.key === 'Escape' && heldItem) {
        cancelHeldItem();
      }
    });

    // Setup click outside containers handler for item dropping
    document.addEventListener('click', e => {
      // Only handle if we have a held item
      if (!heldItem) return;
      
      // Check if click is outside both containers using closest()
      const isInsideContainers = e.target.closest('.backpack-container, .backpack-hotbar-container');
      
      // If click is outside both containers, log for drop logic
      if (!isInsideContainers) {
        hytopia.sendData({
          type: 'dropItem',
          fromType: heldItem.sourceType,
          fromIndex: heldItem.sourceIndex,
        });
        cancelHeldItem();
      }
    });
  }

  function closeBackpack() {
    document.querySelector('.backpack-overlay').style.display = 'none';
    hytopia.lockPointer(true);
    
    // Close any open mobile tooltips
    if (window.ItemTooltips) {
      window.ItemTooltips.closeAllMobileTooltips();
    }

    // Cancel any picked up item
    if (heldItem) {
      cancelHeldItem();
    }
  }

  function openBackpack() {
    document.querySelector('.backpack-overlay').style.display = 'flex';
    hytopia.lockPointer(false, true); // true decouples input from pointer lock, in this case allowing key inputs still while pointer is unlocked.
  }

  function toggleBackpack() {
    const overlay = document.querySelector('.backpack-overlay');
    if (overlay.style.display === 'flex') {
      closeBackpack();
    } else {
      openBackpack();
    }
  }

  // Initialize
  initializeBackpack();

  // Slot update configurations
  const SLOT_CONFIGS = {
    hotbar: {
      selector: '.backpack-hotbar-slot',
      contentSelector: '.backpack-hotbar-slot-content',
      iconClass: 'backpack-hotbar-slot-icon',
      quantityClass: 'backpack-hotbar-slot-quantity',
      maxSlots: BACKPACK_CONFIG.hotbarSlots,
      showEmptyNumber: true
    },
    backpack: {
      selector: '.backpack-slot',
      contentSelector: '.backpack-slot-content',
      iconClass: 'backpack-item-icon',
      quantityClass: 'backpack-slot-quantity',
      maxSlots: BACKPACK_CONFIG.slots,
      showEmptyNumber: false
    },
    wearables: {
      selector: '.backpack-wearable-slot',
      contentSelector: '.backpack-wearable-slot',
      iconClass: 'backpack-item-icon',
      quantityClass: 'backpack-slot-quantity',
      maxSlots: 6,
      showEmptyNumber: false
    }
  };

  // Generic slot update function
  function updateSlot(slotType, position, itemData) {
    const config = SLOT_CONFIGS[slotType];
    if (!config || position < 0 || position >= config.maxSlots) return;

    const slots = document.querySelectorAll(config.selector);
    const slot = slots[position];
    if (!slot) return;
    
    const content = slot.querySelector(config.contentSelector);
    if (!content) return;
    
    // Clear existing content and tooltip
    content.innerHTML = '';
    removeTooltip(slot);
    
    if (itemData.removed) {
      // Show slot number for empty slots (hotbar only)
      if (config.showEmptyNumber) {
        content.textContent = position + 1;
      }
    } else {
      createItemContent(content, itemData, config);
      createTooltip(slot, itemData);
    }
  }

  function createItemContent(content, itemData, config) {
    // Create item icon
    const icon = document.createElement('img');
    icon.src = `{{CDN_ASSETS_URL}}/${itemData.iconImageUri}`;
    icon.alt = 'Item';
    icon.className = config.iconClass;
    content.appendChild(icon);
    
    // Add quantity if greater than 1
    if (itemData.quantity && itemData.quantity > 1) {
      const quantity = document.createElement('div');
      quantity.className = config.quantityClass;
      quantity.textContent = itemData.quantity.toLocaleString();
      content.appendChild(quantity);
    }
  }

  // Use shared tooltip system
  function createTooltip(slot, itemData) {
    ItemTooltips.createTooltip(slot, itemData, {
      tooltipClass: 'backpack-item-tooltip',
      contentClass: 'backpack-item-tooltip-content'
    });
  }

  function removeTooltip(slot) {
    ItemTooltips.removeTooltip(slot, 'backpack-item-tooltip');
  }

  // Custom wearables slot update function
  function updateWearablesSlot(position, itemData) {
    // Find slot by position
    const slotName = Object.keys(WEARABLE_SLOT_POSITIONS).find(name => WEARABLE_SLOT_POSITIONS[name] === position);
    if (!slotName) return;
    
    const slot = document.querySelector(`[data-slot="${slotName}"]`);
    if (!slot) return;
    
    // Clear existing content
    removeTooltip(slot);
    const existingIcon = slot.querySelector('.backpack-item-icon');
    const existingLabel = slot.querySelector('.backpack-wearable-slot-label');
    if (existingIcon) existingIcon.remove();
    if (existingLabel) existingLabel.remove();
    
    if (itemData.removed) {
      // Show label for empty slot
      const label = slotName.charAt(0).toUpperCase() + slotName.slice(1);
      const labelElement = document.createElement('div');
      labelElement.className = 'backpack-wearable-slot-label';
      labelElement.textContent = label;
      slot.appendChild(labelElement);
    } else {
      // Show item (label is hidden when item is present)
      const icon = document.createElement('img');
      icon.src = `{{CDN_ASSETS_URL}}/${itemData.iconImageUri}`;
      icon.alt = itemData.name;
      icon.className = 'backpack-item-icon';
      slot.appendChild(icon);
      createTooltip(slot, itemData);
    }
  }

  // Specific update functions
  function updateHotbarSlot(position, itemData) {
    updateSlot('hotbar', position, itemData);
  }

  function updateBackpackSlot(position, itemData) {
    updateSlot('backpack', position, itemData);
  }

  // Setup global functions
  window.lumberjackSimulator.openBackpack = openBackpack;
</script>
<style>
  :root {
    --backpack-slot-size: 56px;
    --backpack-hotbar-size: 64px;
    --backpack-icon-size: 32px;
    --backpack-gap: 6px;
    --backpack-padding: 12px;
    --backpack-font: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  }

  .backpack-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    font-family: var(--backpack-font);
    user-select: none;
    gap: 16px;
  }

  /* Container Styles */
  .backpack-container,
  .backpack-hotbar-container {
    background: linear-gradient(145deg, #2a2a2a, #1e1e1e);
    border: 2px solid #444;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.9), inset 0 1px 0 rgba(255, 255, 255, 0.1);
    width: 680px;
  }

  /* Header Styles */
  .backpack-header,
  .backpack-hotbar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    background: linear-gradient(135deg, #3a3a3a, #2d2d2d);
    border-bottom: 1px solid #444;
  }

  .backpack-hotbar-header {
    justify-content: flex-start;
  }

  .backpack-title,
  .backpack-hotbar-title {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
    color: #ffffff;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.9);
    letter-spacing: 0.3px;
  }

  .backpack-close {
    background: rgba(255, 0, 0, 0.2);
    border: 1px solid rgba(255, 0, 0, 0.3);
    border-radius: 6px;
    color: #ff6b6b;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .backpack-close:hover {
    background: rgba(255, 0, 0, 0.3);
    transform: scale(1.05);
  }

  /* Layout Styles */
  .backpack-content {
    display: flex;
    padding: 20px;
    gap: 20px;
  }

  .backpack-wearables-panel {
    display: flex;
    flex-direction: column;
    gap: 20px;
    min-width: 220px;
  }

  /* Grid Styles */
  .backpack-wearables-slots {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    grid-template-rows: repeat(4, 1fr);
    gap: var(--backpack-gap);
    padding: var(--backpack-padding);
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid #444;
    border-radius: 8px;
    box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.5);
  }

  .backpack-grid {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    grid-template-rows: repeat(3, 1fr);
    gap: var(--backpack-gap);
    background: rgba(0, 0, 0, 0.3);
    padding: var(--backpack-padding);
    border: 1px solid #444;
    border-radius: 8px;
    box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.5);
  }

  .backpack-hotbar-grid {
    display: grid;
    grid-template-columns: repeat(8, 1fr);
    gap: 8px;
    background: rgba(0, 0, 0, 0.3);
    padding: 16px;
    border-radius: 0 0 8px 8px;
    box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.5);
  }

  /* Slot Styles */
  .backpack-wearable-slot,
  .backpack-slot {
    width: var(--backpack-slot-size);
    height: var(--backpack-slot-size);
    background: rgba(0, 0, 0, 0.6);
    border: 2px solid #444;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.5);
  }

  .backpack-slot {
    border-color: #333;
    border-radius: 6px;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.7);
  }

  .backpack-hotbar-slot {
    width: var(--backpack-hotbar-size);
    height: var(--backpack-hotbar-size);
    background: rgba(0, 0, 0, 0.6);
    border: 2px solid #333;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    position: relative;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.7);
  }

  /* Slot Hover & Highlight States */
  .backpack-wearable-slot:hover,
  .backpack-slot:hover,
  .backpack-hotbar-slot:hover {
    border-color: #666;
    background: rgba(0, 0, 0, 0.8);
    transform: translateY(-1px);
  }

  .backpack-wearable-slot:hover {
    border-color: #666;
  }

  .backpack-slot:hover,
  .backpack-hotbar-slot:hover {
    border-color: #555;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.7), 0 2px 8px rgba(0, 0, 0, 0.5);
  }

  .backpack-slot-highlight {
    border-color: #4CAF50 !important;
    background: rgba(76, 175, 80, 0.1) !important;
  }

  .backpack-slot-empty {
    border-color: #999 !important;
    background: linear-gradient(145deg, 
      rgba(255, 255, 255, 0.02), 
      rgba(255, 255, 255, 0.08)
    ) !important;
    box-shadow: 
      inset 0 2px 8px rgba(0, 0, 0, 0.8),
      0 0 0 1px rgba(255, 255, 255, 0.1) !important;
    opacity: 0.6;
    transition: all 0.2s ease;
  }

  /* Content Styles */
  .backpack-slot-icon {
    width: var(--backpack-icon-size);
    height: var(--backpack-icon-size);
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    opacity: 0.3;
    transition: opacity 0.2s ease;
  }

  .backpack-slot-content,
  .backpack-hotbar-slot-content {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    color: #ccc;
  }

  .backpack-hotbar-slot-content {
    font-size: 14px;
    font-weight: 600;
    color: #888;
  }

  .backpack-item-icon {
    width: 48px;
    height: 48px;
    object-fit: contain;
    image-rendering: pixelated;
    filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.8));
  }

  .backpack-hotbar-slot-icon {
    width: 56px;
    height: 56px;
    object-fit: contain;
    image-rendering: pixelated;
    filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.8));
  }

  .backpack-slot-quantity {
    position: absolute;
    bottom: 2px;
    right: 2px;
    background: rgba(0, 0, 0, 0.8);
    color: #ffffff;
    font-size: 9px;
    font-weight: 700;
    padding: 1px 3px;
    border-radius: 3px;
    line-height: 1;
    text-shadow: 0 1px 1px rgba(0, 0, 0, 0.9);
    border: 1px solid rgba(255, 255, 255, 0.2);
    min-width: 10px;
    text-align: center;
  }

  .backpack-hotbar-slot-quantity {
    position: absolute;
    bottom: 2px;
    right: 2px;
    background: rgba(0, 0, 0, 0.8);
    color: #ffffff;
    font-size: 10px;
    font-weight: 700;
    padding: 1px 4px;
    border-radius: 3px;
    line-height: 1;
    text-shadow: 0 1px 1px rgba(0, 0, 0, 0.9);
    border: 1px solid rgba(255, 255, 255, 0.2);
    min-width: 12px;
    text-align: center;
  }

  /* Wearable Slot Labels */
  .backpack-wearable-slot-label {
    font-size: 8px;
    font-weight: 600;
    color: #888;
    text-align: center;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.9);
    transition: color 0.2s ease;
    pointer-events: none;
  }

  .backpack-wearable-slot:hover .backpack-wearable-slot-label {
    color: #cccccc;
  }

  /* Item Rarity Colors */
  .backpack-slot.backpack-common,
  .backpack-hotbar-slot.backpack-common { border-color: #9CA3AF; }
  .backpack-slot.backpack-uncommon,
  .backpack-hotbar-slot.backpack-uncommon { border-color: #22C55E; }
  .backpack-slot.backpack-rare,
  .backpack-hotbar-slot.backpack-rare { border-color: #3B82F6; }
  .backpack-slot.backpack-epic,
  .backpack-hotbar-slot.backpack-epic { border-color: #A855F7; }
  .backpack-slot.backpack-legendary,
  .backpack-hotbar-slot.backpack-legendary { border-color: #F59E0B; }

  /* Mobile Styles */
  body.mobile {
    --backpack-slot-size: 44px;
    --backpack-hotbar-size: 44px;
    --backpack-icon-size: 32px;
    --backpack-gap: 4px;
    --backpack-padding: 8px;
  }

  body.mobile .backpack-overlay {
    gap: 12px;
    padding: 8px;
  }

  body.mobile .backpack-container,
  body.mobile .backpack-hotbar-container {
    width: auto;
    max-width: 520px;
    min-width: 340px;
    border-radius: 8px;
  }

  body.mobile .backpack-header,
  body.mobile .backpack-hotbar-header {
    padding: 8px 12px;
    border-radius: 8px 8px 0 0;
  }

  body.mobile .backpack-title,
  body.mobile .backpack-hotbar-title {
    font-size: 14px;
  }

  body.mobile .backpack-close {
    width: 24px;
    height: 24px;
    font-size: 16px;
    border-radius: 6px;
  }

  body.mobile .backpack-content {
    padding: 12px;
    gap: 12px;
  }

  body.mobile .backpack-wearables-panel {
    flex-direction: column;
    min-width: auto;
    gap: 12px;
  }

  body.mobile .backpack-wearables-slots {
    justify-items: center;
    padding: 8px;
    border-radius: 6px;
  }

  body.mobile .backpack-grid {
    padding: 8px;
    border-radius: 6px;
  }

  body.mobile .backpack-hotbar-grid {
    justify-items: center;
    width: fit-content;
    margin: 0 auto;
    padding: 12px;
    border-radius: 0 0 6px 6px;
  }

  body.mobile .backpack-wearable-slot,
  body.mobile .backpack-slot,
  body.mobile .backpack-hotbar-slot {
    box-sizing: border-box;
    border-radius: 6px;
    border-width: 2px;
  }

  body.mobile .backpack-slot-content,
  body.mobile .backpack-hotbar-slot-content {
    font-size: 10px;
  }

  body.mobile .backpack-item-icon {
    width: 36px;
    height: 36px;
  }

  body.mobile .backpack-hotbar-slot-icon {
    width: 36px;
    height: 36px;
  }

  body.mobile .backpack-slot-quantity {
    font-size: 8px;
    padding: 1px 3px;
    bottom: 2px;
    right: 2px;
    min-width: 10px;
    border-radius: 3px;
  }

  body.mobile .backpack-hotbar-slot-quantity {
    font-size: 8px;
    padding: 1px 3px;
    bottom: 2px;
    right: 2px;
    min-width: 12px;
    border-radius: 3px;
  }



  body.mobile .backpack-wearable-slot-label {
    font-size: 7px;
    font-weight: 500;
  }

  body.mobile .backpack-mouse-follower {
    width: 44px;
    height: 44px;
    border-radius: 6px;
  }

  body.mobile .backpack-mouse-follower img {
    width: 36px;
    height: 36px;
  }

  body.mobile .backpack-mouse-follower .backpack-hotbar-slot-quantity {
    font-size: 8px;
    padding: 1px 3px;
    bottom: 2px;
    right: 2px;
    min-width: 10px;
    border-radius: 3px;
  }

  .backpack-mouse-follower {
    position: fixed;
    width: 56px;
    height: 56px;
    pointer-events: none;
    z-index: 10000;
    display: none;
    align-items: center;
    justify-content: center;
    background: linear-gradient(145deg, #2a2a2a, #1a1a1a);
    border: 2px solid #555;
    border-radius: 8px;
    box-shadow: 
      0 8px 32px rgba(0, 0, 0, 0.9),
      0 4px 16px rgba(0, 0, 0, 0.7),
      inset 0 1px 0 rgba(255, 255, 255, 0.1);
    transform: translate(-50%, -50%) scale(0.95);
    transition: transform 0.15s ease, opacity 0.15s ease;
    opacity: 0;
    font-family: var(--backpack-font);
  }

  .backpack-mouse-follower.active {
    display: flex;
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
    animation: mouseFollowerPulse 2s ease-in-out infinite;
  }

  .backpack-mouse-follower img {
    width: 48px;
    height: 48px;
    object-fit: contain;
    image-rendering: pixelated;
    filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.8));
  }

  .backpack-mouse-follower .backpack-hotbar-slot-quantity {
    position: absolute;
    bottom: 2px;
    right: 2px;
    background: linear-gradient(145deg, #000, #333);
    color: #fff;
    font-size: 10px;
    font-weight: 700;
    padding: 2px 5px;
    border-radius: 4px;
    line-height: 1;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.9);
    border: 1px solid rgba(255, 255, 255, 0.3);
    min-width: 14px;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.6);
  }

  .backpack-mouse-follower .backpack-item-tooltip {
    z-index: 2001;
  }

  @keyframes mouseFollowerPulse {
    0%, 100% { 
      box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.9),
        0 4px 16px rgba(0, 0, 0, 0.7),
        inset 0 1px 0 rgba(255, 255, 255, 0.1),
        0 0 0 rgba(255, 255, 255, 0);
    }
    50% { 
      box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.9),
        0 4px 16px rgba(0, 0, 0, 0.7),
        inset 0 1px 0 rgba(255, 255, 255, 0.1),
        0 0 8px rgba(255, 255, 255, 0.2);
    }
  }

  /* Backpack-specific tooltip positioning (content handled by shared system) */
  .backpack-item-tooltip {
    position: absolute;
    bottom: 100%;
    left: 50%;
    margin-bottom: 8px;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    z-index: 2000;
    pointer-events: none;
  }

  /* Mouse Follower Tooltip */
  .backpack-mouse-follower .backpack-item-tooltip {
    z-index: 2001;
  }
</style>

<!-- Included from: ./menus/skills.html -->
<!-- Skills UI -->
<div class="skills-overlay">
  <div class="skills-container">
    <div class="skills-header">
      <h2 class="skills-title">Skills</h2>
      <button class="skills-close">×</button>
    </div>
    
    <div class="skills-content">
      <!-- Player Level Section -->
      <div class="skills-player-section">
        <div class="skills-player-level">
          <div class="skills-level-display">
            <span class="skills-level-number">Level 1</span>
          </div>
          <div class="skills-exp-bar">
            <div class="skills-exp-fill" style="width: 0%;"></div>
            <div class="skills-exp-text">0 / 85 XP</div>
          </div>
        </div>
      </div>

      <!-- Skills Section -->
      <div class="skills-skills-section">
        <div class="skills-skills-grid" id="skills-skills-grid">
          <!-- Skills will be generated by JavaScript -->
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Configuration
  const SKILLS_CONFIG = {
    defaultLevel: 1,
    defaultExp: 0,
    defaultRequiredExp: 85
  };

  // State
  let skillsConfig = [];

  // Data Handlers
  hytopia.onData(data => {
    switch (data.type) {
      case 'toggleSkills':
        toggleSkills();
        break;
      case 'syncExp':
        updateExp(data);
        break;
      case 'syncSkills':
        updateSkills(data.skills);
        break;
      case 'syncSkillsExp':
        updateSkillsExp(data);
        break;
    }
  });

  // UI Functions
  function toggleSkills() {
    const overlay = document.querySelector('.skills-overlay');
    if (overlay.style.display === 'flex') {
      closeSkills();
    } else {
      openSkills();
    }
  }

  function openSkills() {
    document.querySelector('.skills-overlay').style.display = 'flex';
    hytopia.lockPointer(false, true);
  }

  function closeSkills() {
    document.querySelector('.skills-overlay').style.display = 'none';
    hytopia.lockPointer(true);
    
    // Close any open mobile tooltips
    closeAllMobileTooltips();
  }

  // Update Functions
  function updateExp(data) {
    const { level, exp, currentLevelExp, nextLevelExp } = data;
    
    // Update level display
    document.querySelector('.skills-level-number').textContent = `Level ${level}`;
    
    // Update experience bar
    const expBar = document.querySelector('.skills-exp-fill');
    const expText = document.querySelector('.skills-exp-text');
    
    const currentProgress = exp - currentLevelExp;
    const maxProgress = nextLevelExp - currentLevelExp;
    const expPercent = Math.max(0, Math.min(100, (currentProgress / maxProgress) * 100));
    
    expBar.style.width = `${expPercent}%`;
    expText.textContent = `${formatExpNumber(currentProgress)} / ${formatExpNumber(maxProgress)} XP`;
  }

  function updateSkills(skills) {
    skillsConfig = skills;
    const skillsGrid = document.getElementById('skills-skills-grid');
    skillsGrid.innerHTML = '';
    
    skills.forEach(skill => {
      const skillItem = createSkillItem(skill);
      skillsGrid.appendChild(skillItem);
    });
    
    // Close any open mobile tooltips after updating skills
    closeAllMobileTooltips();
  }

  function updateSkillsExp(data) {
    data.skills.forEach(skillData => {
      updateSkillItem(skillData);
    });
  }

  function updateSkillItem(skillData) {
    const skillItem = document.querySelector(`[data-skill-id="${skillData.skillId}"]`);
    if (!skillItem) return;
    
    const levelSpan = skillItem.querySelector('.skills-skill-level');
    const expBar = skillItem.querySelector('.skills-skill-exp-fill');
    const expText = skillItem.querySelector('.skills-skill-exp-text');
    
    // Update level
    levelSpan.textContent = `Level ${skillData.level}`;
    
    // Update experience bar
    const currentProgress = skillData.exp - skillData.currentLevelExp;
    const maxProgress = skillData.nextLevelExp - skillData.currentLevelExp;
    const expPercent = Math.max(0, Math.min(100, (currentProgress / maxProgress) * 100));
    
    expBar.style.width = `${expPercent}%`;
    expText.textContent = `${formatExpNumber(currentProgress)} / ${formatExpNumber(maxProgress)} XP`;
  }

  // Utility Functions
  function formatExpNumber(num) {
    if (num >= 1000000) return `${(num / 1000000).toFixed(1)}M`;
    if (num >= 1000) return `${(num / 1000).toFixed(1)}K`;
    return num.toString();
  }

  function createSkillItem(skill) {
    const skillItem = document.createElement('div');
    skillItem.className = 'skills-skill-item';
    skillItem.setAttribute('data-skill-id', skill.id);
    
    skillItem.innerHTML = `
      <div class="skills-skill-icon">
        <img src="{{CDN_ASSETS_URL}}/${skill.iconAssetUri}" alt="${skill.name}" class="skills-skill-icon-img">
      </div>
      <div class="skills-skill-content">
        <div class="skills-skill-header">
          <span class="skills-skill-name">${skill.name}</span>
          <span class="skills-skill-level">Level ${SKILLS_CONFIG.defaultLevel}</span>
        </div>
        <div class="skills-skill-exp-bar">
          <div class="skills-skill-exp-fill" style="width: 0%;"></div>
          <div class="skills-skill-exp-text">${SKILLS_CONFIG.defaultExp} / ${SKILLS_CONFIG.defaultRequiredExp} XP</div>
        </div>
      </div>
      <div class="skills-skill-tooltip">
        <div class="skills-skill-tooltip-content">
          ${skill.description}
        </div>
      </div>
    `;
    
    return skillItem;
  }

  // Event Listeners
  function setupEventListeners() {
    document.querySelector('.skills-close').addEventListener('click', closeSkills);
    
    // Setup mobile tooltip handling
    setupMobileTooltips();
  }

  // Mobile tooltip handling
  function setupMobileTooltips() {
    // Check if we're on mobile
    const isMobile = document.body.classList.contains('mobile');
    if (!isMobile) return;
    
    // Add click handler to skills container for event delegation
    document.querySelector('.skills-skills-grid').addEventListener('click', handleMobileTooltipClick);
    
    // Add click handler to document to close tooltips when clicking outside
    document.addEventListener('click', handleDocumentClick);
  }
  
  function handleMobileTooltipClick(e) {
    const skillItem = e.target.closest('.skills-skill-item');
    if (!skillItem) return;
    
    e.stopPropagation();
    
    const tooltip = skillItem.querySelector('.skills-skill-tooltip');
    if (!tooltip) return;
    
    // Close any other open tooltips
    closeAllMobileTooltips();
    
    // Toggle this tooltip
    tooltip.classList.add('skills-mobile-tooltip-visible');
  }
  
  function handleDocumentClick(e) {
    // Close tooltips when clicking outside
    if (!e.target.closest('.skills-skill-item')) {
      closeAllMobileTooltips();
    }
  }
  
  function closeAllMobileTooltips() {
    const visibleTooltips = document.querySelectorAll('.skills-mobile-tooltip-visible');
    if (visibleTooltips.length > 0) {
      visibleTooltips.forEach(tooltip => {
        tooltip.classList.remove('skills-mobile-tooltip-visible');
      });
    }
  }

  // Initialize
  setupEventListeners();
  window.lumberjackSimulator.openSkills = openSkills;
</script>
<style>
  :root {
    --skills-font: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  }

  .skills-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    font-family: var(--skills-font);
    user-select: none;
  }

  /* Container Styles */
  .skills-container {
    background: linear-gradient(145deg, #2a2a2a, #1e1e1e);
    border: 2px solid #444;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.9), inset 0 1px 0 rgba(255, 255, 255, 0.1);
    width: 680px;
    overflow: hidden;
  }

  /* Header Styles */
  .skills-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    background: linear-gradient(135deg, #3a3a3a, #2d2d2d);
    border-bottom: 1px solid #444;
  }

  .skills-title {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
    color: #ffffff;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.9);
    letter-spacing: 0.3px;
  }

  .skills-close {
    background: rgba(255, 0, 0, 0.2);
    border: 1px solid rgba(255, 0, 0, 0.3);
    border-radius: 6px;
    color: #ff6b6b;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .skills-close:hover {
    background: rgba(255, 0, 0, 0.3);
    transform: scale(1.05);
  }

  /* Content Styles */
  .skills-content {
    padding: 20px;
  }

  .skills-section-title {
    margin: 0 0 3px 0;
    font-size: 14px;
    font-weight: 600;
    color: #ffffff;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.9);
  }

  /* Player Level Section */
  .skills-player-section {
    margin-bottom: 20px;
    padding: 12px;
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid #444;
    border-radius: 8px;
  }

  .skills-level-display {
    text-align: center;
    margin-bottom: 12px;
  }

  .skills-level-number {
    font-size: 18px;
    font-weight: 700;
    color: #ffd700;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.9);
  }

  .skills-exp-bar {
    position: relative;
    width: 100%;
    height: 20px;
    background: rgba(0, 0, 0, 0.6);
    border: 1px solid #444;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.5);
  }

  .skills-exp-fill {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    background: linear-gradient(90deg, #ffd700, #f59e0b);
    transition: width 0.5s ease;
    box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.2);
  }

  .skills-exp-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 11px;
    font-weight: 600;
    color: #ffffff;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.9);
    white-space: nowrap;
    z-index: 2;
  }

  /* Skills Section */
  .skills-skills-section {
    padding: 12px;
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid #444;
    border-radius: 8px;
  }

  .skills-skills-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 12px;
  }

  .skills-skill-item {
    position: relative;
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    background: rgba(0, 0, 0, 0.4);
    border: 1px solid #333;
    border-radius: 6px;
    transition: all 0.2s ease;
  }

  .skills-skill-item:hover {
    border-color: #555;
    background: rgba(0, 0, 0, 0.6);
  }

  .skills-skill-item:hover .skills-skill-tooltip {
    opacity: 1;
    visibility: visible;
    transform: translateY(-8px);
  }

  .skills-skill-tooltip {
    position: absolute;
    bottom: 100%;
    left: 0;
    margin-bottom: 6px;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    z-index: 1000;
    pointer-events: none;
  }

  .skills-skill-tooltip-content {
    background: linear-gradient(145deg, #2a2a2a, #1e1e1e);
    border: 2px solid #444;
    border-radius: 8px;
    padding: 8px 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.8), inset 0 1px 0 rgba(255, 255, 255, 0.1);
    font-size: 11px;
    font-weight: 500;
    color: #cccccc;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.9);
    white-space: normal;
    max-width: 200px;
    line-height: 1.3;
    position: relative;
  }

  .skills-skill-tooltip-content::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 20px;
    width: 0;
    height: 0;
    border-left: 10px solid transparent;
    border-right: 10px solid transparent;
    border-top: 10px solid #444;
  }

  .skills-skill-tooltip-content::before {
    content: '';
    position: absolute;
    top: 100%;
    left: 22px;
    width: 0;
    height: 0;
    border-left: 8px solid transparent;
    border-right: 8px solid transparent;
    border-top: 8px solid #2a2a2a;
    z-index: 1;
  }

  .skills-skill-icon {
    flex-shrink: 0;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px solid #444;
    border-radius: 8px;
    overflow: hidden;
  }

  .skills-skill-icon-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    opacity: 0.8;
  }

  .skills-skill-content {
    flex: 1;
    min-width: 0;
  }

  .skills-skill-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
  }

  .skills-skill-name {
    font-size: 13px;
    font-weight: 500;
    color: #cccccc;
  }

  .skills-skill-level {
    font-size: 12px;
    font-weight: 600;
    color: #3b82f6;
  }

  .skills-skill-exp-bar {
    position: relative;
    width: 100%;
    height: 16px;
    background: rgba(0, 0, 0, 0.6);
    border: 1px solid #444;
    border-radius: 6px;
    overflow: hidden;
    box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.5);
  }

  .skills-skill-exp-fill {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    background: linear-gradient(90deg, #3b82f6, #2563eb);
    transition: width 0.5s ease;
    box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.2);
  }

  .skills-skill-exp-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 10px;
    font-weight: 600;
    color: #ffffff;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.9);
    white-space: nowrap;
    z-index: 2;
  }

  /* Mobile Styles */
  body.mobile .skills-container {
    width: auto;
    max-width: 680px;
    min-width: 475px;
    border-radius: 8px;
  }

  body.mobile .skills-header {
    padding: 8px 12px;
    border-radius: 8px 8px 0 0;
  }

  body.mobile .skills-title {
    font-size: 14px;
  }

  body.mobile .skills-close {
    width: 24px;
    height: 24px;
    font-size: 16px;
    border-radius: 6px;
  }

  body.mobile .skills-content {
    padding: 12px;
  }

  body.mobile .skills-player-section,
  body.mobile .skills-skills-section {
    padding: 10px;
    border-radius: 6px;
  }

  body.mobile .skills-section-title {
    font-size: 12px;
    margin-bottom: 8px;
  }

  body.mobile .skills-level-display {
    margin-bottom: 8px;
  }

  body.mobile .skills-level-number {
    font-size: 16px;
  }

  body.mobile .skills-exp-bar {
    height: 16px;
    border-radius: 6px;
  }

  body.mobile .skills-exp-text {
    font-size: 10px;
  }

  body.mobile .skills-skills-grid {
    grid-template-columns: 1fr 1fr 1fr;
    gap: 6px;
  }

  body.mobile .skills-skill-item {
    gap: 6px;
    padding: 4px 8px;
    border-radius: 6px;
    min-height: 40px;
    cursor: pointer;
    -webkit-tap-highlight-color: rgba(255, 255, 255, 0.1);
  }

  body.mobile .skills-skill-icon {
    width: 28px;
    height: 28px;
    border-radius: 6px;
  }

  body.mobile .skills-skill-header {
    margin-bottom: 4px;
  }

  body.mobile .skills-skill-name {
    font-size: 10px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  body.mobile .skills-skill-level {
    font-size: 9px;
    flex-shrink: 0;
  }

  body.mobile .skills-skill-exp-bar {
    height: 10px;
    border-radius: 6px;
  }

  body.mobile .skills-skill-exp-text {
    font-size: 7px;
  }

  body.mobile .skills-skill-tooltip {
    opacity: 0;
    visibility: hidden;
    transform: translateY(-4px);
    transition: all 0.2s ease;
  }

  body.mobile .skills-mobile-tooltip-visible {
    opacity: 1 !important;
    visibility: visible !important;
    transform: translateY(-8px) !important;
  }

  body.mobile .skills-skill-tooltip-content {
    max-width: 180px;
    font-size: 10px;
  }

  /* Center the caret on mobile */
  body.mobile .skills-skill-tooltip-content::after {
    left: 50% !important;
    transform: translateX(-50%) !important;
  }

  body.mobile .skills-skill-tooltip-content::before {
    left: 50% !important;
    transform: translateX(-50%) !important;
  }

  /* Enable scrolling if needed */
  body.mobile .skills-content * {
    touch-action: pan-y !important;
  }
</style>


<!-- Included from: ./menus/dialogue.html -->
<!-- Dialogue UI -->
<div class="dialogue-overlay"></div>
<div class="dialogue-panel">
  <div class="dialogue-container">
    <!-- NPC Info Header -->
    <div class="dialogue-header">
      <div class="dialogue-npc-info">
        <img src="" alt="NPC" class="dialogue-npc-avatar">
        <div class="dialogue-npc-details">
          <div class="dialogue-npc-name"></div>
          <div class="dialogue-npc-title"></div>
        </div>
      </div>
      <button class="dialogue-close">×</button>
    </div>
    
    <!-- Content Area -->
    <div class="dialogue-content">
      <!-- Message -->
      <div class="dialogue-message"></div>
      
      <!-- Options -->
      <div class="dialogue-options"></div>
    </div>
  </div>
</div>

<script>
  hytopia.onData(data => {
    if (data.type === 'dialogue') {
      populateDialogue(data);
      openDialogue();
    }
  });

  function populateDialogue(data) {
    // Update avatar
    const avatar = document.querySelector('.dialogue-npc-avatar');
    avatar.src = data.avatarImageUri ? `{{CDN_ASSETS_URL}}/${data.avatarImageUri}` : '';

    // Update NPC info
    document.querySelector('.dialogue-npc-name').textContent = data.name || 'Unknown';
    document.querySelector('.dialogue-npc-title').textContent = data.title || '';

    // Update message with italic formatting support
    const messageEl = document.querySelector('.dialogue-message');
    messageEl.innerHTML = formatDialogueText(data.text || '');

    // Update options
    const optionsContainer = document.querySelector('.dialogue-options');
    optionsContainer.innerHTML = '';

    if (data.options?.length > 0) {
      data.options.forEach(option => {
        const optionEl = document.createElement('div');
        optionEl.className = 'dialogue-option';
        if (option.pureExit) {
          optionEl.classList.add('dialogue-option-exit');
        }
        if (option.isQuestRoot) {
          optionEl.classList.add('dialogue-option-quest');
        }
        if (option.isQuestRoot) {
          optionEl.innerHTML = `
            <img src="{{CDN_ASSETS_URL}}/icons/buttons/quests-transparent.png" alt="Quest" class="dialogue-quest-icon">
            <span class="dialogue-option-text">${formatDialogueText(option.text)}</span>
          `;
        } else {
          optionEl.innerHTML = formatDialogueText(option.text);
        }
        
        optionEl.addEventListener('click', () => {
          if (option.dismiss) {
            closeDialogue(option.pureExit);
          }
          
          hytopia.sendData({
            type: 'progressDialogue',
            optionId: option.id
          });
        });

        optionsContainer.appendChild(optionEl);
      });
    }
  }

  function formatDialogueText(text) {
    // Escape HTML to prevent XSS, but allow our specific formatting
    const escapeHtml = (unsafe) => {
      return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    };

    // Escape the text first
    let formatted = escapeHtml(text);
    
    // Convert *text* to <em>text</em> for italics
    formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
    
    return formatted;
  }

  function closeDialogue(relockPointer = true) {
    const panel = document.querySelector('.dialogue-panel');
    const overlay = document.querySelector('.dialogue-overlay');
    panel.classList.add('dialogue-closing');
    overlay.classList.add('dialogue-closing');

    if (relockPointer) {
      hytopia.lockPointer(true);
    }
  }

  function openDialogue() {
    const panel = document.querySelector('.dialogue-panel');
    const overlay = document.querySelector('.dialogue-overlay');
    
    panel.style.display = 'block';
    overlay.style.display = 'block';
    panel.classList.remove('dialogue-closing');
    overlay.classList.remove('dialogue-closing');
    hytopia.lockPointer(false);
  }

  // Handle animation completion
  document.querySelector('.dialogue-panel').addEventListener('animationend', (e) => {
    const panel = e.target;
    if (panel.classList.contains('dialogue-closing')) {
      panel.style.display = 'none';
      document.querySelector('.dialogue-overlay').style.display = 'none';
      panel.classList.remove('dialogue-closing');
      document.querySelector('.dialogue-overlay').classList.remove('dialogue-closing');
    }
  });

  // Setup close button
  document.querySelector('.dialogue-close').addEventListener('click', closeDialogue);
</script>
<style>
  :root {
    --dialogue-font: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    --dialogue-primary: #2a2a2a;
    --dialogue-secondary: #1e1e1e;
    --dialogue-border: #444;
    --dialogue-text: #ffffff;
    --dialogue-text-secondary: #cccccc;
    --dialogue-accent: #3b82f6;
    --dialogue-exit: #dc2626;
  }

  .dialogue-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.4);
    z-index: 899;
    animation: overlayFadeIn 0.3s ease-out;
  }

  .dialogue-overlay.dialogue-closing {
    animation: overlayFadeOut 0.3s ease-out forwards;
  }

  @keyframes overlayFadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  @keyframes overlayFadeOut {
    from { opacity: 1; }
    to { opacity: 0; }
  }

  .dialogue-panel {
    display: none;
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: min(400px, calc(100vw - 40px));
    max-height: min(60vh, calc(100vh - 40px));
    z-index: 900;
    font-family: var(--dialogue-font);
    user-select: none;
    pointer-events: auto;
    animation: dialogueSlideIn 0.3s ease-out;
  }

  .dialogue-panel.dialogue-closing {
    animation: dialogueSlideOut 0.3s ease-out forwards;
  }

  @keyframes dialogueSlideIn {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  @keyframes dialogueSlideOut {
    from {
      transform: translateX(0);
      opacity: 1;
    }
    to {
      transform: translateX(100%);
      opacity: 0;
    }
  }

  .dialogue-container {
    background: linear-gradient(145deg, var(--dialogue-primary), var(--dialogue-secondary));
    border: 2px solid var(--dialogue-border);
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.9), inset 0 1px 0 rgba(255, 255, 255, 0.1);
    overflow: hidden;
    backdrop-filter: blur(4px);
    width: 100%;
    box-sizing: border-box;
  }

  /* Header */
  .dialogue-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 14px;
    background: linear-gradient(135deg, #3a3a3a, #2d2d2d);
    border-bottom: 1px solid var(--dialogue-border);
    box-sizing: border-box;
  }

  .dialogue-npc-info {
    display: flex;
    align-items: center;
    gap: 10px;
    flex: 1;
    min-width: 0;
  }

  .dialogue-npc-avatar {
    width: 48px;
    height: 48px;
    border: 2px solid var(--dialogue-border);
    border-radius: 6px;
    object-fit: cover;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.6);
    flex-shrink: 0;
  }

  .dialogue-npc-details {
    display: flex;
    flex-direction: column;
    min-width: 0;
    flex: 1;
  }

  .dialogue-npc-name {
    font-size: 14px;
    font-weight: 600;
    color: var(--dialogue-text);
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.9);
    line-height: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .dialogue-npc-title {
    font-size: 12px;
    font-weight: 500;
    color: var(--dialogue-text-secondary);
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.9);
    margin-top: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .dialogue-close {
    background: rgba(255, 0, 0, 0.2);
    border: 1px solid rgba(255, 0, 0, 0.3);
    border-radius: 4px;
    color: #ff6b6b;
    width: 22px;
    height: 22px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.2s ease;
    flex-shrink: 0;
  }

  .dialogue-close:hover {
    background: rgba(255, 0, 0, 0.3);
    transform: scale(1.05);
  }

  /* Content */
  .dialogue-content {
    padding: 14px;
    max-height: calc(min(50vh, calc(100vh - 120px)) - 60px);
    overflow-y: auto;
    box-sizing: border-box;
  }

  .dialogue-message {
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 6px;
    padding: 10px;
    margin-bottom: 10px;
    font-size: 12px;
    line-height: 1.4;
    color: var(--dialogue-text);
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.9);
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.5);
    overflow-wrap: break-word;
  }

  .dialogue-message em,
  .dialogue-option em {
    font-style: italic;
  }

  .dialogue-options {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .dialogue-option {
    background: rgba(0, 0, 0, 0.4);
    border: 1px solid var(--dialogue-border);
    border-radius: 4px;
    padding: 6px 10px;
    font-size: 12px;
    font-weight: 500;
    color: var(--dialogue-text-secondary);
    cursor: pointer;
    transition: all 0.2s ease;
    overflow-wrap: break-word;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .dialogue-option:hover {
    border-color: var(--dialogue-accent);
    background: rgba(59, 130, 246, 0.1);
    color: var(--dialogue-text);
    transform: translateX(2px);
  }

  .dialogue-option-exit {
    color: #fca5a5;
    margin-top: 4px;
  }

  .dialogue-option-exit:hover {
    border-color: var(--dialogue-exit);
    background: rgba(220, 38, 38, 0.1);
    color: #f87171;
  }

  .dialogue-option-quest {
    color: #66BB6A;
    border-color: rgba(76, 175, 80, 0.4);
  }

  .dialogue-option-quest:hover {
    border-color: #4CAF50;
    background: rgba(76, 175, 80, 0.08);
    color: #81C784;
  }

  .dialogue-quest-icon {
    width: 16px;
    height: 16px;
    flex-shrink: 0;
    image-rendering: pixelated;
    filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.8));
  }

  .dialogue-option-text {
    flex: 1;
  }

  /* Mobile Responsive */
  body.mobile .dialogue-panel {
    bottom: 20px;
    right: 20px;
    width: auto;
    max-width: 340px;
    min-width: 280px;
    max-height: calc(100vh - 40px);
  }

  body.mobile .dialogue-header {
    padding: 8px 12px;
    border-radius: 8px 8px 0 0;
  }

  body.mobile .dialogue-container {
    border-radius: 8px;
  }

  body.mobile .dialogue-npc-avatar {
    width: 32px;
    height: 32px;
    border-radius: 4px;
  }

  body.mobile .dialogue-npc-name {
    font-size: 12px;
  }

  body.mobile .dialogue-npc-title {
    font-size: 10px;
  }

  body.mobile .dialogue-close {
    width: 20px;
    height: 20px;
    font-size: 12px;
    border-radius: 4px;
  }

  body.mobile .dialogue-content {
    padding: 12px;
    max-height: calc(100vh - 140px);
    overflow-y: auto;
  }

  body.mobile .dialogue-message {
    padding: 8px;
    font-size: 11px;
    margin-bottom: 8px;
    border-radius: 4px;
    touch-action: pan-y;
  }

  body.mobile .dialogue-option {
    padding: 8px 10px;
    font-size: 11px;
    border-radius: 4px;
  }

  body.mobile .dialogue-quest-icon {
    width: 14px;
    height: 14px;
  }

  /* AGGRESSIVE override of global touch-action: none for dialogue */
  body.mobile .dialogue-overlay,
  body.mobile .dialogue-panel,
  body.mobile .dialogue-container,
  body.mobile .dialogue-header,
  body.mobile .dialogue-content,
  body.mobile .dialogue-options,
  body.mobile .dialogue-option,
  body.mobile .dialogue-close {
    touch-action: manipulation !important;
    pointer-events: auto !important;
    -webkit-touch-callout: default !important;
    -webkit-user-select: auto !important;
    user-select: auto !important;
  }

  /* Force touch events on all dialogue interactive elements */
  body.mobile .dialogue-option,
  body.mobile .dialogue-option *,
  body.mobile .dialogue-close,
  body.mobile .dialogue-close *,
  body.mobile .dialogue-quest-icon,
  body.mobile .dialogue-option-text {
    touch-action: manipulation !important;
    pointer-events: auto !important;
    cursor: pointer !important;
  }

  /* Only allow scrolling on message content */
  body.mobile .dialogue-message {
    touch-action: pan-y !important;
    overflow-y: auto;
  }
</style> 

<!-- Included from: ./menus/quests.html -->
<!-- Quests UI -->
<div class="quests-overlay">
  <div class="quests-container">
    <div class="quests-header">
      <h2 class="quests-title">Quests</h2>
      <button class="quests-close">×</button>
    </div>
    
    <div class="quests-content">
      <!-- Left Sidebar -->
      <div class="quests-sidebar">
        <!-- Active Quests Section -->
        <div class="quests-section">
          <h3 class="quests-section-title">Active Quests</h3>
          <div class="quests-list" id="quests-active-list">
            <!-- Active quests will be populated by JavaScript -->
          </div>
        </div>
        
        <!-- Completed Quests Section -->
        <div class="quests-section">
          <h3 class="quests-section-title">Completed Quests</h3>
          <div class="quests-list" id="quests-completed-list">
            <!-- Completed quests will be populated by JavaScript -->
          </div>
        </div>
      </div>
      
      <!-- Quest Details Panel -->
      <div class="quests-details-panel">
        <div class="quests-details-content" id="quests-details-content" style="display: none;">
          <!-- Quest details will be populated by JavaScript -->
        </div>
        
        <!-- Empty state when no quest is selected -->
        <div class="quests-empty-state" id="quests-empty-state">
          <div class="quests-empty-content">
            <div class="quests-empty-icon">📜</div>
            <div class="quests-empty-text">No active quests. Explore & talk to NPCs to discover new quests!</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // State management
  const questsState = {
    activeQuests: new Map(),
    completedQuests: new Map(),
    selectedQuestId: null
  };

  // Setup hytopia data handlers
  hytopia.onData(data => {
    if (data.type === 'toggleQuests') {
      toggleQuests();
    }
    
    if (data.type === 'questUpdate') {
      updateQuestData(data);
    }
  });

  // Initialize quest system
  function initializeQuests() {
    setupEventListeners();
    renderQuestLists();
    updateEmptyPlaceholders();
  }

  function setupEventListeners() {
    const closeButton = document.querySelector('.quests-close');
    closeButton.addEventListener('click', closeQuests);
  }

  function updateQuestData(questData) {
    // Validate required data
    if (!questData?.id || !questData?.name) {
      console.warn('Invalid quest data received:', questData);
      return;
    }
    
    const { id, name, description, objectives, reward, state } = questData;
    
    // Sanitize and structure quest data
    const questInfo = {
      id: String(id),
      name: sanitizeText(name),
      description: sanitizeText(description || ''),
      objectives: Array.isArray(objectives) ? objectives : [],
      reward: reward || {},
      state: state || { state: 'active', objectiveProgress: {} },
      _cachedCompletedCount: undefined // Clear cache on data update
    };

    // Remove from both maps first
    questsState.activeQuests.delete(id);
    questsState.completedQuests.delete(id);

    // Add to appropriate map based on state
    const targetMap = state?.state === 'completed' ? questsState.completedQuests : questsState.activeQuests;
    targetMap.set(id, questInfo);

    // Efficiently update only the affected quest
    updateQuestItem(id, questInfo);
    
    // If this quest is currently selected, update the details
    if (questsState.selectedQuestId === id) {
      showQuestDetails(id);
    }
    
    // Ensure empty state is shown if needed
    if (questsState.activeQuests.size === 0 && !questsState.selectedQuestId) {
      showEmptyState();
    }

    // Trigger HUD quest count update
    window.lumberjackSimulator.updateHudQuestCount(questsState.activeQuests.size, questsState.completedQuests.size);
  }

  function sanitizeText(text) {
    if (typeof text !== 'string') return '';
    return text.replace(/[<>&"']/g, char => ({
      '<': '&lt;', '>': '&gt;', '&': '&amp;', '"': '&quot;', "'": '&#39;'
    })[char]);
  }

  function renderQuestLists() {
    renderQuestList('active', questsState.activeQuests, 'quests-active-list');
    renderQuestList('completed', questsState.completedQuests, 'quests-completed-list');
    
    // Show empty state if no active quests and nothing is selected
    if (questsState.activeQuests.size === 0 && !questsState.selectedQuestId) {
      showEmptyState();
    }
  }

  function renderQuestList(type, questsMap, containerId) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';

    if (questsMap.size === 0) {
      // Show placeholder text when empty
      const placeholder = document.createElement('div');
      placeholder.className = 'quests-empty-section';
      placeholder.textContent = type === 'active' ? 'No active quests' : 'No completed quests';
      container.appendChild(placeholder);
    } else {
      for (const [questId, quest] of questsMap) {
        container.appendChild(createQuestItem(questId, quest, type));
      }
    }
  }

  function createQuestItem(questId, quest, type) {
    const questItem = document.createElement('div');
    const isSelected = questsState.selectedQuestId === questId;
    const isCompleted = type === 'completed';
    
    questItem.className = `quests-item${isCompleted ? ' quests-item-completed' : ''}${isSelected ? ' quests-item-selected' : ''}`;
    questItem.dataset.questId = questId;
    
    const progress = isCompleted ? '✓' : `${calculateCompletedObjectives(quest)}/${quest.objectives.length}`;
    
    questItem.innerHTML = `
      <div class="quests-item-name">${quest.name}</div>
      <div class="quests-item-progress">${progress}</div>
    `;
    
    questItem.addEventListener('click', () => selectQuest(questId));
    return questItem;
  }

  function updateQuestItem(questId, quest) {
    // Remove existing quest item from both lists
    document.querySelectorAll(`[data-quest-id="${questId}"]`).forEach(item => item.remove());
    
    // Add to appropriate list
    const isCompleted = quest.state.state === 'completed';
    const containerId = isCompleted ? 'quests-completed-list' : 'quests-active-list';
    const container = document.getElementById(containerId);
    const type = isCompleted ? 'completed' : 'active';
    
    // Check if container is empty and needs placeholder removal
    const emptyPlaceholder = container.querySelector('.quests-empty-section');
    if (emptyPlaceholder) {
      emptyPlaceholder.remove();
    }
    
    container.appendChild(createQuestItem(questId, quest, type));
    
    // Add empty placeholders if lists become empty
    updateEmptyPlaceholders();
  }

  function updateEmptyPlaceholders() {
    const activeContainer = document.getElementById('quests-active-list');
    const completedContainer = document.getElementById('quests-completed-list');
    
    // Handle active quests empty state
    if (questsState.activeQuests.size === 0 && !activeContainer.querySelector('.quests-empty-section')) {
      const placeholder = document.createElement('div');
      placeholder.className = 'quests-empty-section';
      placeholder.textContent = 'No active quests';
      activeContainer.appendChild(placeholder);
    }
    
    // Handle completed quests empty state
    if (questsState.completedQuests.size === 0 && !completedContainer.querySelector('.quests-empty-section')) {
      const placeholder = document.createElement('div');
      placeholder.className = 'quests-empty-section';
      placeholder.textContent = 'No completed quests';
      completedContainer.appendChild(placeholder);
    }
  }

  function selectQuest(questId) {
    // Remove previous selection efficiently
    if (questsState.selectedQuestId) {
      const prevSelected = document.querySelector(`[data-quest-id="${questsState.selectedQuestId}"]`);
      prevSelected?.classList.remove('quests-item-selected');
    }
    
    // Add selection to clicked item
    const selectedItem = document.querySelector(`[data-quest-id="${questId}"]`);
    selectedItem?.classList.add('quests-item-selected');
    
    questsState.selectedQuestId = questId;
    showQuestDetails(questId);
  }

  function calculateCompletedObjectives(quest) {
    // Cache the result on the quest object to avoid recalculation
    if (quest._cachedCompletedCount !== undefined) {
      return quest._cachedCompletedCount;
    }
    
    quest._cachedCompletedCount = quest.objectives.reduce((count, objective) => {
      const progress = quest.state.objectiveProgress[objective.id] || 0;
      return count + (progress >= objective.target ? 1 : 0);
    }, 0);
    
    return quest._cachedCompletedCount;
  }

  function showQuestDetails(questId) {
    const quest = questsState.activeQuests.get(questId) || questsState.completedQuests.get(questId);
    if (!quest) return;

    toggleDetailsPanels(true);
    renderQuestDetails(quest);
  }

  function toggleDetailsPanels(showDetails) {
    const detailsContent = document.getElementById('quests-details-content');
    const emptyState = document.getElementById('quests-empty-state');
    
    if (showDetails) {
      emptyState.style.display = 'none';
      detailsContent.style.display = 'block';
    } else {
      detailsContent.style.display = 'none';
      emptyState.style.display = 'flex';
    }
  }

  function renderQuestDetails(quest) {
    const completedObjectives = calculateCompletedObjectives(quest);
    const totalObjectives = quest.objectives.length;
    
    const detailsContent = document.getElementById('quests-details-content');
    detailsContent.innerHTML = `
      <div class="quests-detail-header">
        <h3 class="quests-detail-name">${quest.name}</h3>
      </div>
      
      <div class="quests-detail-description">
        <p>${quest.description}</p>
      </div>
      
      <div class="quests-detail-objectives">
        <h4 class="quests-objectives-title">Objectives (${completedObjectives}/${totalObjectives})</h4>
        <ul class="quests-objectives-list">
          ${generateObjectivesHTML(quest)}
        </ul>
      </div>
      
      <div class="quests-detail-rewards">
        <h4 class="quests-rewards-title">Rewards</h4>
        <div class="quests-rewards-list">
          ${generateRewardsHTML(quest.reward)}
        </div>
      </div>
    `;
    
    // Add tooltips to reward items after rendering
    addRewardTooltips(quest.reward);
  }

  function addRewardTooltips(reward) {
    // Clear any existing tooltips first
    const existingTooltipItems = document.querySelectorAll('.quests-reward-item-tooltip-enabled');
    existingTooltipItems.forEach(item => removeRewardTooltip(item));
    
    // Add tooltips to item rewards
    if (reward.items) {
      reward.items.forEach((itemReward, index) => {
        const rewardItem = document.querySelector(`[data-reward-item-index="${index}"]`);
        if (rewardItem && window.ItemTooltips) {
          createRewardTooltip(rewardItem, itemReward);
        }
      });
    }
  }

  function createRewardTooltip(item, itemData) {
    const options = {
      tooltipClass: 'quests-reward-item-tooltip',
      contentClass: 'quests-reward-item-tooltip-content',
      showBuyPrice: false,
      showSellPrice: false
    };
    
    ItemTooltips.createTooltip(item, itemData, options);
  }

  function removeRewardTooltip(item) {
    ItemTooltips.removeTooltip(item, 'quests-reward-item-tooltip');
  }

  function generateObjectivesHTML(quest) {
    return quest.objectives.map(objective => {
      const progress = quest.state.objectiveProgress[objective.id] || 0;
      const isCompleted = progress >= objective.target;
      const statusClass = isCompleted ? 'quests-objective-completed' : 'quests-objective-active';
      const icon = isCompleted ? '✓' : '○';
      
      // Add inline progress for objectives with target > 1
      const progressText = objective.target > 1 ? ` (${progress}/${objective.target})` : '';
      
      return `
        <li class="quests-objective ${statusClass}">
          <span class="quests-objective-icon">${icon}</span>
          <span class="quests-objective-text">${sanitizeText(objective.description)}${progressText}</span>
        </li>
      `;
    }).join('');
  }

  function generateRewardsHTML(reward) {
    const rewards = [];
    
    // Handle skill experience rewards
    reward.skillExperience?.forEach(expReward => {
      const skillName = expReward.skillId.charAt(0).toUpperCase() + expReward.skillId.slice(1);
      rewards.push(`
        <div class="quests-reward-item">
          <span class="quests-reward-exp-icon">+</span>
          <span class="quests-reward-text">${expReward.amount.toLocaleString()} ${skillName} Experience</span>
        </div>
      `);
    });
    
    // Handle item rewards
    reward.items?.forEach((itemReward, index) => {
      const quantity = itemReward.quantity > 1 ? `x${itemReward.quantity.toLocaleString()}` : 'x1';
      const iconSrc = itemReward.iconImageUri ? `{{CDN_ASSETS_URL}}/${itemReward.iconImageUri}` : '{{CDN_ASSETS_URL}}/icons/items/gold.png';
      rewards.push(`
        <div class="quests-reward-item quests-reward-item-tooltip-enabled" data-reward-item-index="${index}">
          <img src="${iconSrc}" alt="Item" class="quests-reward-icon">
          <span class="quests-reward-text">${sanitizeText(itemReward.name)} (${quantity})</span>
        </div>
      `);
    });
    
    return rewards.length > 0 ? rewards.join('') : '<div class="quests-reward-item"><span class="quests-reward-text">No rewards</span></div>';
  }

  function showEmptyState() {
    toggleDetailsPanels(false);
    questsState.selectedQuestId = null;
    
    // Update empty state message
    const emptyText = document.querySelector('.quests-empty-text');
    if (emptyText) {
      emptyText.textContent = 'You have no active quests. Explore or talk to NPCs to discover new quests!';
    }
  }

  function closeQuests() {
    document.querySelector('.quests-overlay').style.display = 'none';
    hytopia.lockPointer(true);
  }

  function openQuests() {
    document.querySelector('.quests-overlay').style.display = 'flex';
    hytopia.lockPointer(false, true);
    
    // Auto-select first active quest if available
    if (questsState.activeQuests.size > 0 && !questsState.selectedQuestId) {
      const firstActiveQuestId = questsState.activeQuests.keys().next().value;
      selectQuest(firstActiveQuestId);
    }
  }

  function toggleQuests() {
    const overlay = document.querySelector('.quests-overlay');
    if (overlay.style.display === 'flex') {
      closeQuests();
    } else {
      openQuests();
    }
  }

  // Initialize
  initializeQuests();

  // Setup global functions
  window.lumberjackSimulator = window.lumberjackSimulator || {};
  window.lumberjackSimulator.openQuests = openQuests;
  
</script>
<style>
  :root {
    --quests-font: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  }

  .quests-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    font-family: var(--quests-font);
    user-select: none;
  }

  /* Container Styles */
  .quests-container {
    background: linear-gradient(145deg, #2a2a2a, #1e1e1e);
    border: 2px solid #444;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.9), inset 0 1px 0 rgba(255, 255, 255, 0.1);
    width: 800px;
    height: 600px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  /* Header Styles */
  .quests-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    background: linear-gradient(135deg, #3a3a3a, #2d2d2d);
    border-bottom: 1px solid #444;
    flex-shrink: 0;
  }

  .quests-title {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
    color: #ffffff;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.9);
    letter-spacing: 0.3px;
  }

  .quests-close {
    background: rgba(255, 0, 0, 0.2);
    border: 1px solid rgba(255, 0, 0, 0.3);
    border-radius: 6px;
    color: #ff6b6b;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .quests-close:hover {
    background: rgba(255, 0, 0, 0.3);
    transform: scale(1.05);
  }

  /* Content Layout */
  .quests-content {
    display: flex;
    flex: 1;
    min-height: 0;
  }

  /* Sidebar Styles */
  .quests-sidebar {
    width: 280px;
    background: rgba(0, 0, 0, 0.3);
    border-right: 1px solid #444;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    flex-shrink: 0;
  }

  .quests-section {
    display: flex;
    flex-direction: column;
    min-height: 0;
  }

  .quests-section:first-child {
    flex: 1;
    min-height: 50%;
  }

  /* When active quests section has only placeholder, still maintain minimum height */
  .quests-section:first-child:has(.quests-empty-section:only-child) {
    flex: 1;
    min-height: 50%;
  }

  .quests-section-title {
    margin: 0;
    padding: 12px 16px 8px;
    font-size: 14px;
    font-weight: 600;
    color: #ffffff;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.9);
    border-bottom: 1px solid #333;
    background: rgba(0, 0, 0, 0.2);
    flex-shrink: 0;
  }

  .quests-list {
    flex: 1;
    min-height: 0;
    overflow-y: auto;
    padding: 8px;
  }

  /* Quest Item Styles */
  .quests-item {
    background: rgba(0, 0, 0, 0.4);
    border: 1px solid #333;
    border-radius: 6px;
    padding: 12px;
    margin-bottom: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 8px;
  }

  .quests-item:hover {
    border-color: #555;
    background: rgba(0, 0, 0, 0.6);
    transform: translateX(2px);
  }

  .quests-item-selected {
    border-color: #4CAF50 !important;
    background: rgba(76, 175, 80, 0.1) !important;
    box-shadow: 0 0 0 1px rgba(76, 175, 80, 0.3);
  }

  .quests-item-name {
    font-size: 12px;
    font-weight: 500;
    color: #cccccc;
    line-height: 1.3;
    flex: 1;
    min-width: 0;
    word-wrap: break-word;
  }

  .quests-item-progress {
    font-size: 11px;
    font-weight: 600;
    color: #888;
    flex-shrink: 0;
  }

  .quests-item-completed {
    opacity: 0.7;
  }

  .quests-item-completed .quests-item-name {
    color: #999;
    text-decoration: line-through;
  }

  .quests-item-completed .quests-item-progress {
    color: #4CAF50;
  }

  .quests-item-active .quests-item-progress {
    color: #ffd700;
  }

  /* Empty section placeholder */
  .quests-empty-section {
    padding: 16px 12px;
    text-align: center;
    font-weight: 500;
    font-size: 12px;
    color: #666;
    line-height: 1.5;
  }

  /* Details Panel Styles */
  .quests-details-panel {
    flex: 1;
    background: rgba(0, 0, 0, 0.2);
    display: flex;
    flex-direction: column;
    min-height: 0;
  }

  .quests-details-content {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
  }

  .quests-detail-header {
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 1px solid #333;
  }

  .quests-detail-name {
    margin: 0 0 12px 0;
    font-size: 18px;
    font-weight: 600;
    color: #ffffff;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.9);
    line-height: 1.2;
  }



  .quests-detail-description {
    margin-bottom: 24px;
  }

  .quests-detail-description p {
    margin: 0;
    font-size: 13px;
    line-height: 1.5;
    color: #cccccc;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.9);
  }

  .quests-detail-objectives {
    margin-bottom: 20px;
  }

  .quests-objectives-title {
    margin: 0 0 12px 0;
    font-size: 14px;
    font-weight: 600;
    color: #ffffff;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.9);
  }

  .quests-objectives-list {
    margin: 0;
    padding: 0;
    list-style: none;
  }

  .quests-objective {
    display: flex;
    align-items: flex-start;
    gap: 8px;
    padding: 8px 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
  }

  .quests-objective:last-child {
    border-bottom: none;
  }

  .quests-objective-icon {
    flex-shrink: 0;
    width: 16px;
    height: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: bold;
  }

  .quests-objective-completed .quests-objective-icon {
    color: #4CAF50;
  }

  .quests-objective-active .quests-objective-icon {
    color: #ffd700;
  }

  .quests-objective-text {
    font-size: 12px;
    line-height: 1.4;
    color: #cccccc;
    flex: 1;
  }

  .quests-objective-completed .quests-objective-text {
    color: #999;
    text-decoration: line-through;
  }

  /* Rewards Styles */
  .quests-detail-rewards {
    margin-bottom: 20px;
  }

  .quests-rewards-title {
    margin: 0 0 12px 0;
    font-size: 14px;
    font-weight: 600;
    color: #ffffff;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.9);
  }

  .quests-rewards-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .quests-reward-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 12px;
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid #333;
    border-radius: 6px;
    transition: all 0.2s ease;
  }

  .quests-reward-item:hover {
    border-color: #555;
    background: rgba(0, 0, 0, 0.5);
  }

  .quests-reward-icon {
    width: 20px;
    height: 20px;
    object-fit: contain;
    image-rendering: pixelated;
    flex-shrink: 0;
    filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.8));
  }

  .quests-reward-exp-icon {
    font-size: 16px;
    font-weight: bold;
    color: #ffd700;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
    text-align: center;
    transform: translateY(-1px);
    width: 20px;
  }

  .quests-reward-text {
    font-size: 12px;
    font-weight: 500;
    color: #cccccc;
    line-height: 1.3;
  }

  /* Quest reward tooltip positioning - left-aligned for full-width items */
  .quests-reward-item-tooltip {
    position: absolute;
    bottom: 100%;
    left: 0;
    margin-bottom: 8px;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    z-index: 2000;
    pointer-events: none;
  }

  .quests-reward-item-tooltip-enabled {
    position: relative;
    cursor: pointer;
  }

  /* Override center positioning for quest reward tooltips */
  .quests-reward-item-tooltip-content {
    transform: translateX(0) !important;
  }

  /* Position caret over the reward icon */
  .quests-reward-item-tooltip-content::after {
    left: 20px !important;
    transform: translateX(-50%) !important;
  }

  .quests-reward-item-tooltip-content::before {
    left: 20px !important;
    transform: translateX(-50%) !important;
  }

  /* Empty State */
  .quests-empty-state {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .quests-empty-content {
    text-align: center;
    color: #666;
  }

  .quests-empty-icon {
    font-size: 48px;
    margin-bottom: 12px;
    opacity: 0.5;
  }

  .quests-empty-text {
    font-size: 14px;
    font-weight: 500;
    line-height: 1.5;
    padding: 0 12px;
  }

  /* Scrollbar Styles */
  .quests-list::-webkit-scrollbar,
  .quests-details-content::-webkit-scrollbar {
    width: 6px;
  }

  .quests-list::-webkit-scrollbar-track,
  .quests-details-content::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.3);
    border-radius: 3px;
  }

  .quests-list::-webkit-scrollbar-thumb,
  .quests-details-content::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 3px;
  }

  .quests-list::-webkit-scrollbar-thumb:hover,
  .quests-details-content::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.3);
  }

  /* Mobile Styles */
  body.mobile .quests-container {
    width: auto;
    max-width: 600px;
    min-width: 340px;
    height: 85vh;
    border-radius: 8px;
  }

  body.mobile .quests-header {
    padding: 8px 12px;
    border-radius: 8px 8px 0 0;
  }

  body.mobile .quests-title {
    font-size: 14px;
  }

  body.mobile .quests-close {
    width: 24px;
    height: 24px;
    font-size: 16px;
    border-radius: 6px;
  }

  body.mobile .quests-sidebar {
    width: 175px;
    min-width: 175px;
  }

  body.mobile .quests-section-title {
    padding: 8px 10px 6px;
    font-size: 11px;
  }

  body.mobile .quests-list {
    padding: 6px;
  }

  body.mobile .quests-list * {
    overflow-y: scroll;
  }

  body.mobile .quests-item {
    padding: 3px 8px;
    margin-bottom: 3px;
    border-radius: 6px;
    min-height: 28px;
  }

  body.mobile .quests-item-name {
    font-size: 11px;
    font-weight: 500;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  body.mobile .quests-item-progress {
    font-size: 9px;
    font-weight: 600;
  }

  body.mobile .quests-details-content {
    padding: 12px;
  }

  body.mobile .quests-details-content * {
    overflow-y: scroll;
  }

  /* Exception for reward items and tooltips - override the blanket overflow rule */
  body.mobile .quests-reward-item,
  body.mobile .quests-reward-item *,
  body.mobile .quests-reward-item-tooltip,
  body.mobile .quests-reward-item-tooltip * {
    overflow: visible !important;
  }

  /* Ensure all parent containers allow tooltips to escape */
  body.mobile .quests-rewards-list,
  body.mobile .quests-detail-rewards,
  body.mobile .quests-details-panel {
    overflow: visible !important;
  }

  body.mobile .quests-rewards-list * {
    overflow-y: scroll !important;
    touch-action: pan-y !important;
  }

  body.mobile .quests-detail-header {
    margin-bottom: 12px;
    padding-bottom: 8px;
  }

  body.mobile .quests-detail-name {
    font-size: 14px;
    margin-bottom: 6px;
  }

  body.mobile .quests-detail-description {
    margin-bottom: 16px;
  }

  body.mobile .quests-detail-description p {
    font-size: 11px;
    line-height: 1.4;
  }

  body.mobile .quests-detail-objectives {
    margin-bottom: 12px;
  }

  body.mobile .quests-objectives-title,
  body.mobile .quests-rewards-title {
    font-size: 12px;
    margin-bottom: 8px;
  }

  body.mobile .quests-objectives-list {
    margin-bottom: 6px;
  }

  body.mobile .quests-objective {
    padding: 6px 0;
    gap: 8px;
  }

  body.mobile .quests-objective-icon {
    width: 14px;
    height: 14px;
    font-size: 10px;
  }

  body.mobile .quests-objective-text {
    font-size: 10px;
    line-height: 1.3;
  }

  body.mobile .quests-reward-item {
    padding: 3px 8px;
    gap: 6px;
    border-radius: 6px;
    min-height: 24px;
  }

  body.mobile .quests-reward-icon {
    width: 16px;
    height: 16px;
  }

  body.mobile .quests-reward-exp-icon {
    font-size: 12px;
    width: 16px;
  }

  body.mobile .quests-reward-text {
    font-size: 10px;
    font-weight: 500;
  }

  body.mobile .quests-empty-section {
    padding: 12px 8px;
    font-size: 10px;
    line-height: 1.3;
  }

  body.mobile .quests-empty-content {
    padding: 16px 12px;
  }

  body.mobile .quests-empty-icon {
    font-size: 32px;
    margin-bottom: 8px;
  }

  body.mobile .quests-empty-text {
    font-size: 11px;
    line-height: 1.3;
    padding: 0 6px;
  }

  /* Mobile tooltip adjustments */
  body.mobile .quests-reward-item-tooltip {
    opacity: 0;
    visibility: hidden;
    transition: all 0.2s ease;
  }

  body.mobile .quests-reward-item-tooltip.mobile-tooltip-visible {
    opacity: 1 !important;
    visibility: visible !important;
  }

  /* Override mobile caret centering - keep caret over reward icon */
  body.mobile .quests-reward-item-tooltip-content::after {
    left: 15px !important;
    transform: translateX(-50%) !important;
  }

  body.mobile .quests-reward-item-tooltip-content::before {
    left: 15px !important;
    transform: translateX(-50%) !important;
  }

  /* Override global touch-action: none for quest interactions */
  body.mobile .quests-close,
  body.mobile .quests-item {
    touch-action: manipulation !important;
    pointer-events: auto !important;
  }

  /* Ensure quest containers allow touch events */
  body.mobile .quests-container,
  body.mobile .quests-sidebar,
  body.mobile .quests-details-panel,
  body.mobile .quests-list,
  body.mobile .quests-section {
    touch-action: manipulation !important;
  }

  /* Override global mobile touch rules for interactive quest elements */
  body.mobile .quests-sidebar *:not(.quests-section-title):not(.quests-empty-section) {
    touch-action: manipulation !important;
  }


</style>


<!-- Included from: ./menus/merchant.html -->
<!-- Merchant UI -->
<div class="merchant-overlay">
  <div class="merchant-container">
    <div class="merchant-header">
      <div class="merchant-info">
        <img src="" alt="Merchant" class="merchant-avatar">
        <div class="merchant-details">
          <div class="merchant-name"></div>
          <div class="merchant-title"></div>
        </div>
      </div>
      <button class="merchant-close">×</button>
    </div>
    
    <div class="merchant-content">
      <!-- Main Merchant Grid -->
      <div class="merchant-grid-container">
        <div class="merchant-grid" id="merchant-grid">
          <!-- Grid slots will be generated by JavaScript -->
        </div>
      </div>
      
      <!-- Right Panel for future UI elements -->
      <div class="merchant-right-panel">
        <div class="merchant-panel-placeholder">
          <!-- Future UI elements like quantity selection, instructions, etc. -->
        </div>
      </div>
    </div>
  </div>
  
  <!-- Hotbar Container -->
  <div class="merchant-hotbar-container">
    <div class="merchant-hotbar-grid" id="merchant-hotbar-grid">
      <!-- Hotbar slots will be generated by JavaScript -->
    </div>
  </div>
</div>
<script>
  // Configuration
  const MERCHANT_CONFIG = {
    slots: 18,
    rowWidth: 6,
    hotbarSlots: 8,
    minRows: 3,
    maxBuyQuantity: 999
  };

  // State management
  const merchantState = {
    backpackItems: [],
    hotbarItems: [],
    currentMode: null,
    selectedItem: null,
    selectedQuantity: 1
  };

  // Setup hytopia data handlers
  hytopia.onData(data => {
    if (data.type === 'toggleMerchant') {
      toggleMerchant(data);
    }
    
    if (data.type === 'hotbarUpdate') {
      merchantState.hotbarItems[data.position] = data;
      if (merchantState.currentMode === 'sell') {
        updateHotbarSlot(data.position, data);
      }
    }
    
    if (data.type === 'backpackUpdate') {
      merchantState.backpackItems[data.position] = data;
      if (merchantState.currentMode === 'sell') {
        updateMerchantSlot(data.position, data);
      }
    }
    
    if (data.type === 'syncCoordinates') {
      updateCoordinates(data.x, data.y, data.z);
    }
  });

  // Initialize merchant system
  function initializeMerchant() {
    createMerchantSlots();
    createHotbarSlots();
    
    // Add close button handler
    const closeButton = document.querySelector('.merchant-close');
    if (closeButton) {
      closeButton.addEventListener('click', () => toggleMerchant(null));
    }
    
    // Setup keyboard shortcuts
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        if (merchantState.selectedItem) {
          clearSelection();
        }
      }
      
      // Keyboard shortcuts for quantity adjustment
      if (merchantState.selectedItem && merchantState.currentMode) {
        if (e.key === 'ArrowUp' || e.key === '+') {
          e.preventDefault();
          changeQuantity(1);
        } else if (e.key === 'ArrowDown' || e.key === '-') {
          e.preventDefault();
          changeQuantity(-1);
        } else if (e.key === 'Enter') {
          e.preventDefault();
          confirmAction();
        } else if (e.key === 'm' || e.key === 'M') {
          e.preventDefault();
          setQuantityToMax();
        } else if ((e.key === 'a' || e.key === 'A') && merchantState.currentMode === 'sell') {
          e.preventDefault();
          sellAllItems();
        }
      }
    });
  }

  function createMerchantSlots() {
    const grid = document.getElementById('merchant-grid');
    grid.innerHTML = '';
    
    for (let i = 0; i < MERCHANT_CONFIG.slots; i++) {
      const slot = document.createElement('div');
      slot.className = 'merchant-slot';
      slot.dataset.slotIndex = i;
      slot.innerHTML = '<div class="merchant-slot-content"></div>';
      grid.appendChild(slot);
    }
  }

  function createHotbarSlots() {
    const grid = document.getElementById('merchant-hotbar-grid');
    grid.innerHTML = '';
    
    for (let i = 0; i < MERCHANT_CONFIG.hotbarSlots; i++) {
      const slot = document.createElement('div');
      slot.className = 'merchant-hotbar-slot';
      slot.dataset.hotbarIndex = i;
      slot.innerHTML = `<div class="merchant-hotbar-slot-content">${i + 1}</div>`;
      grid.appendChild(slot);
    }
  }

  // Use shared tooltip system
  function createTooltip(slot, itemData) {
    const options = {
      tooltipClass: 'merchant-item-tooltip',
      contentClass: 'merchant-item-tooltip-content'
    };
    
    // Configure price display based on merchant mode
    if (merchantState.currentMode === 'buy') {
      options.showBuyPrice = true;
      options.showSellPrice = false;
      // Use sellPrice as buyPrice for display (sellPrice contains the buy price data)
      if (itemData.sellPrice !== undefined) {
        itemData.buyPrice = itemData.sellPrice;
      }
    } else {
      options.showBuyPrice = false;
      options.showSellPrice = true;
    }
    
    ItemTooltips.createTooltip(slot, itemData, options);
  }

  function removeTooltip(slot) {
    ItemTooltips.removeTooltip(slot, 'merchant-item-tooltip');
  }

  function createItemContent(content, itemData, config) {
    // Create item icon
    const icon = document.createElement('img');
    icon.src = `{{CDN_ASSETS_URL}}/${itemData.iconImageUri}`;
    icon.alt = 'Item';
    icon.className = config.iconClass;
    content.appendChild(icon);
    
    // Add quantity if greater than 1
    if (itemData.quantity && itemData.quantity > 1) {
      const quantity = document.createElement('div');
      quantity.className = config.quantityClass;
      quantity.textContent = itemData.quantity.toLocaleString();
      content.appendChild(quantity);
    }
  }

  // Slot update configurations
  const SLOT_CONFIGS = {
    hotbar: {
      selector: '.merchant-hotbar-slot',
      contentSelector: '.merchant-hotbar-slot-content',
      iconClass: 'merchant-hotbar-slot-icon',
      quantityClass: 'merchant-hotbar-slot-quantity',
      maxSlots: MERCHANT_CONFIG.hotbarSlots,
      showEmptyNumber: true
    },
    merchant: {
      selector: '.merchant-slot',
      contentSelector: '.merchant-slot-content',
      iconClass: 'merchant-item-icon',
      quantityClass: 'merchant-slot-quantity',
      maxSlots: MERCHANT_CONFIG.slots,
      showEmptyNumber: false
    }
  };

  // Generic slot update function
  function updateSlot(slotType, position, itemData) {
    const config = SLOT_CONFIGS[slotType];
    if (!config || position < 0 || position >= config.maxSlots) return;

    const slots = document.querySelectorAll(config.selector);
    const slot = slots[position];
    if (!slot) return;
    
    const content = slot.querySelector(config.contentSelector);
    if (!content) return;
    
    // Clear existing content and tooltip
    content.innerHTML = '';
    removeTooltip(slot);
    
    // Remove previous click handler
    slot.onclick = null;
    slot.classList.remove('merchant-slot-selected');
    
    if (itemData.removed) {
      // Show slot number for empty slots (hotbar only)
      if (config.showEmptyNumber) {
        content.textContent = position + 1;
      }
    } else {
      createItemContent(content, itemData, config);
      createTooltip(slot, itemData);
      
      // Determine correct sourceType - in sell mode, merchant grid shows backpack items
      const sourceType = (slotType === 'merchant' && merchantState.currentMode === 'sell') ? 'backpack' : slotType;
      
      // Add click handler for item selection
      slot.onclick = () => selectItem(itemData, sourceType, position);
    }
  }

  // Specific update functions
  function updateHotbarSlot(position, itemData) {
    updateSlot('hotbar', position, itemData);
  }

  function updateMerchantSlot(position, itemData) {
    updateSlot('merchant', position, itemData);
  }

  // Helper functions for merchant management
  function updateMerchantInfo(merchantName, merchantTitle, merchantAvatarUri, mode) {
    const avatar = document.querySelector('.merchant-avatar');
    const name = document.querySelector('.merchant-name');
    const title = document.querySelector('.merchant-title');
    
    if (avatar && merchantAvatarUri) {
      avatar.src = `{{CDN_ASSETS_URL}}/${merchantAvatarUri}`;
    }
    if (name) {
      const baseName = merchantName || 'Merchant';
      const modeText = mode === 'buy' ? 'Buying From: ' : 'Selling To: ';
      name.textContent = modeText + baseName;
    }
    if (title) {
      title.textContent = merchantTitle || '';
    }
  }

  function setMerchantVisibility(visible) {
    const overlay = document.querySelector('.merchant-overlay');
    if (overlay) {
      overlay.style.display = visible ? 'flex' : 'none';
    }
  }

  function setHotbarVisibility(visible) {
    const hotbarContainer = document.querySelector('.merchant-hotbar-container');
    if (hotbarContainer) {
      hotbarContainer.style.display = visible ? 'block' : 'none';
    }
  }

  function updateMerchantGrid(rows) {
    MERCHANT_CONFIG.slots = rows * MERCHANT_CONFIG.rowWidth;
    createMerchantSlots();
    
    const merchantGrid = document.getElementById('merchant-grid');
    if (merchantGrid) {
      merchantGrid.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
    }
  }

  function populateSlots(items, maxSlots, updateFunction) {
    for (let i = 0; i < maxSlots; i++) {
      const item = items[i];
      updateFunction(i, item || { removed: true });
    }
  }

  function calculateRequiredRows(buyableItems) {
    if (!buyableItems || buyableItems.length === 0) return MERCHANT_CONFIG.minRows;
    
    const positions = buyableItems
      .map(item => item.position)
      .filter(pos => typeof pos === 'number');
    
    if (positions.length === 0) return MERCHANT_CONFIG.minRows;
    
    const maxPosition = Math.max(17, Math.max(...positions)); // At least 18 slots (0-17)
    return Math.ceil((maxPosition + 1) / MERCHANT_CONFIG.rowWidth);
  }

  function populateBuyableItems(buyableItems) {
    if (!buyableItems || buyableItems.length === 0) return;
    
    buyableItems.forEach(item => {
      if (typeof item.position === 'number' && 
          item.position >= 0 && 
          item.position < MERCHANT_CONFIG.slots) {
        
        const itemData = {
          ...item,
          sellPrice: item.buyPrice // Use price as sell value for tooltip
        };
        updateMerchantSlot(item.position, itemData);
      }
    });
  }

  function updateRightPanelContent() {
    const placeholder = document.querySelector('.merchant-panel-placeholder');
    if (!placeholder) return;
    
    if (merchantState.selectedItem) {
      renderItemDetails();
    } else if (merchantState.currentMode === 'buy') {
      placeholder.innerHTML = `
        <div style="text-align: center; line-height: 1.6;">
          <div>Click an item to select it, then choose quantity to buy.</div>
          <div style="font-size: 12px; color: #888; margin-top: 8px;">
            Keyboard: ↑/↓ or +/- to adjust quantity, Enter to confirm
          </div>
        </div>
      `;
    } else if (merchantState.currentMode === 'sell') {
      placeholder.innerHTML = `
        <div style="text-align: center; line-height: 1.6;">
          <div>Click an item to select it, or drag items between inventories.</div>
          <div style="font-size: 12px; color: #888; margin-top: 8px;">
            Keyboard: ↑/↓ or +/- to adjust, M for max, A to sell all, Enter to confirm
          </div>
        </div>
      `;
    } else {
      placeholder.textContent = '';
    }
  }

  function selectItem(itemData, sourceType, sourceIndex) {
    // Clear previous selection highlighting
    document.querySelectorAll('.merchant-slot-selected').forEach(slot => {
      slot.classList.remove('merchant-slot-selected');
    });
    
    merchantState.selectedItem = {
      ...itemData,
      sourceType,
      sourceIndex
    };
    merchantState.selectedQuantity = 1;
    
    // Highlight the selected slot
    const config = SLOT_CONFIGS[sourceType];
    if (config) {
      const slots = document.querySelectorAll(config.selector);
      const selectedSlot = slots[sourceIndex];
      if (selectedSlot) {
        selectedSlot.classList.add('merchant-slot-selected');
      }
    }
    
    updateRightPanelContent();
  }

  function clearSelection() {
    // Clear previous selection highlighting
    document.querySelectorAll('.merchant-slot-selected').forEach(slot => {
      slot.classList.remove('merchant-slot-selected');
    });
    
    merchantState.selectedItem = null;
    merchantState.selectedQuantity = 1;
    updateRightPanelContent();
  }

  function renderItemDetails() {
    const placeholder = document.querySelector('.merchant-panel-placeholder');
    if (!placeholder || !merchantState.selectedItem) return;

    const maxQuantity = merchantState.currentMode === 'sell' 
      ? (merchantState.selectedItem.quantity || 1) 
      : MERCHANT_CONFIG.maxBuyQuantity;
    const price = merchantState.selectedItem.buyPrice || merchantState.selectedItem.sellPrice || 0;
    const actionLabel = merchantState.currentMode === 'buy' ? 'Buy' : 'Sell';
    
    const totalDisplay = price > 0 
      ? `${(price * merchantState.selectedQuantity).toLocaleString()} gold`
      : (merchantState.currentMode === 'buy' ? 'Not Buyable' : 'Not Sellable');

    placeholder.innerHTML = `
      <div class="merchant-item-details">
        <div class="merchant-item-header">
          <img src="{{CDN_ASSETS_URL}}/${merchantState.selectedItem.iconImageUri}" alt="${merchantState.selectedItem.name}" class="merchant-item-icon">
          <div class="merchant-item-info">
            <div class="merchant-item-name">${merchantState.selectedItem.name}</div>
            <div class="merchant-item-total">${totalDisplay}</div>
          </div>
        </div>
        <div class="merchant-item-actions">
          <div class="merchant-quantity-controls">
            <button class="merchant-qty-btn merchant-qty-decrease">-</button>
            <span class="merchant-qty-display">${merchantState.selectedQuantity}</span>
            <button class="merchant-qty-btn merchant-qty-increase">+</button>
            ${merchantState.currentMode === 'sell' && maxQuantity > 1 ? 
              `<button class="merchant-qty-btn merchant-qty-max" title="Set to maximum quantity (M)">MAX</button>` : 
              ''}
          </div>
          <div class="merchant-action-buttons">
            <button class="merchant-action-btn merchant-confirm-action" title="Confirm transaction (Enter)" ${price === 0 ? 'disabled' : ''}>${actionLabel}</button>
            ${merchantState.currentMode === 'sell' && maxQuantity > 1 ? 
              `<button class="merchant-action-btn merchant-sell-all-btn" title="Sell all of this item (A)" ${price === 0 ? 'disabled' : ''}>Sell All</button>` : 
              ''}
          </div>
        </div>
      </div>
    `;

    // Add event listeners
    const decreaseBtn = placeholder.querySelector('.merchant-qty-decrease');
    const increaseBtn = placeholder.querySelector('.merchant-qty-increase');
    const maxBtn = placeholder.querySelector('.merchant-qty-max');
    const confirmBtn = placeholder.querySelector('.merchant-confirm-action');
    const sellAllBtn = placeholder.querySelector('.merchant-sell-all-btn');

    if (decreaseBtn) {
      decreaseBtn.addEventListener('click', () => changeQuantity(-1));
    }
    
    if (increaseBtn) {
      increaseBtn.addEventListener('click', () => changeQuantity(1));
    }

    if (maxBtn) {
      maxBtn.addEventListener('click', () => setQuantityToMax());
    }

    if (confirmBtn && price > 0) {
      confirmBtn.addEventListener('click', confirmAction);
    }

    if (sellAllBtn && price > 0) {
      sellAllBtn.addEventListener('click', sellAllItems);
    }
  }

  function changeQuantity(delta) {
    const maxQuantity = merchantState.currentMode === 'sell' 
      ? (merchantState.selectedItem.quantity || 1) 
      : MERCHANT_CONFIG.maxBuyQuantity;
    merchantState.selectedQuantity = Math.max(1, Math.min(maxQuantity, merchantState.selectedQuantity + delta));
    renderItemDetails();
  }

  function setQuantityToMax() {
    const maxQuantity = merchantState.currentMode === 'sell' 
      ? (merchantState.selectedItem.quantity || 1) 
      : MERCHANT_CONFIG.maxBuyQuantity;
    merchantState.selectedQuantity = maxQuantity;
    renderItemDetails();
  }

  function sellAllItems() {
    if (!merchantState.selectedItem || merchantState.currentMode !== 'sell') return;
    
    const actionData = {
      type: 'sellItem',
      quantity: merchantState.selectedItem.quantity || 1, // Sell all available
      sourceType: merchantState.selectedItem.sourceType,
      sourceIndex: merchantState.selectedItem.sourceIndex
    };
    
    console.log('Selling all items:', actionData);
    hytopia.sendData(actionData);
    clearSelection();
  }

  function confirmAction() {
    if (!merchantState.selectedItem) return;
    
    const actionData = {
      type: merchantState.currentMode === 'buy' ? 'buyItem' : 'sellItem',
      quantity: merchantState.selectedQuantity,
      sourceType: merchantState.selectedItem.sourceType,
      sourceIndex: merchantState.selectedItem.sourceIndex
    };
    console.log(actionData);
    hytopia.sendData(actionData);
    clearSelection();
  }

  function toggleMerchant(data) {
    if (!data) {
      setMerchantVisibility(false);
      merchantState.currentMode = null;
      clearSelection();
      hytopia.lockPointer(true);
      return;
    }

    const { mode, buyableItems, merchantName, merchantTitle, merchantAvatarUri } = data;
    merchantState.currentMode = mode;
    clearSelection(); // Clear selection when switching modes
    
    // Update merchant info
    updateMerchantInfo(merchantName, merchantTitle, merchantAvatarUri, mode);
    
    setMerchantVisibility(true);

    if (mode === 'buy') {
      setHotbarVisibility(false);

      const requiredRows = calculateRequiredRows(buyableItems);
      updateMerchantGrid(requiredRows);
      populateBuyableItems(buyableItems);
      hytopia.lockPointer(false, true);
    } else if (mode === 'sell') {
      setHotbarVisibility(true);
      
      updateMerchantGrid(3); // 3 rows for sell mode (18 slots total)
      populateSlots(merchantState.backpackItems, MERCHANT_CONFIG.slots, updateMerchantSlot);
      populateSlots(merchantState.hotbarItems, MERCHANT_CONFIG.hotbarSlots, updateHotbarSlot);
      hytopia.lockPointer(false, true);
    }
  }

  function updateCoordinates(x, y, z) {
    const el = document.getElementById('hud-coordinates');
    if (!el) return;
    const rx = Math.round(x);
    const ry = Math.round(y);
    const rz = Math.round(z);
    el.textContent = `X: ${rx} Y: ${ry} Z: ${rz}`;
  }

  // Initialize on load
  initializeMerchant();
</script>
<style>
  :root {
    --merchant-slot-size: 56px;
    --merchant-hotbar-size: 64px;
    --merchant-icon-size: 32px;
    --merchant-gap: 6px;
    --merchant-padding: 12px;
    --merchant-font: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    
    /* Color palette */
    --merchant-bg-primary: linear-gradient(145deg, #2a2a2a, #1e1e1e);
    --merchant-bg-secondary: linear-gradient(135deg, #3a3a3a, #2d2d2d);
    --merchant-border: #444;
    --merchant-border-light: #555;
    --merchant-text: #ffffff;
    --merchant-text-muted: #cccccc;
    --merchant-text-dim: #888;
    --merchant-overlay: rgba(0, 0, 0, 0.3);
    --merchant-shadow: 0 8px 32px rgba(0, 0, 0, 0.9);
    --merchant-shadow-inset: inset 0 2px 8px rgba(0, 0, 0, 0.5);
  }

  .merchant-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.8);
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    font-family: var(--merchant-font);
    user-select: none;
    gap: 16px;
  }

  /* Shared container styles */
  .merchant-container,
  .merchant-hotbar-container {
    background: var(--merchant-bg-primary);
    border: 2px solid var(--merchant-border);
    border-radius: 12px;
    box-shadow: var(--merchant-shadow), inset 0 1px 0 rgba(255, 255, 255, 0.1);
    width: 680px;
  }

  /* Header styles */
  .merchant-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    background: var(--merchant-bg-secondary);
    border-bottom: 1px solid var(--merchant-border);
  }

  .merchant-info {
    display: flex;
    align-items: center;
    gap: 12px;
    flex: 1;
    min-width: 0;
  }

  .merchant-avatar {
    width: 48px;
    height: 48px;
    border: 2px solid var(--merchant-border);
    border-radius: 6px;
    object-fit: cover;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.6);
    flex-shrink: 0;
  }

  .merchant-details {
    display: flex;
    flex-direction: column;
    min-width: 0;
    flex: 1;
  }

  .merchant-name {
    font-size: 16px;
    font-weight: 600;
    color: var(--merchant-text);
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.9);
    line-height: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .merchant-title {
    font-size: 14px;
    font-weight: 500;
    color: var(--merchant-text-muted);
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.9);
    margin-top: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    letter-spacing: 0.3px;
  }

  .merchant-close {
    background: rgba(255, 0, 0, 0.2);
    border: 1px solid rgba(255, 0, 0, 0.3);
    border-radius: 6px;
    color: #ff6b6b;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .merchant-close:hover {
    background: rgba(255, 0, 0, 0.3);
    transform: scale(1.05);
  }

  /* Layout */
  .merchant-content {
    padding: 20px;
    display: flex;
    gap: 20px;
    align-items: flex-start;
  }

  .merchant-grid-container {
    flex: 1;
  }

  .merchant-right-panel {
    flex: 1;
    background: var(--merchant-overlay);
    border: 1px solid var(--merchant-border);
    border-radius: 8px;
    padding: var(--merchant-padding);
    min-height: 192px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .merchant-panel-placeholder {
    color: #666;
    font-size: 14px;
    text-align: center;
    line-height: 1.5;
  }

  /* Item Details Panel */
  .merchant-item-details {
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .merchant-item-header {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
  }

  .merchant-item-actions {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 16px;
  }

  .merchant-item-icon {
    width: 32px;
    height: 32px;
    object-fit: contain;
    image-rendering: pixelated;
    border-radius: 4px;
    background: rgba(0, 0, 0, 0.4);
    padding: 2px;
  }

  .merchant-item-info {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
    width: 100%;
  }

  .merchant-item-name {
    font-size: 12px;
    font-weight: 500;
    color: var(--merchant-text);
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.9);
    text-align: center;
    width: 100%;
    line-height: 1.2;
  }

  .merchant-item-total {
    font-size: 11px;
    font-weight: 600;
    color: #ffd700;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.9);
  }

  .merchant-quantity-controls {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .merchant-qty-btn {
    width: 32px;
    height: 32px;
    background: var(--merchant-bg-secondary);
    border: 1px solid var(--merchant-border);
    border-radius: 3px;
    color: var(--merchant-text);
    font-size: 12px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .merchant-qty-btn:hover {
    background: var(--merchant-border);
  }

  .merchant-qty-display {
    font-size: 12px;
    font-weight: 600;
    color: var(--merchant-text);
    min-width: 20px;
    text-align: center;
  }

  .merchant-action-btn {
    padding: 8px 16px;
    border: 1px solid #4CAF50;
    border-radius: 4px;
    background: rgba(76, 175, 80, 0.2);
    color: #4CAF50;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }

  .merchant-action-btn:hover {
    background: rgba(76, 175, 80, 0.3);
    color: #66BB6A;
  }

  /* Additional button styles */
  .merchant-qty-max {
    width: auto !important;
    padding: 0 8px !important;
    font-size: 10px !important;
    background: rgba(255, 193, 7, 0.2) !important;
    border-color: rgba(255, 193, 7, 0.5) !important;
    color: #FFC107 !important;
  }

  .merchant-qty-max:hover {
    background: rgba(255, 193, 7, 0.3) !important;
    border-color: rgba(255, 193, 7, 0.7) !important;
  }

  .merchant-sell-all-btn {
    background: rgba(255, 152, 0, 0.2) !important;
    border-color: #FF9800 !important;
    color: #FF9800 !important;
  }

  .merchant-sell-all-btn:hover {
    background: rgba(255, 152, 0, 0.3) !important;
    color: #FFB74D !important;
  }

  .merchant-action-buttons {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
  }

  /* Disabled button styles */
  .merchant-qty-btn:disabled,
  .merchant-action-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none;
  }

  /* Selected slot styling */
  .merchant-slot-selected {
    border-color: #4CAF50 !important;
    background: rgba(76, 175, 80, 0.1) !important;
    box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.3) !important;
  }

  /* Grid styles */
  .merchant-grid,
  .merchant-hotbar-grid {
    display: grid;
    gap: var(--merchant-gap);
    background: var(--merchant-overlay);
    padding: var(--merchant-padding);
    border: 1px solid var(--merchant-border);
    border-radius: 8px;
    box-shadow: var(--merchant-shadow-inset);
  }

  .merchant-grid {
    grid-template: repeat(3, 1fr) / repeat(6, 1fr);
  }

  .merchant-hotbar-grid {
    grid-template-columns: repeat(8, 1fr);
    padding: 16px;
    gap: 8px;
  }

  /* Slot styles */
  .merchant-slot,
  .merchant-hotbar-slot {
    background: rgba(0, 0, 0, 0.6);
    border: 2px solid #333;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.7);
    transition: all 0.2s ease;
    cursor: pointer;
  }

  .merchant-slot {
    width: var(--merchant-slot-size);
    height: var(--merchant-slot-size);
  }

  .merchant-hotbar-slot {
    width: var(--merchant-hotbar-size);
    height: var(--merchant-hotbar-size);
  }

  /* Hover states */
  .merchant-slot:hover,
  .merchant-hotbar-slot:hover {
    border-color: var(--merchant-border-light);
    background: rgba(0, 0, 0, 0.8);
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.7), 0 2px 8px rgba(0, 0, 0, 0.5);
    transform: translateY(-1px);
  }

  /* Content styles */
  .merchant-slot-content,
  .merchant-hotbar-slot-content {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    color: var(--merchant-text-muted);
  }

  .merchant-hotbar-slot-content {
    font-size: 14px;
    font-weight: 600;
    color: var(--merchant-text-dim);
  }

  /* Item icons */
  .merchant-item-icon,
  .merchant-hotbar-slot-icon {
    object-fit: contain;
    image-rendering: pixelated;
    filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.8));
  }

  .merchant-item-icon {
    width: 48px;
    height: 48px;
  }

  .merchant-hotbar-slot-icon {
    width: 56px;
    height: 56px;
  }

  /* Quantity badges */
  .merchant-slot-quantity,
  .merchant-hotbar-slot-quantity {
    position: absolute;
    bottom: 2px;
    right: 2px;
    background: rgba(0, 0, 0, 0.8);
    color: var(--merchant-text);
    font-weight: 700;
    padding: 1px 3px;
    border-radius: 3px;
    line-height: 1;
    text-shadow: 0 1px 1px rgba(0, 0, 0, 0.9);
    border: 1px solid rgba(255, 255, 255, 0.2);
    min-width: 10px;
    text-align: center;
  }

  .merchant-slot-quantity {
    font-size: 9px;
  }

  .merchant-hotbar-slot-quantity {
    font-size: 10px;
    padding: 1px 4px;
    min-width: 12px;
  }

  /* Merchant-specific tooltip positioning (content handled by shared system) */
  .merchant-item-tooltip {
    position: absolute;
    bottom: 100%;
    left: 50%;
    margin-bottom: 8px;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    z-index: 2000;
    pointer-events: none;
  }

  /* Item rarity colors */
  .merchant-slot.merchant-common,
  .merchant-hotbar-slot.merchant-common { border-color: #9CA3AF; }
  .merchant-slot.merchant-uncommon,
  .merchant-hotbar-slot.merchant-uncommon { border-color: #22C55E; }
  .merchant-slot.merchant-rare,
  .merchant-hotbar-slot.merchant-rare { border-color: #3B82F6; }
  .merchant-slot.merchant-epic,
  .merchant-hotbar-slot.merchant-epic { border-color: #A855F7; }
  .merchant-slot.merchant-legendary,
  .merchant-hotbar-slot.merchant-legendary { border-color: #F59E0B; }

  /* Mobile styles */
  body.mobile {
    --merchant-slot-size: 44px;
    --merchant-hotbar-size: 44px;
    --merchant-icon-size: 32px;
    --merchant-gap: 4px;
    --merchant-padding: 8px;
  }

  body.mobile .merchant-overlay {
    gap: 12px;
    padding: 8px;
  }

  body.mobile .merchant-container,
  body.mobile .merchant-hotbar-container {
    width: auto;
    max-width: 560px;
    min-width: 340px;
    border-radius: 8px;
  }

  body.mobile .merchant-header {
    padding: 8px 12px;
    border-radius: 8px 8px 0 0;
  }

  body.mobile .merchant-info {
    gap: 8px;
  }

  body.mobile .merchant-avatar {
    width: 32px;
    height: 32px;
  }

  body.mobile .merchant-name {
    font-size: 14px;
  }

  body.mobile .merchant-title {
    font-size: 12px;
  }

  body.mobile .merchant-close {
    width: 24px;
    height: 24px;
    font-size: 16px;
  }

  body.mobile .merchant-content {
    padding: 12px;
    gap: 12px;
  }

  body.mobile .merchant-grid,
  body.mobile .merchant-hotbar-grid {
    padding: 8px;
    border-radius: 6px;
  }

  body.mobile .merchant-hotbar-grid {
    justify-items: center;
    width: fit-content;
    margin: 0 auto;
    padding: 12px;
    border-radius: 0 0 6px 6px;
  }

  body.mobile .merchant-right-panel {
    padding: 8px;
    border-radius: 6px;
    flex: 0 0 184px;
    min-width: 184px;
    box-sizing: border-box;
  }

  body.mobile .merchant-panel-placeholder {
    font-size: 12px;
  }

  body.mobile .merchant-slot-content,
  body.mobile .merchant-hotbar-slot-content {
    font-size: 10px;
  }

  body.mobile .merchant-item-icon {
    width: 36px;
    height: 36px;
  }

  body.mobile .merchant-hotbar-slot-icon {
    width: 36px;
    height: 36px;
  }

  body.mobile .merchant-slot-quantity {
    font-size: 8px;
    padding: 1px 3px;
    bottom: 2px;
    right: 2px;
    min-width: 10px;
    border-radius: 3px;
  }

  body.mobile .merchant-hotbar-slot-quantity {
    font-size: 8px;
    padding: 1px 3px;
    bottom: 2px;
    right: 2px;
    min-width: 12px;
    border-radius: 3px;
  }



  /* Mobile item details */
  body.mobile .merchant-item-details {
    min-width: 180px;
    gap: 8px;
  }

  body.mobile .merchant-item-header {
    gap: 6px;
  }

  body.mobile .merchant-item-actions {
    gap: 12px;
  }

  body.mobile .merchant-qty-btn {
    width: 24px;
    height: 24px;
    font-size: 12px;
  }

  body.mobile .merchant-qty-display {
    font-size: 12px;
    min-width: 20px;
  }

  body.mobile .merchant-action-btn {
    padding: 8px 16px;
    font-size: 12px;
  }

  /* Button styles */
  .merchant-close,
  .merchant-qty-btn,
  .merchant-action-btn {
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    border-radius: 4px;
  }

  .merchant-close {
    background: rgba(255, 0, 0, 0.2);
    border: 1px solid rgba(255, 0, 0, 0.3);
    border-radius: 6px;
    color: #ff6b6b;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .merchant-close:hover {
    background: rgba(255, 0, 0, 0.3);
    transform: scale(1.05);
  }

  .merchant-qty-btn {
    width: 32px;
    height: 32px;
    background: var(--merchant-bg-secondary);
    border: 1px solid var(--merchant-border);
    border-radius: 3px;
    color: var(--merchant-text);
    font-size: 12px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .merchant-qty-btn:hover {
    background: var(--merchant-border);
  }

  .merchant-qty-display {
    font-size: 12px;
    font-weight: 600;
    color: var(--merchant-text);
    min-width: 20px;
    text-align: center;
  }

  .merchant-action-btn {
    padding: 8px 16px;
    border: 1px solid #4CAF50;
    background: rgba(76, 175, 80, 0.2);
    color: #4CAF50;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }

  .merchant-action-btn:hover {
    background: rgba(76, 175, 80, 0.3);
    color: #66BB6A;
  }
</style>

<!-- Included from: ./menus/crafting.html -->
<!-- Crafting UI -->
<div class="crafting-overlay">
  <div class="crafting-container">
    <div class="crafting-header">
      <div class="crafting-info">
        <img src="" alt="Crafter" class="crafting-avatar">
        <div class="crafting-details">
          <div class="crafting-name"></div>
          <div class="crafting-title"></div>
        </div>
      </div>
      <button class="crafting-close">×</button>
    </div>
    
    <div class="crafting-content">
      <!-- Left Panel - Craftable Items Grid -->
      <div class="crafting-grid-container">
        <div class="crafting-grid" id="crafting-grid">
          <!-- Grid slots will be generated by JavaScript -->
        </div>
      </div>
      
      <!-- Right Panel - Crafting Details & Requirements -->
      <div class="crafting-right-panel">
        <div class="crafting-panel-content">
          <div class="crafting-placeholder">
            Select an item to view its requirements and craft it.
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  // Configuration
  const CRAFTING_CONFIG = {
    slots: 12,
    rowWidth: 4,
    minRows: 3
  };

  // State management
  const craftingState = {
    craftingRecipes: [],
    selectedRecipe: null,
    selectedQuantity: 1
  };

  // Setup hytopia data handlers
  hytopia.onData(data => {
    if (data.type === 'toggleCrafting') {
      toggleCrafting(data);
    }
  });

  // Initialize crafting system
  function initializeCrafting() {
    createCraftingSlots();
    
    // Add close button handler
    const closeButton = document.querySelector('.crafting-close');
    if (closeButton) {
      closeButton.addEventListener('click', () => toggleCrafting(null));
    }
    
    // Setup keyboard shortcuts
    document.addEventListener('keydown', e => {
      // Only handle if crafting is open and we have a selected recipe
      if (craftingState.selectedRecipe) {
        if (e.key === 'Escape') {
          clearSelection();
        } else if (e.key === 'ArrowUp' || e.key === '+') {
          e.preventDefault();
          changeCraftingQuantity(1);
        } else if (e.key === 'ArrowDown' || e.key === '-') {
          e.preventDefault();
          changeCraftingQuantity(-1);
        } else if (e.key === 'Enter') {
          e.preventDefault();
          confirmCrafting();
        } else if (e.key === 'm' || e.key === 'M') {
          e.preventDefault();
          setCraftingQuantityToMax();
        } else if (e.key === 'a' || e.key === 'A') {
          e.preventDefault();
          craftAllItems();
        }
      }
    });
  }

  function createCraftingSlots() {
    const grid = document.getElementById('crafting-grid');
    grid.innerHTML = '';
    
    for (let i = 0; i < CRAFTING_CONFIG.slots; i++) {
      const slot = document.createElement('div');
      slot.className = 'crafting-slot';
      slot.dataset.slotIndex = i;
      slot.innerHTML = '<div class="crafting-slot-content"></div>';
      grid.appendChild(slot);
    }
  }

  // Use shared tooltip system
  function createTooltip(slot, itemData) {
    const options = {
      tooltipClass: 'crafting-item-tooltip',
      contentClass: 'crafting-item-tooltip-content',
      showBuyPrice: false,
      showSellPrice: false,
      showCraftable: true
    };
    
    ItemTooltips.createTooltip(slot, itemData, options);
  }

  function removeTooltip(slot) {
    ItemTooltips.removeTooltip(slot, 'crafting-item-tooltip');
  }

  // Create tooltip for requirement items
  function createRequirementTooltip(item, requirementData) {
    const options = {
      tooltipClass: 'crafting-requirement-tooltip',
      contentClass: 'crafting-requirement-tooltip-content',
      showBuyPrice: false,
      showSellPrice: false
    };
    
    ItemTooltips.createTooltip(item, requirementData, options);
  }

  function removeRequirementTooltip(item) {
    ItemTooltips.removeTooltip(item, 'crafting-requirement-tooltip');
  }

  function createItemContent(content, itemData) {
    // Create item icon
    const icon = document.createElement('img');
    icon.src = `{{CDN_ASSETS_URL}}/${itemData.iconImageUri}`;
    icon.alt = 'Item';
    icon.className = 'crafting-item-icon';
    content.appendChild(icon);
    
    // Add quantity if greater than 1
    if (itemData.quantity && itemData.quantity > 1) {
      const quantity = document.createElement('div');
      quantity.className = 'crafting-slot-quantity';
      quantity.textContent = itemData.quantity.toLocaleString();
      content.appendChild(quantity);
    }
  }

  // Slot update functions
  function updateCraftingSlot(position, recipeData) {
    if (position < 0 || position >= CRAFTING_CONFIG.slots) return;

    const slots = document.querySelectorAll('.crafting-slot');
    const slot = slots[position];
    if (!slot) return;
    
    const content = slot.querySelector('.crafting-slot-content');
    if (!content) return;
    
    // Clear existing content and tooltip
    content.innerHTML = '';
    removeTooltip(slot);
    
    // Remove previous click handler
    slot.onclick = null;
    slot.classList.remove('crafting-slot-selected');
    
    if (!recipeData || recipeData.removed) {
      // Empty slot
      return;
    }

    const craftedItem = recipeData.craftedItem;
    createItemContent(content, craftedItem);
    createTooltip(slot, craftedItem);
    
    // Add click handler for recipe selection
    slot.onclick = () => selectCraftingRecipe(recipeData, position);
  }

  // Helper functions for crafting management
  function updateCrafterInfo(crafterName, crafterTitle, crafterAvatarUri) {
    const avatar = document.querySelector('.crafting-avatar');
    const name = document.querySelector('.crafting-name');
    const title = document.querySelector('.crafting-title');
    
    if (avatar && crafterAvatarUri) {
      avatar.src = `{{CDN_ASSETS_URL}}/${crafterAvatarUri}`;
    }
    if (name) {
      name.textContent = crafterName || 'Crafter';
    }
    if (title) {
      title.textContent = crafterTitle || '';
    }
  }

  function setCraftingVisibility(visible) {
    const overlay = document.querySelector('.crafting-overlay');
    if (overlay) {
      overlay.style.display = visible ? 'flex' : 'none';
    }
  }

  function updateCraftingGrid(rows) {
    CRAFTING_CONFIG.slots = rows * CRAFTING_CONFIG.rowWidth;
    createCraftingSlots();
    
    const craftingGrid = document.getElementById('crafting-grid');
    if (craftingGrid) {
      craftingGrid.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
    }
  }

  function populateSlots(items, maxSlots, updateFunction) {
    for (let i = 0; i < maxSlots; i++) {
      const item = items[i];
      updateFunction(i, item || { removed: true });
    }
  }

  function calculateRequiredRows(craftingRecipes) {
    if (!craftingRecipes || craftingRecipes.length === 0) return CRAFTING_CONFIG.minRows;
    
    const positions = craftingRecipes
      .map(recipe => recipe.position)
      .filter(pos => typeof pos === 'number');
    
    if (positions.length === 0) return CRAFTING_CONFIG.minRows;
    
    const maxPosition = Math.max(11, Math.max(...positions)); // At least 12 slots (0-11)
    return Math.ceil((maxPosition + 1) / CRAFTING_CONFIG.rowWidth);
  }

  function populateCraftingRecipes(craftingRecipes) {
    if (!craftingRecipes || craftingRecipes.length === 0) return;
    
    craftingRecipes.forEach(recipe => {
      if (typeof recipe.position === 'number' && 
          recipe.position >= 0 && 
          recipe.position < CRAFTING_CONFIG.slots) {
        updateCraftingSlot(recipe.position, recipe);
      }
    });
  }

  function updateRightPanelContent() {
    const placeholder = document.querySelector('.crafting-panel-content');
    if (!placeholder) return;
    
    if (craftingState.selectedRecipe) {
      renderCraftingDetails();
    } else {
      placeholder.innerHTML = `
        <div class="crafting-placeholder">
          <div>Select a craftable item to view its requirements and craft it.</div>
          <div style="font-size: 12px; color: #888; margin-top: 8px;">
            Keyboard: ↑/↓ or +/- to adjust quantity, M for max, A to craft all, Enter to confirm
          </div>
        </div>
      `;
    }
  }

  function selectCraftingRecipe(recipeData, position) {
    // Clear previous selection highlighting
    document.querySelectorAll('.crafting-slot-selected').forEach(slot => {
      slot.classList.remove('crafting-slot-selected');
    });
    
    craftingState.selectedRecipe = {
      ...recipeData,
      position
    };
    craftingState.selectedQuantity = 1; // Reset quantity when selecting new recipe
    
    // Highlight the selected slot
    const slots = document.querySelectorAll('.crafting-slot');
    const selectedSlot = slots[position];
    if (selectedSlot) {
      selectedSlot.classList.add('crafting-slot-selected');
    }
    
    updateRightPanelContent();
  }

  function clearSelection() {
    // Clear previous selection highlighting
    document.querySelectorAll('.crafting-slot-selected').forEach(slot => {
      slot.classList.remove('crafting-slot-selected');
    });
    
    craftingState.selectedRecipe = null;
    craftingState.selectedQuantity = 1;
    updateRightPanelContent();
  }

  function renderCraftingDetails() {
    const placeholder = document.querySelector('.crafting-panel-content');
    if (!placeholder || !craftingState.selectedRecipe) return;

    // Clear any existing requirement tooltips
    const existingRequirements = placeholder.querySelectorAll('.crafting-requirement-item');
    existingRequirements.forEach(item => removeRequirementTooltip(item));

    const recipe = craftingState.selectedRecipe;
    const craftedItem = recipe.craftedItem;
    const requirements = recipe.requirements || [];
    
    // Generate item stats using the shared system
    const itemStatsHTML = window.ItemStats ? 
      window.ItemStats.generateItemStats(craftedItem, {
        includeDescription: true,
        includePricing: false,
        statsClass: 'crafting-item-stats',
        descriptionClass: 'crafting-item-description'
      }) : '';
    
    placeholder.innerHTML = `
      <div class="crafting-item-details">
        <div class="crafting-item-header">
          <img src="{{CDN_ASSETS_URL}}/${craftedItem.iconImageUri}" alt="${craftedItem.name}" class="crafting-item-icon">
          <div class="crafting-item-info">
            <div class="crafting-item-name">${craftedItem.name}</div>
            ${itemStatsHTML}
          </div>
        </div>
        
        <div class="crafting-requirements">
          <div class="crafting-requirements-title">Requirements:</div>
          <div class="crafting-requirements-list">
            ${requirements.length > 0 ? 
              requirements.map((req, index) => `
                <div class="crafting-requirement-item" data-requirement-index="${index}">
                  <img src="{{CDN_ASSETS_URL}}/${req.iconImageUri}" alt="${req.name}" class="crafting-requirement-icon">
                  <div class="crafting-requirement-info">
                    <div class="crafting-requirement-name">${req.name}</div>
                    <div class="crafting-requirement-quantity">x${req.quantity || 1}</div>
                  </div>
                </div>
              `).join('') : 
              '<div class="crafting-no-requirements">No materials required</div>'
            }
          </div>
        </div>
        
        <div class="crafting-item-actions">
          <div class="crafting-quantity-controls">
            <button class="crafting-qty-btn crafting-qty-decrease">-</button>
            <span class="crafting-qty-display">${craftingState.selectedQuantity}</span>
            <button class="crafting-qty-btn crafting-qty-increase">+</button>
            <button class="crafting-qty-btn crafting-qty-max" title="Set to maximum craftable (M)">MAX</button>
          </div>
          <div class="crafting-action-buttons">
            <button class="crafting-action-btn crafting-confirm-action" title="Craft selected quantity (Enter)">Craft ${craftingState.selectedQuantity > 1 ? craftingState.selectedQuantity : ''}</button>
            <button class="crafting-action-btn crafting-craft-all-btn" title="Craft all possible (A)">Craft All</button>
          </div>
        </div>
      </div>
    `;

    // Add event listeners
    const decreaseBtn = placeholder.querySelector('.crafting-qty-decrease');
    const increaseBtn = placeholder.querySelector('.crafting-qty-increase');
    const maxBtn = placeholder.querySelector('.crafting-qty-max');
    const confirmBtn = placeholder.querySelector('.crafting-confirm-action');
    const craftAllBtn = placeholder.querySelector('.crafting-craft-all-btn');

    if (decreaseBtn) {
      decreaseBtn.addEventListener('click', () => changeCraftingQuantity(-1));
    }
    
    if (increaseBtn) {
      increaseBtn.addEventListener('click', () => changeCraftingQuantity(1));
    }

    if (maxBtn) {
      maxBtn.addEventListener('click', () => setCraftingQuantityToMax());
    }

    if (confirmBtn) {
      confirmBtn.addEventListener('click', confirmCrafting);
    }

    if (craftAllBtn) {
      craftAllBtn.addEventListener('click', craftAllItems);
    }

    // Add tooltips to requirement items
    const requirementItems = placeholder.querySelectorAll('.crafting-requirement-item');
    requirementItems.forEach((item, index) => {
      if (requirements[index]) {
        createRequirementTooltip(item, requirements[index]);
      }
    });
  }

  function changeCraftingQuantity(delta) {
    const maxQuantity = calculateMaxCraftable();
    craftingState.selectedQuantity = Math.max(1, Math.min(maxQuantity, craftingState.selectedQuantity + delta));
    renderCraftingDetails();
  }

  function setCraftingQuantityToMax() {
    const maxQuantity = calculateMaxCraftable();
    craftingState.selectedQuantity = maxQuantity;
    renderCraftingDetails();
  }

  function calculateMaxCraftable() {
    if (!craftingState.selectedRecipe) return 1;
    
    const requirements = craftingState.selectedRecipe.requirements || [];
    if (requirements.length === 0) return 999; // No requirements, can craft many
    
    // For now, return a reasonable default. In a real game, this would check inventory
    // against requirements to determine how many can actually be crafted
    return 10;
  }

  function craftAllItems() {
    if (!craftingState.selectedRecipe) return;
    
    const maxQuantity = calculateMaxCraftable();
    
    const actionData = {
      type: 'craftItem',
      recipeIndex: craftingState.selectedRecipe.position,
      quantity: maxQuantity
    };

    console.log('Crafting all items:', actionData);
    hytopia.sendData(actionData);
    clearSelection();
  }

  function confirmCrafting() {
    if (!craftingState.selectedRecipe) return;
    
    const actionData = {
      type: 'craftItem',
      recipeIndex: craftingState.selectedRecipe.position,
      quantity: craftingState.selectedQuantity
    };

    console.log('Crafting items:', actionData);
    hytopia.sendData(actionData);
    clearSelection();
  }

  function toggleCrafting(data) {
    if (!data) {
      setCraftingVisibility(false);
      clearSelection();
      hytopia.lockPointer(true);
      return;
    }

    const { craftingRecipes, crafterName, crafterTitle, crafterAvatarUri } = data;
    craftingState.craftingRecipes = craftingRecipes || [];
    clearSelection(); // Clear selection when opening
    
    // Update crafter info
    updateCrafterInfo(crafterName, crafterTitle, crafterAvatarUri);
    
    setCraftingVisibility(true);

    const requiredRows = calculateRequiredRows(craftingRecipes);
    updateCraftingGrid(requiredRows);
    populateCraftingRecipes(craftingRecipes);
    
    hytopia.lockPointer(false, true);
  }

  // Initialize on load
  initializeCrafting();
</script>
<style>
  :root {
    --crafting-slot-size: 56px;
    --crafting-icon-size: 32px;
    --crafting-gap: 6px;
    --crafting-padding: 12px;
    --crafting-font: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    
    /* Color palette - matching merchant */
    --crafting-bg-primary: linear-gradient(145deg, #2a2a2a, #1e1e1e);
    --crafting-bg-secondary: linear-gradient(135deg, #3a3a3a, #2d2d2d);
    --crafting-border: #444;
    --crafting-border-light: #555;
    --crafting-text: #ffffff;
    --crafting-text-muted: #cccccc;
    --crafting-text-dim: #888;
    --crafting-overlay: rgba(0, 0, 0, 0.3);
    --crafting-shadow: 0 8px 32px rgba(0, 0, 0, 0.9);
    --crafting-shadow-inset: inset 0 2px 8px rgba(0, 0, 0, 0.5);
    --crafting-accent: #4CAF50;
    --crafting-accent-hover: #66BB6A;
  }

  .crafting-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.8);
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    font-family: var(--crafting-font);
    user-select: none;
  }

  /* Container styles */
  .crafting-container {
    background: var(--crafting-bg-primary);
    border: 2px solid var(--crafting-border);
    border-radius: 12px;
    box-shadow: var(--crafting-shadow), inset 0 1px 0 rgba(255, 255, 255, 0.1);
    width: 680px;
  }

  /* Header styles */
  .crafting-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    background: var(--crafting-bg-secondary);
    border-bottom: 1px solid var(--crafting-border);
  }

  .crafting-info {
    display: flex;
    align-items: center;
    gap: 12px;
    flex: 1;
    min-width: 0;
  }

  .crafting-avatar {
    width: 48px;
    height: 48px;
    border: 2px solid var(--crafting-border);
    border-radius: 6px;
    object-fit: cover;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.6);
    flex-shrink: 0;
  }

  .crafting-details {
    display: flex;
    flex-direction: column;
    min-width: 0;
    flex: 1;
  }

  .crafting-name {
    font-size: 16px;
    font-weight: 600;
    color: var(--crafting-text);
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.9);
    line-height: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .crafting-title {
    font-size: 14px;
    font-weight: 500;
    color: var(--crafting-text-muted);
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.9);
    margin-top: 2px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    letter-spacing: 0.3px;
  }

  .crafting-close {
    background: rgba(255, 0, 0, 0.2);
    border: 1px solid rgba(255, 0, 0, 0.3);
    border-radius: 6px;
    color: #ff6b6b;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .crafting-close:hover {
    background: rgba(255, 0, 0, 0.3);
    transform: scale(1.05);
  }

  /* Layout - 50/50 split */
  .crafting-content {
    padding: 20px;
    display: flex;
    gap: 20px;
    align-items: flex-start;
  }

  .crafting-grid-container {
    flex: 1;
  }

  .crafting-right-panel {
    flex: 1;
    background: var(--crafting-overlay);
    border: 1px solid var(--crafting-border);
    border-radius: 8px;
    padding: var(--crafting-padding);
    min-height: 192px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .crafting-panel-content {
    width: 100%;
  }

  .crafting-placeholder {
    color: #666;
    font-size: 14px;
    text-align: center;
    line-height: 1.5;
  }

  /* Grid styles */
  .crafting-grid {
    display: grid;
    grid-template: repeat(3, 1fr) / repeat(4, 1fr);
    gap: var(--crafting-gap);
    background: var(--crafting-overlay);
    padding: var(--crafting-padding);
    border: 1px solid var(--crafting-border);
    border-radius: 8px;
    box-shadow: var(--crafting-shadow-inset);
  }

  /* Slot styles */
  .crafting-slot {
    background: rgba(0, 0, 0, 0.6);
    border: 2px solid #333;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.7);
    transition: all 0.2s ease;
    cursor: pointer;
    width: var(--crafting-slot-size);
    height: var(--crafting-slot-size);
  }

  .crafting-slot:hover {
    border-color: var(--crafting-border-light);
    background: rgba(0, 0, 0, 0.8);
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.7), 0 2px 8px rgba(0, 0, 0, 0.5);
    transform: translateY(-1px);
  }

  .crafting-slot-selected {
    border-color: #4CAF50 !important;
    background: rgba(76, 175, 80, 0.1) !important;
    box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.3) !important;
  }

  .crafting-slot-content {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .crafting-item-icon {
    width: 48px;
    height: 48px;
    object-fit: contain;
    image-rendering: pixelated;
    filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.8));
  }

  /* Quantity badges */
  .crafting-slot-quantity {
    position: absolute;
    bottom: 2px;
    right: 2px;
    background: rgba(0, 0, 0, 0.8);
    color: var(--crafting-text);
    font-weight: 700;
    padding: 1px 3px;
    border-radius: 3px;
    line-height: 1;
    text-shadow: 0 1px 1px rgba(0, 0, 0, 0.9);
    border: 1px solid rgba(255, 255, 255, 0.2);
    min-width: 10px;
    text-align: center;
    font-size: 9px;
  }

  /* Item Details Panel */
  .crafting-item-details {
    width: 100%;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .crafting-item-header {
    display: flex;
    flex-direction: row;
    align-items: flex-start;
    gap: 8px;
    padding: 8px;
    background: rgba(0, 0, 0, 0.2);
    border: 1px solid var(--crafting-border);
    border-radius: 6px;
    margin-bottom: 8px;
  }

  .crafting-item-header .crafting-item-icon {
    width: 32px;
    height: 32px;
    border-radius: 4px;
    background: rgba(0, 0, 0, 0.4);
    padding: 2px;
    flex-shrink: 0;
  }

  .crafting-item-info {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 2px;
    flex: 1;
    min-width: 0;
  }

  .crafting-item-name {
    font-size: 12px;
    font-weight: 500;
    color: var(--crafting-text);
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.9);
    text-align: left;
    width: 100%;
    line-height: 1.2;
    word-wrap: break-word;
    word-break: break-word;
    hyphens: auto;
  }

  /* Requirements section */
  .crafting-requirements {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .crafting-requirements-title {
    font-size: 12px;
    font-weight: 600;
    color: var(--crafting-text);
    margin-bottom: 4px;
  }

  .crafting-requirements-list {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 6px;
  }

  .crafting-requirement-item {
    display: flex;
    flex-direction: row;
    align-items: center;
    gap: 6px;
    padding: 4px 6px;
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid var(--crafting-border);
    border-radius: 6px;
    min-height: 32px;
    position: relative;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .crafting-requirement-item:hover {
    background: rgba(0, 0, 0, 0.5);
    border-color: var(--crafting-border-light);
    transform: translateY(-1px);
  }

  .crafting-requirement-icon {
    width: 20px;
    height: 20px;
    object-fit: contain;
    image-rendering: pixelated;
    border-radius: 3px;
    background: rgba(0, 0, 0, 0.4);
    padding: 1px;
    flex-shrink: 0;
  }

  .crafting-requirement-info {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 1px;
    min-width: 0;
    flex: 1;
  }

  .crafting-requirement-name {
    font-size: 10px;
    color: var(--crafting-text);
    font-weight: 500;
    line-height: 1.2;
    text-align: left;
    width: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .crafting-requirement-quantity {
    font-size: 9px;
    color: var(--crafting-text-muted);
    font-weight: 600;
    padding: 1px 3px;
    border-radius: 2px;
    line-height: 1;
  }

  .crafting-no-requirements {
    color: var(--crafting-text-dim);
    font-size: 12px;
    text-align: center;
    padding: 16px;
    font-style: italic;
    grid-column: 1 / -1;
    background: rgba(0, 0, 0, 0.2);
    border: 1px dashed var(--crafting-border);
    border-radius: 6px;
  }

  /* Actions section */
  .crafting-item-actions {
    display: flex;
    align-items: center;
    justify-content: center;
    padding-top: 8px;
  }

  .crafting-action-btn {
    padding: 8px 16px;
    border: 1px solid #4CAF50;
    border-radius: 4px;
    background: rgba(76, 175, 80, 0.2);
    color: #4CAF50;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    text-transform: uppercase;
    letter-spacing: 0.3px;
  }

  .crafting-action-btn:hover {
    background: rgba(76, 175, 80, 0.3);
    color: #66BB6A;
  }

  /* Quantity control styles */
  .crafting-quantity-controls {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
  }

  .crafting-qty-btn {
    width: 32px;
    height: 32px;
    background: var(--crafting-bg-secondary);
    border: 1px solid var(--crafting-border);
    border-radius: 3px;
    color: var(--crafting-text);
    font-size: 12px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .crafting-qty-btn:hover {
    background: var(--crafting-border);
  }

  .crafting-qty-max {
    width: auto !important;
    padding: 0 8px !important;
    font-size: 10px !important;
    background: rgba(255, 193, 7, 0.2) !important;
    border-color: rgba(255, 193, 7, 0.5) !important;
    color: #FFC107 !important;
  }

  .crafting-qty-max:hover {
    background: rgba(255, 193, 7, 0.3) !important;
    border-color: rgba(255, 193, 7, 0.7) !important;
  }

  .crafting-qty-display {
    font-size: 12px;
    font-weight: 600;
    color: var(--crafting-text);
    min-width: 20px;
    text-align: center;
  }

  .crafting-action-buttons {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
  }

  .crafting-craft-all-btn {
    background: rgba(255, 152, 0, 0.2) !important;
    border-color: #FF9800 !important;
    color: #FF9800 !important;
  }

  .crafting-craft-all-btn:hover {
    background: rgba(255, 152, 0, 0.3) !important;
    color: #FFB74D !important;
  }

  /* Disabled button styles */
  .crafting-qty-btn:disabled,
  .crafting-action-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none;
  }

  /* Item rarity colors */
  .crafting-slot.crafting-common { border-color: #9CA3AF; }
  .crafting-slot.crafting-uncommon { border-color: #22C55E; }
  .crafting-slot.crafting-rare { border-color: #3B82F6; }
  .crafting-slot.crafting-epic { border-color: #A855F7; }
  .crafting-slot.crafting-legendary { border-color: #F59E0B; }

  /* Crafting-specific tooltip positioning (content handled by shared system) */
  .crafting-item-tooltip {
    position: absolute;
    bottom: 100%;
    left: 50%;
    margin-bottom: 8px;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    z-index: 2000;
    pointer-events: none;
  }

  .crafting-requirement-tooltip {
    position: absolute;
    bottom: 100%;
    left: 50%;
    margin-bottom: 8px;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    z-index: 2000;
    pointer-events: none;
  }



  /* Mobile responsive */

    body.mobile {
      --crafting-slot-size: 44px;
      --crafting-icon-size: 32px;
      --crafting-gap: 4px;
      --crafting-padding: 8px;
    }

    body.mobile .crafting-container {
      width: auto;
      max-width: 520px;
      min-width: 340px;
      border-radius: 8px;
    }

    body.mobile .crafting-content {
      padding: 12px;
      gap: 12px;
    }

    body.mobile .crafting-grid {
      justify-items: center;
      width: fit-content;
      margin: 0 auto;
      padding: 8px;
      border-radius: 6px;
    }

    body.mobile .crafting-right-panel {
      width: auto;
      flex: 1;
      min-height: 120px;
      padding: var(--crafting-padding);
      border-radius: 6px;
    }

    body.mobile .crafting-panel-content {
      padding: 8px;
      font-size: 12px;
    }

    body.mobile .crafting-placeholder {
      font-size: 12px;
      padding: 16px;
    }

    body.mobile .crafting-header {
      padding: 8px 12px;
      border-radius: 8px 8px 0 0;
    }

    body.mobile .crafting-info {
      gap: 8px;
    }

    body.mobile .crafting-avatar {
      width: 32px;
      height: 32px;
    }

    body.mobile .crafting-name {
      font-size: 14px;
    }

    body.mobile .crafting-title {
      font-size: 12px;
    }

    body.mobile .crafting-close {
      width: 24px;
      height: 24px;
      font-size: 16px;
    }

    body.mobile .crafting-item-details {
      gap: 8px;
    }

    body.mobile .crafting-item-header {
      gap: 6px;
      padding: 6px;
      margin-bottom: 6px;
    }

    body.mobile .crafting-item-header .crafting-item-icon {
      width: 28px;
      height: 28px;
    }

    body.mobile .crafting-item-name {
      font-size: 11px;
    }

    body.mobile .crafting-requirements-title {
      font-size: 11px;
    }

    body.mobile .crafting-requirements-list {
      grid-template-columns: repeat(2, 1fr);
      gap: 4px;
    }

    body.mobile .crafting-requirement-item {
      padding: 4px 6px;
      min-height: 32px;
      gap: 6px;
      border-radius: 6px;
    }

    body.mobile .crafting-requirement-icon {
      width: 18px;
      height: 18px;
    }

    body.mobile .crafting-requirement-name {
      font-size: 10px;
    }

    body.mobile .crafting-requirement-quantity {
      font-size: 9px;
      padding: 1px 3px;
    }

    body.mobile .crafting-no-requirements {
      font-size: 11px;
      padding: 14px;
    }

    body.mobile .crafting-item-actions {
      padding-top: 8px;
    }

    body.mobile .crafting-action-btn {
      padding: 8px 14px;
      font-size: 11px;
    }

    body.mobile .crafting-slot-quantity {
      font-size: 8px;
      padding: 1px 3px;
      bottom: 2px;
      right: 2px;
      min-width: 10px;
      border-radius: 3px;
    }

    body.mobile .crafting-item-icon {
      width: 36px;
      height: 36px;
    }

    body.mobile .crafting-item-stats {
      font-size: 9px;
      margin-top: 4px;
    }

    body.mobile .crafting-item-stats .stats-header {
      font-size: 9px;
    }

    body.mobile .crafting-item-description {
      font-size: 9px;
      margin-top: 4px;
    }
</style>


<!-- Included from: ./menus/help.html -->
<!-- Help UI -->
<div class="help-overlay">
  <div class="help-container">
    <div class="help-header">
      <h2 class="help-title">Help</h2>
      <button class="help-close">×</button>
    </div>
    
    <div class="help-content">
      <!-- Introduction Section -->
      <div class="help-intro-section">
        <p class="help-intro-text">Welcome to Lumberjack Simulator! Here's a quick help guide to get familiar with how to play.</p>
      </div>

      <!-- Controls Section -->
      <div class="help-controls-section">
        <h3 class="help-section-title">Game Controls</h3>
        <div class="help-controls-grid">
          <!-- Movement Controls -->
          <div class="help-control-item">
            <div class="help-control-keys">
              <span class="help-control-key">W</span>
              <span class="help-control-key">A</span>
              <span class="help-control-key">S</span>
              <span class="help-control-key">D</span>
            </div>
            <div class="help-control-description">Move</div>
          </div>
          
          <div class="help-control-item">
            <div class="help-control-keys">
              <span class="help-control-key">Shift</span>
            </div>
            <div class="help-control-description">Hold to run faster</div>
          </div>
          
          <div class="help-control-item">
            <div class="help-control-keys">
              <span class="help-control-key">Space</span>
            </div>
            <div class="help-control-description">Jump</div>
          </div>
          


          <div class="help-control-item">
            <div class="help-control-keys">
              <span class="help-control-key">E</span>
            </div>
            <div class="help-control-description">Interact, pickup lumber, and chop down trees</div>
          </div>
          
          <!-- Combat Controls -->
          <div class="help-control-item">
            <div class="help-control-keys">
              <span class="help-control-key">Left Click</span>
            </div>
            <div class="help-control-description">Use item, attack or relock mouse</div>
          </div>
          
          <div class="help-control-item">
            <div class="help-control-keys">
              <span class="help-control-key">Right Click</span>
            </div>
            <div class="help-control-description">Use item secondary action</div>
          </div>
          
          <!-- UI Controls -->
          <div class="help-control-item">
            <div class="help-control-keys">
              <span class="help-control-key">I</span>
            </div>
            <div class="help-control-description">Open backpack</div>
          </div>
          
          <div class="help-control-item">
            <div class="help-control-keys">
              <span class="help-control-key">J</span>
            </div>
            <div class="help-control-description">Open quests</div>
          </div>
          
          <div class="help-control-item">
            <div class="help-control-keys">
              <span class="help-control-key">M</span>
            </div>
            <div class="help-control-description">Open character skills</div>
          </div>
          
          <div class="help-control-item">
            <div class="help-control-keys">
              <span class="help-control-key">1 ... 8</span>
            </div>
            <div class="help-control-description">Select hotbar items</div>
          </div>

          <div class="help-control-item">
            <div class="help-control-keys">
              <span class="help-control-key">Esc</span>
            </div>
            <div class="help-control-description">Unlock mouse to click overlay buttons</div>
          </div>
          
          <div class="help-control-item">
            <div class="help-control-keys">
              <span class="help-control-key">T</span>
            </div>
            <div class="help-control-description">Open game chat to send messages</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  // Data Handlers
  hytopia.onData(data => {
    if (data.type === 'toggleHelp') {
      toggleHelp();
    }
  });

  // UI Functions
  function toggleHelp() {
    const overlay = document.querySelector('.help-overlay');
    if (overlay.style.display === 'flex') {
      closeHelp();
    } else {
      openHelp();
    }
  }

  function openHelp() {
    document.querySelector('.help-overlay').style.display = 'flex';
    hytopia.lockPointer(false, true);
  }

  function closeHelp() {
    document.querySelector('.help-overlay').style.display = 'none';
    hytopia.lockPointer(true);
  }

  // Event Listeners
  function setupEventListeners() {
    document.querySelector('.help-close').addEventListener('click', closeHelp);
  }

  // Initialize
  setupEventListeners();
  window.lumberjackSimulator = window.lumberjackSimulator || {};
  window.lumberjackSimulator.openHelp = openHelp;
</script>

<style>
  :root {
    --help-font: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  }

  .help-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    font-family: var(--help-font);
    user-select: none;
  }

  /* Container Styles */
  .help-container {
    background: linear-gradient(145deg, #2a2a2a, #1e1e1e);
    border: 2px solid #444;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.9), inset 0 1px 0 rgba(255, 255, 255, 0.1);
    width: 700px;
    max-height: 80vh;
    overflow: hidden;
  }

  /* Header Styles */
  .help-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    background: linear-gradient(135deg, #3a3a3a, #2d2d2d);
    border-bottom: 1px solid #444;
  }

  .help-title {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
    color: #ffffff;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.9);
    letter-spacing: 0.3px;
  }

  .help-close {
    background: rgba(255, 0, 0, 0.2);
    border: 1px solid rgba(255, 0, 0, 0.3);
    border-radius: 6px;
    color: #ff6b6b;
    width: 24px;
    height: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .help-close:hover {
    background: rgba(255, 0, 0, 0.3);
    transform: scale(1.05);
  }

  /* Content Styles */
  .help-content {
    padding: 20px;
    overflow-y: auto;
    max-height: calc(80vh - 80px);
  }

  /* Introduction Section */
  .help-intro-section {
    margin-bottom: 16px;
    padding: 12px;
    background: rgba(76, 175, 80, 0.1);
    border: 1px solid rgba(76, 175, 80, 0.3);
    border-radius: 8px;
  }

  .help-intro-text {
    margin: 0;
    font-size: 14px;
    font-weight: 500;
    color: #e8f5e8;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.9);
    line-height: 1.5;
    text-align: center;
  }

  /* Controls Section */
  .help-controls-section {
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid #444;
    border-radius: 8px;
    padding: 12px;
  }

  .help-section-title {
    margin: 0 0 12px 0;
    font-size: 14px;
    font-weight: 600;
    color: #ffffff;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.9);
  }

  .help-controls-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
  }

  .help-control-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 8px;
    background: rgba(0, 0, 0, 0.4);
    border: 1px solid #333;
    border-radius: 6px;
    transition: all 0.2s ease;
  }

  .help-control-item:hover {
    border-color: #555;
    background: rgba(0, 0, 0, 0.6);
  }

  .help-control-keys {
    display: flex;
    gap: 4px;
    flex-shrink: 0;
  }

  .help-control-key {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    min-width: 28px;
    height: 28px;
    background: linear-gradient(145deg, #3a3a3a, #2d2d2d);
    border: 1px solid #555;
    border-radius: 4px;
    font-size: 10px;
    font-weight: 600;
    color: #ffffff;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.9);
    box-shadow: 
      0 2px 4px rgba(0, 0, 0, 0.8),
      inset 0 1px 0 rgba(255, 255, 255, 0.1);
    padding: 0 6px;
  }

  .help-control-description {
    font-size: 12px;
    font-weight: 500;
    color: #cccccc;
    line-height: 1.3;
    flex: 1;
  }

  /* Mobile Styles */
  body.mobile .help-container {
    width: auto;
    max-width: 98vw;
    min-width: 300px;
    max-height: 90vh;
  }

  body.mobile .help-header {
    padding: 8px 12px;
  }

  body.mobile .help-title {
    font-size: 14px;
  }

  body.mobile .help-close {
    width: 20px;
    height: 20px;
    font-size: 14px;
  }

  body.mobile .help-content {
    padding: 12px;
    max-height: calc(90vh - 60px);
  }

  body.mobile .help-intro-section {
    margin-bottom: 16px;
    padding: 12px;
  }

  body.mobile .help-intro-text {
    font-size: 12px;
  }

  body.mobile .help-controls-section {
    padding: 12px;
  }

  body.mobile .help-section-title {
    font-size: 12px;
    margin-bottom: 12px;
  }

  body.mobile .help-controls-grid {
    grid-template-columns: 1fr;
    gap: 6px;
  }

  body.mobile .help-control-item {
    gap: 12px;
    padding: 8px;
  }

  body.mobile .help-control-key {
    min-width: 24px;
    height: 24px;
    font-size: 10px;
    padding: 0 6px;
  }

  body.mobile .help-control-description {
    font-size: 11px;
  }

  /* Scrollbar Styles */
  .help-content::-webkit-scrollbar {
    width: 6px;
  }

  .help-content::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.3);
    border-radius: 3px;
  }

  .help-content::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 3px;
  }

  .help-content::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.3);
  }
</style>


<!-- Included from: ./scene-ui-templates/entity-nameplate.html -->
<!-- Scene UI Templates -->
<template id="entity-nameplate-template">
  <div class="entity-nameplate">
    <div class="entity-nameplate-alert">!</div>
    <div class="entity-nameplate-name">A Test Mob</div>
    <div class="entity-nameplate-interact">Press "E" to interact</div>
    <div class="entity-nameplate-level">Lvl 12</div>
    <div class="entity-nameplate-health-bar">
      <div class="entity-nameplate-health-bar-fill"></div>
    </div>
  </div>
</template>

<script>
  // Track which entity class names should show alerts
  let entityAlertClassNames = new Set();
  
  // Simple callback registry for alert updates
  let alertUpdateCallbacks = [];

  // Handle entity alert updates from GamePlayer
  hytopia.onData(data => {
    if (data.type === 'addEntityAlert') {
      entityAlertClassNames.add(data.className);
    } else if (data.type === 'removeEntityAlert') {
      entityAlertClassNames.delete(data.className);
    } else if (data.type === 'syncEntityAlerts') {
      entityAlertClassNames = new Set(data.classNames);
    }
    
    // Trigger all registered update callbacks
    if (data.type === 'addEntityAlert' || data.type === 'removeEntityAlert' || data.type === 'syncEntityAlerts') {
      alertUpdateCallbacks.forEach(callback => callback());
    }
  });

  hytopia.registerSceneUITemplate('entity-nameplate', (id, onState) => {
    const template = document.getElementById('entity-nameplate-template');
    const clone = template.content.cloneNode(true);
    const nameplate = clone.querySelector('.entity-nameplate');
    const alert = clone.querySelector('.entity-nameplate-alert');
    const name = clone.querySelector('.entity-nameplate-name');
    const interact = clone.querySelector('.entity-nameplate-interact');
    const level = clone.querySelector('.entity-nameplate-level');
    const healthBar = clone.querySelector('.entity-nameplate-health-bar');
    const healthBarFill = clone.querySelector('.entity-nameplate-health-bar-fill');
    
    let className = '';
    let damageCount = 0;
    let lastHealth = null;

    // Function to update this nameplate's alert display
    const updateAlert = () => {
      const shouldShowAlert = className && entityAlertClassNames.has(className);
      alert.style.display = shouldShowAlert ? 'block' : 'none';
    };

    // Register for alert updates
    alertUpdateCallbacks.push(updateAlert);

    onState(state => {
      if (state.className) {
        className = state.className;
        updateAlert();
      }

      // Calculate health change if we have a previous health value
      if (lastHealth !== null && state.health !== undefined && state.health !== lastHealth) {
        const healthChange = state.health - lastHealth;
        
        if (healthChange < 0) {
          // Damage taken - show red damage number
          showDamageNumber(-healthChange, 'damage');
        } else if (healthChange > 0) {
          // Healing received - show green healing number
          showDamageNumber(healthChange, 'healing');
        }
      }
      
      // Update lastHealth for next comparison
      if (state.health !== undefined) {
        lastHealth = state.health;
      }

      if (state.dodged) {
        const dodgedEl = document.createElement('div');
        dodgedEl.className = 'entity-nameplate-dodged';
        dodgedEl.textContent = 'Dodged!';
        
        const delay = damageCount++ * 50;
        
        nameplate.appendChild(dodgedEl);
        
        setTimeout(() => dodgedEl.classList.add('show'), delay);
        setTimeout(() => {
          dodgedEl.remove();
          damageCount--;
        }, 800 + delay);
      }

      if (state.interactable) {
        interact.style.display = 'block';
      } else {
        interact.style.display = 'none';
      }

      if (state.interactActionText) {
        interact.textContent = state.interactActionText;
      }

      if (state.name) {
        name.style.display = 'block';
        name.textContent = state.name;
      }

      if (state.level) {
        level.style.display = 'block';
        level.textContent = `Lvl ${state.level}`;
      }

      if (state.health >= 0 && state.maxHealth > 0) {
        healthBar.style.display = 'block';
        const healthPercent = state.health / state.maxHealth;
        
        healthBarFill.style.transform = `scaleX(${healthPercent})`;
        
        healthBarFill.className = 'entity-nameplate-health-bar-fill';
        if (healthPercent > 0.66) healthBarFill.classList.add('health-high');
        else if (healthPercent > 0.33) healthBarFill.classList.add('health-medium');
        else healthBarFill.classList.add('health-low');
      }

      if (state.type) {
        // Remove any existing type classes
        nameplate.classList.remove('boss');
        
        // Apply boss class if entity type is boss
        if (state.type === 'boss') {
          nameplate.classList.add('boss');
        }
      }
    });

    function showDamageNumber(amount, type) {
      const numberEl = document.createElement('div');
      numberEl.className = `entity-nameplate-${type}`;
      numberEl.textContent = type === 'damage' ? `-${amount}` : `+${amount}`;
      
      const delay = damageCount++ * 50;
      
      nameplate.appendChild(numberEl);
      
      setTimeout(() => numberEl.classList.add('show'), delay);
      setTimeout(() => {
        numberEl.remove();
        damageCount--;
      }, 800 + delay);
    }

    return clone;
  });
</script>

<style>
  .entity-nameplate {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    user-select: none;
    pointer-events: none;
  }

  .entity-nameplate-alert {
    display: none;
    width: 16px;
    height: 16px;
    background: linear-gradient(145deg, #4CAF50, #66BB6A);
    border: 1px solid rgba(76, 175, 80, 0.8);
    border-radius: 50%;
    font-size: 11px;
    font-weight: 900;
    color: #ffffff;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.9);
    text-align: center;
    line-height: 16px;
    margin-bottom: 6px;
    box-shadow: 
      0 0 8px rgba(76, 175, 80, 0.5),
      0 1px 4px rgba(0, 0, 0, 0.8),
      inset 0 1px 0 rgba(255, 255, 255, 0.3);
    animation: alertPulse 2s ease-in-out infinite;
    z-index: 10;
  }

  @keyframes alertPulse {
    0%, 100% { 
      transform: scale(1);
      box-shadow: 
        0 0 8px rgba(76, 175, 80, 0.5),
        0 1px 4px rgba(0, 0, 0, 0.8),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }
    50% { 
      transform: scale(1.1);
      box-shadow: 
        0 0 12px rgba(76, 175, 80, 0.7),
        0 1px 4px rgba(0, 0, 0, 0.8),
        inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }
  }

  .entity-nameplate-name {
    display: none;
    font-size: 12px;
    font-weight: 600;
    color: #ffffff;
    text-shadow: 0 1px 2px rgba(0,0,0,0.9), 1px 1px 0 #000, -1px -1px 0 #000;
    letter-spacing: 0.3px;
    margin-bottom: 3px;
  }

  .entity-nameplate-interact {
    display: none;
    font-size: 10px;
    font-weight: 500;
    color: #DDDDDD;
    text-shadow: 0 1px 2px rgba(0,0,0,0.9), 1px 1px 0 #000, -1px -1px 0 #000;
    letter-spacing: 0.1px;
    margin-bottom: 2px;
    opacity: 0.8;
    animation: subtlePulse 2s ease-in-out infinite;
  }

  @keyframes subtlePulse {
    0%, 100% { opacity: 0.6; }
    50% { opacity: 0.9; }
  }

  .entity-nameplate-level {
    display: none;
    font-size: 10px;
    font-weight: 600;
    color: #ffd700;
    text-shadow: 0 1px 2px rgba(0,0,0,0.9), 1px 1px 0 #000, -1px -1px 0 #000, 0 0 0 #000;
    letter-spacing: 0.2px;
    margin-bottom: 2px;
  }

  .entity-nameplate-damage {
    position: absolute;
    top: -15px;
    left: 50%;
    font-size: 18px;
    font-weight: 700;
    color: #ff0000;
    text-shadow: 0 1px 2px rgba(0,0,0,0.9), 1px 1px 0 #000, -1px -1px 0 #000;
    opacity: 0;
    transform: translateX(-50%);
    pointer-events: none;
  }

  .entity-nameplate-healing {
    position: absolute;
    top: -15px;
    left: 50%;
    font-size: 18px;
    font-weight: 700;
    color: #00ff00;
    text-shadow: 0 1px 2px rgba(0,0,0,0.9), 1px 1px 0 #000, -1px -1px 0 #000;
    opacity: 0;
    transform: translateX(-50%);
    pointer-events: none;
  }

  .entity-nameplate-dodged {
    position: absolute;
    top: -15px;
    left: 50%;
    font-size: 16px;
    font-weight: 700;
    color: #ffd700;
    text-shadow: 0 1px 2px rgba(0,0,0,0.9), 1px 1px 0 #000, -1px -1px 0 #000;
    opacity: 0;
    transform: translateX(-50%);
    pointer-events: none;
  }

  .entity-nameplate-damage.show {
    animation: damageFloat 0.8s ease-out;
  }

  .entity-nameplate-healing.show {
    animation: healingFloat 0.8s ease-out;
  }

  .entity-nameplate-dodged.show {
    animation: dodgedFloat 0.8s ease-out;
  }

  @keyframes damageFloat {
    0% { opacity: 0; transform: translateX(-50%) translateY(0) scale(0.5); }
    15% { opacity: 1; transform: translateX(-50%) translateY(-8px) scale(1.2); }
    30% { transform: translateX(-50%) translateY(-12px) scale(1); }
    100% { opacity: 0; transform: translateX(-50%) translateY(-30px) scale(0.8); }
  }

  @keyframes healingFloat {
    0% { opacity: 0; transform: translateX(-50%) translateY(0) scale(0.5); }
    15% { opacity: 1; transform: translateX(-50%) translateY(-10px) scale(1.1); }
    30% { transform: translateX(-50%) translateY(-15px) scale(1); }
    60% { transform: translateX(-50%) translateY(-20px) scale(1.05); }
    100% { opacity: 0; transform: translateX(-50%) translateY(-35px) scale(0.9); }
  }

  @keyframes dodgedFloat {
    0% { opacity: 0; transform: translateX(-50%) translateY(0) scale(0.5); }
    15% { opacity: 1; transform: translateX(-50%) translateY(-10px) scale(1.3); }
    30% { transform: translateX(-50%) translateY(-14px) scale(1); }
    60% { transform: translateX(-50%) translateY(-18px) scale(1.05); }
    100% { opacity: 0; transform: translateX(-50%) translateY(-35px) scale(0.8); }
  }

  .entity-nameplate-health-bar {
    display: none;
    width: 80px;
    height: 5px;
    background: rgba(0,0,0,0.7);
    border: 1px solid rgba(0,0,0,0.9);
    border-radius: 2px;
    overflow: hidden;
    box-shadow: 0 0 4px rgba(0,0,0,0.8);
  }

  .entity-nameplate-health-bar-fill {
    height: 100%;
    width: 100%;
    background-color: #4CAF50;
    transition: transform 0.3s ease-out, background-color 0.3s ease-out;
    transform-origin: left center;
    transform: scaleX(1);
    box-shadow: inset 0 1px 0 rgba(255,255,255,0.3);
  }

  .entity-nameplate-health-bar-fill.health-high { background-color: #4CAF50; }
  .entity-nameplate-health-bar-fill.health-medium { background-color: #FFC107; }
  .entity-nameplate-health-bar-fill.health-low { background-color: #f44336; }

  .entity-nameplate.boss .entity-nameplate-name {
    color: #ef4444;
  }
</style>

<!-- Included from: ./scene-ui-templates/item-nameplate.html -->
<template id="item-nameplate-template">
  <div class="item-nameplate-container">
    <div class="item-nameplate">
      <div class="item-nameplate-name"></div>
      <div class="item-nameplate-quantity"></div>
    </div>
    <div class="item-nameplate-icon">
      <img src="{{CDN_ASSETS_URL}}/icons/placeholder.png" alt="Item" class="item-icon-image">
    </div>
  </div>
</template>

<script>
  hytopia.registerSceneUITemplate('item-nameplate', (id, onState) => {
    const template = document.getElementById('item-nameplate-template');
    const clone = template.content.cloneNode(true);
    const name = clone.querySelector('.item-nameplate-name');
    const iconImage = clone.querySelector('.item-icon-image');
    const quantity = clone.querySelector('.item-nameplate-quantity');

    onState(state => {
      if (state.name) {
        name.textContent = state.name;
        name.style.color = `rgb(${state.rarityColor.r}, ${state.rarityColor.g}, ${state.rarityColor.b})`;
      }
      
      if (state.quantity > 1) {
        quantity.style.display = 'block';
        quantity.textContent = state.quantity.toLocaleString();
      }

      if (state.iconImageUri) {        
        iconImage.src = `{{CDN_ASSETS_URL}}/${state.iconImageUri}`;
      }
    });
    
    return clone;
  });
</script>
<style>
  :root {
    --nameplate-bg: linear-gradient(145deg, #2a2a2a, #1e1e1e);
    --nameplate-border: #444;
    --nameplate-text: #ffffff;
    --nameplate-shadow: rgba(0, 0, 0, 0.8);
  }

  .item-nameplate-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    position: relative;
    animation: itemFloat 3s ease-in-out infinite;
  }

  /* Ground shadow */
  .item-nameplate-container::before {
    content: '';
    position: absolute;
    bottom: -12px;
    left: 50%;
    transform: translateX(-50%);
    width: 60px;
    height: 12px;
    background: radial-gradient(ellipse, rgba(0, 0, 0, 0.4), transparent 70%);
    border-radius: 50%;
    z-index: -1;
  }

  .item-nameplate {
    position: relative;
    background: var(--nameplate-bg);
    border: 2px solid var(--nameplate-border);
    border-radius: 8px;
    padding: 8px 12px;
    box-shadow: 0 4px 12px var(--nameplate-shadow), inset 0 1px 0 rgba(255, 255, 255, 0.1);
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    display: flex;
    align-items: center;
    gap: 8px;
    white-space: nowrap;
    max-width: 250px;
    margin-bottom: 12px;
  }

  /* Caret */
  .item-nameplate::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 8px solid transparent;
    border-top-color: var(--nameplate-border);
  }

  .item-nameplate::before {
    content: '';
    position: absolute;
    top: calc(100% - 2px);
    left: 50%;
    transform: translateX(-50%);
    border: 6px solid transparent;
    border-top-color: #2a2a2a;
    z-index: 1;
  }

  .item-nameplate-name {
    font-size: 12px;
    font-weight: 500;
    color: var(--nameplate-text);
    text-shadow: 0 1px 2px var(--nameplate-shadow);
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .item-nameplate-quantity {
    font-size: 10px;
    font-weight: 600;
    color: var(--nameplate-text);
    text-shadow: 0 1px 2px var(--nameplate-shadow);
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 4px;
    padding: 2px 6px;
    line-height: 1;
    display: none;
  }

  .item-nameplate-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 80px;
    height: 80px;
  }

  .item-icon-image {
    width: 64px;
    height: 64px;
    object-fit: contain;
    image-rendering: pixelated;
    filter: 
      drop-shadow(2px 2px 1px rgba(0, 0, 0, 0.5))
      drop-shadow(4px 4px 3px rgba(0, 0, 0, 0.3))
      drop-shadow(0 8px 8px rgba(0, 0, 0, 0.4));
  }

  @keyframes itemFloat {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-12px); }
  }
</style>

<!-- Included from: ./hud.html -->
<!-- Game HUD Overlay -->
<div class="hud-overlay">
  <div class="hud-coordinates" id="hud-coordinates" style="position: absolute; top: 12px; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.35); color: var(--hud-text); padding: 4px 8px; border-radius: 6px; font-size: 12px; letter-spacing: 0.5px; text-shadow: var(--hud-text-shadow); pointer-events: none; z-index: 1000;">X: 0 Y: 0 Z: 0</div>
   <!-- Area Banner -->
   <div class="hud-area-banner" id="hud-area-banner">
     <div class="hud-area-banner-content">
       <div class="hud-area-banner-text"></div>
       <div class="hud-area-banner-underline"></div>
     </div>
   </div>

   <!-- Death Overlay -->
   <div class="hud-death-overlay" id="hud-death-overlay">
     <div class="hud-death-content">
       <div class="hud-death-title">You Died!</div>
       <div class="hud-death-subtitle">Await revival or respawn nearby</div>
       <div class="hud-death-underline"></div>
       <button class="hud-death-respawn-btn" id="hud-death-respawn-btn">
         <span class="hud-death-respawn-text">Respawn</span>
       </button>
     </div>
   </div>

   <!-- Tree Chopping Progress Bar -->
   <div class="hud-chopping-container" id="hud-chopping-container">
     <div class="hud-chopping-bar">
       <div class="hud-chopping-fill" id="hud-chopping-fill" style="width: 0%;"></div>
       <div class="hud-chopping-text" id="hud-chopping-text">Chopping Tree...</div>
     </div>
     <div class="hud-chopping-timer" id="hud-chopping-timer">3.2s</div>
   </div>

   <!-- Respawn Fade Overlay -->
   <div class="hud-respawn-fade" id="hud-respawn-fade"></div>

   <!-- Game Clock (top right) -->
   <div class="hud-clock-container">
     <div class="hud-clock">
       <div class="hud-clock-time">2:45 PM</div>
     </div>
   </div>

   <!-- Action Buttons (below clock) -->
   <div class="hud-action-buttons">
     <button class="hud-action-button" id="hud-quest-log-btn">
       <img src="{{CDN_ASSETS_URL}}/icons/buttons/quests.png" alt="Quests" class="hud-action-button-icon">
       <div class="hud-action-key-indicator">J</div>
       <div class="hud-quest-count-indicator" id="hud-quest-count-indicator">0</div>
       <div class="hud-action-tooltip">
         <div class="hud-action-tooltip-content">
           Quests - View your active and completed quests.
         </div>
       </div>
     </button>
     <button class="hud-action-button" id="hud-backpack-btn">
       <img src="{{CDN_ASSETS_URL}}/icons/buttons/backpack.png" alt="Backpack" class="hud-action-button-icon">
       <div class="hud-action-key-indicator">I</div>
       <div class="hud-action-tooltip">
         <div class="hud-action-tooltip-content">
           Backpack - View and manage your backpack and equipment.
         </div>
       </div>
     </button>
     <button class="hud-action-button" id="hud-skills-btn">
       <img src="{{CDN_ASSETS_URL}}/icons/buttons/skills.png" alt="Skills" class="hud-action-button-icon">
       <div class="hud-action-key-indicator">M</div>
       <div class="hud-action-tooltip">
         <div class="hud-action-tooltip-content">
           Skills - View your current character skills.
         </div>
       </div>
     </button>
     <button class="hud-action-button hud-help-button" id="hud-help-btn">
       <div class="hud-help-icon">?</div>
       <div class="hud-action-key-indicator">O</div>
       <div class="hud-help-notification-indicator show" id="hud-help-notification-indicator"></div>
       <div class="hud-action-tooltip">
         <div class="hud-action-tooltip-content">
           Help - View game controls and tips.
         </div>
       </div>
     </button>
   </div>

   <!-- Player Status Bars (positioned above hotbar) -->
   <div class="hud-status-container">
     <!-- Health Bar -->
     <div class="hud-health-bar">
       <div class="hud-health-fill health-high" style="width: 75%;"></div>
       <div class="hud-health-text">150 / 200</div>
     </div>
     
     <!-- Chopping Progress Bar -->
     <div class="hud-chopping-bar" style="display: none;">
       <div class="hud-chopping-fill" style="width: 0%;"></div>
       <div class="hud-chopping-text">Chopping...</div>
     </div>
     
     <!-- Experience Bar -->
     <div class="hud-exp-bar">
       <div class="hud-exp-fill" style="width: 60%;"></div>
       <div class="hud-exp-text">Level 12 - 1,200 / 2,000 XP</div>
     </div>
   </div>

   <!-- Progress Bar (for actions like chopping) -->
   <div class="hud-progress-container" style="display: none;">
     <div class="hud-progress-bar">
       <div class="hud-progress-fill" style="width: 0%;"></div>
       <div class="hud-progress-text">Chopping...</div>
     </div>
   </div>

   <!-- Crosshair -->
   <div class="hud-crosshair">
     <div class="hud-crosshair-horizontal"></div>
     <div class="hud-crosshair-vertical"></div>
   </div>

   <!-- Mobile Control Buttons -->
   <button class="hud-mobile-button" id="hud-attack-btn">
     <img src="{{CDN_ASSETS_URL}}/icons/skills/combat.png" alt="Attack" class="hud-mobile-button-icon">
   </button>
   <button class="hud-mobile-button" id="hud-dodge-btn">
     <img src="{{CDN_ASSETS_URL}}/icons/skills/agility.png" alt="Dodge" class="hud-mobile-button-icon">
   </button>
   <button class="hud-mobile-button" id="hud-jump-btn">
     <img src="{{CDN_ASSETS_URL}}/icons/buttons/jump.png" alt="Jump" class="hud-mobile-button-icon">
   </button>
   <button class="hud-mobile-button" id="hud-interact-btn">
     <img src="{{CDN_ASSETS_URL}}/icons/buttons/e-mobile.png" alt="Interact" class="hud-mobile-button-icon">
   </button>

   <!-- Hotbar -->
   <div class="hud-hotbar-container">
     <div class="hud-hotbar-grid">
       <!-- Static hotbar slots -->
       <div class="hud-hotbar-slot">
         <div class="hud-hotbar-slot-content">1</div>
       </div>
       <div class="hud-hotbar-slot">
         <div class="hud-hotbar-slot-content">2</div>
       </div>
       <div class="hud-hotbar-slot">
         <div class="hud-hotbar-slot-content">3</div>
       </div>
       <div class="hud-hotbar-slot">
         <div class="hud-hotbar-slot-content">4</div>
       </div>
       <div class="hud-hotbar-slot">
         <div class="hud-hotbar-slot-content">5</div>
       </div>
       <div class="hud-hotbar-slot">
         <div class="hud-hotbar-slot-content">6</div>
       </div>
       <div class="hud-hotbar-slot">
         <div class="hud-hotbar-slot-content">7</div>
       </div>
       <div class="hud-hotbar-slot">
         <div class="hud-hotbar-slot-content">8</div>
       </div>
     </div>
   </div>
</div>

<!-- Notification Toast Container (outside HUD overlay for proper z-indexing) -->
<div class="hud-notification-container" id="hud-notification-container"></div>

<script>
  // Configuration
  const HUD_CONFIG = {
    // Layout
    hotbarSlots: 8,
    
    // Timing (in milliseconds)
    clockUpdateInterval: 1000,
    elementFadeDuration: 500,
    expGainStaggerDelay: 100,
    expGainDuration: 1200,
    notificationDuration: 7500,
    respawnDelay: 250
  };

  // State Management
  let gameTime = { hour: 0, minute: 0 };
  let lastExp = null;
  let expGainCount = 0;

  // Data Handlers
  hytopia.onData(data => {
    switch (data.type) {
      case 'syncClock':
        gameTime = { hour: data.hour, minute: data.minute };
        updateClock();
        break;
      case 'syncExp':
        updateExperienceBar(data.level, data.exp, data.currentLevelExp, data.nextLevelExp);
        break;
      case 'syncHealth':
        updateHealthBar(data.health, data.maxHealth);
        break;
      case 'hotbarUpdate':
        updateHotbarSlot(data.position, data);
        break;
      case 'showAreaBanner':
        showAreaBanner(data.areaName);
        break;
      case 'showNotification':
        showNotification(data.message, data.notificationType);
        break;
      case 'showProgressBar':
        showProgressBar(data.text);
        break;
      case 'updateProgressBar':
        updateProgressBar(data.progress, data.text);
        break;
      case 'hideProgressBar':
        hideProgressBar();
        break;
      case 'showChoppingBar':
        showChoppingBar(data.text, data.duration);
        break;
      case 'updateChoppingBar':
        updateChoppingBar(data.progress, data.text, data.timeLeft);
        break;
      case 'hideChoppingBar':
        hideChoppingBar();
        break;
      case 'startTreeChopping':
        startTreeChopping(data.treeName, data.duration);
        break;
      case 'updateTreeChopping':
        updateTreeChopping(data.progress, data.timeLeft);
        break;
      case 'stopTreeChopping':
        stopTreeChopping();
        break;
      case 'syncCoordinates':
        updateCoordinates(data.x, data.y, data.z);
        break;
    }
  });

  // Initialization
  function initializeHUD() {
    setupClock();
    setupHotbar();
    setupActionButtons();
    setActiveSlot(0);
  }

  function setupClock() {
    const clockTime = document.querySelector('.hud-clock-time');
    setInterval(() => {
      gameTime.minute++;
      if (gameTime.minute >= 60) {
        gameTime.minute = 0;
        gameTime.hour = (gameTime.hour + 1) % 24;
      }
      updateClock();
    }, HUD_CONFIG.clockUpdateInterval);
  }

  function setupHotbar() {
    const hotbarSlots = document.querySelectorAll('.hud-hotbar-slot');
    
    // Setup click events
    hotbarSlots.forEach((slot, index) => {
      slot.addEventListener('click', () => setActiveSlot(index));
    });

    // Setup keyboard events
    document.addEventListener('keydown', (e) => {
      const key = parseInt(e.key);
      if (key >= 1 && key <= HUD_CONFIG.hotbarSlots) {
        setActiveSlot(key - 1);
      }
    });
  }

  function setupActionButtons() {
    const buttons = {
      'hud-quest-log-btn': () => window.lumberjackSimulator.openQuests(),
      'hud-backpack-btn': () => window.lumberjackSimulator.openBackpack(),
      'hud-skills-btn': () => window.lumberjackSimulator.openSkills(),
      'hud-help-btn': () => window.lumberjackSimulator.openHelp()
    };

    Object.entries(buttons).forEach(([id, handler]) => {
      document.getElementById(id).addEventListener('click', handler);
    });

    // Setup death overlay respawn button
    document.getElementById('hud-death-respawn-btn').addEventListener('pointerdown', handleRespawn);
    
    // Setup mobile buttons
    document.getElementById('hud-attack-btn').addEventListener('pointerdown', handleAttackTap);
    document.getElementById('hud-attack-btn').addEventListener('pointerup', stopAutoAttack);
    document.getElementById('hud-attack-btn').addEventListener('pointercancel', stopAutoAttack);
    document.getElementById('hud-dodge-btn').addEventListener('pointerdown', () => hytopia.pressInput('q', true));
    document.getElementById('hud-dodge-btn').addEventListener('pointerup', () => hytopia.pressInput('q', false));
    document.getElementById('hud-jump-btn').addEventListener('pointerdown', () => hytopia.pressInput('sp', true));
    document.getElementById('hud-jump-btn').addEventListener('pointerup', () => hytopia.pressInput('sp', false));
    document.getElementById('hud-interact-btn').addEventListener('pointerdown', () => hytopia.pressInput('e', true));
    document.getElementById('hud-interact-btn').addEventListener('pointerup', () => hytopia.pressInput('e', false));
  }

  function updateHudQuestCount(activeCount, completedCount) {
    const questIndicator = document.getElementById('hud-quest-count-indicator');
    const helpNotification = document.getElementById('hud-help-notification-indicator');
    
    // Update quest count indicator
    if (activeCount > 0) {
      questIndicator.textContent = activeCount.toString();
      questIndicator.classList.add('show');
    } else {
      questIndicator.classList.remove('show');
    }
    
    // Hide help notification if the user has any quests, meaning they've started the game.
    if (activeCount > 0 || completedCount > 0) {
      helpNotification.classList.remove('show');
    }
  }

  // Utility Functions
  function formatExpNumber(num) {
    if (num >= 1000000) return `${(num / 1000000).toFixed(1)}M`;
    if (num >= 1000) return `${(num / 1000).toFixed(1)}K`;
    return num.toString();
  }

  function updateClock() {
    const clockTime = document.querySelector('.hud-clock-time');
    const period = gameTime.hour >= 12 ? 'PM' : 'AM';
    const displayHour = gameTime.hour === 0 ? 12 : gameTime.hour > 12 ? gameTime.hour - 12 : gameTime.hour;
    clockTime.textContent = `${displayHour}:${gameTime.minute.toString().padStart(2, '0')} ${period}`;
  }

  function setActiveSlot(index) {
    const hotbarSlots = document.querySelectorAll('.hud-hotbar-slot');
    hotbarSlots.forEach((slot, i) => 
      slot.classList.toggle('hud-hotbar-slot-active', i === index)
    );
    hytopia.sendData({ type: 'setSelectedHotbarIndex', index });
  }

  // Use shared tooltip system (same as backpack)
  function createTooltip(slot, itemData) {
    if (window.ItemTooltips) {
      ItemTooltips.createTooltip(slot, itemData, {
        tooltipClass: 'item-tooltip',
        contentClass: 'item-tooltip-content',
        showSellPrice: true
      });
    }
  }

  function removeTooltip(slot) {
    if (window.ItemTooltips) {
      ItemTooltips.removeTooltip(slot, 'item-tooltip');
    }
  }

  // Update Functions
  function updateHealthBar(health, maxHealth) {
    const healthBar = document.querySelector('.hud-health-fill');
    const healthText = document.querySelector('.hud-health-text');
    
    const healthPercent = Math.max(0, Math.min(100, (health / maxHealth) * 100));
    
    healthBar.style.width = `${healthPercent}%`;
    
    // Update color class
    healthBar.className = 'hud-health-fill';
    if (healthPercent > 66) {
      healthBar.classList.add('health-high');
    } else if (healthPercent > 33) {
      healthBar.classList.add('health-medium');
    } else {
      healthBar.classList.add('health-low');
    }
    
    healthText.textContent = `${Math.max(0, health)} / ${maxHealth}`;

    // Show death overlay if health reaches 0, hide if health is restored
    if (health <= 0) {
      showDeathOverlay();
    } else if (health > 0) {
      hideDeathOverlay();
    }
  }

  function updateExperienceBar(level, exp, currentLevelExp, nextLevelExp) {
    const expBar = document.querySelector('.hud-exp-fill');
    const expText = document.querySelector('.hud-exp-text');
    
    // Show EXP gain effect if applicable
    if (lastExp !== null && exp > lastExp) {
      showExpGainEffect(exp - lastExp);
    }
    lastExp = exp;
    
    // Calculate and update progress
    const currentProgress = exp - currentLevelExp;
    const maxProgress = nextLevelExp - currentLevelExp;
    const expPercent = Math.max(0, Math.min(100, (currentProgress / maxProgress) * 100));
    
    expBar.style.width = `${expPercent}%`;
    
    // Update text
    const currentFormatted = formatExpNumber(currentProgress);
    const maxFormatted = formatExpNumber(maxProgress);
    const percentText = `${Math.round(expPercent)}%`;
    
    expText.textContent = `Level ${level} • ${currentFormatted}/${maxFormatted} XP (${percentText})`;
  }

  // Progress Bar Functions
  function showProgressBar(text = 'Working...') {
    const progressContainer = document.querySelector('.hud-progress-container');
    const progressText = document.querySelector('.hud-progress-text');
    const progressFill = document.querySelector('.hud-progress-fill');
    
    progressText.textContent = text;
    progressFill.style.width = '0%';
    progressContainer.style.display = 'block';
  }

  function updateProgressBar(progress, text) {
    const progressText = document.querySelector('.hud-progress-text');
    const progressFill = document.querySelector('.hud-progress-fill');
    
    const progressPercent = Math.max(0, Math.min(100, progress));
    progressFill.style.width = `${progressPercent}%`;
    
    if (text) {
      progressText.textContent = text;
    }
  }

  function hideProgressBar() {
    const progressContainer = document.querySelector('.hud-progress-container');
    progressContainer.style.display = 'none';
  }

  // Chopping Bar Functions
  function showChoppingBar(text = 'Chopping Tree...', duration = 3000) {
    const choppingContainer = document.getElementById('hud-chopping-container');
    const choppingText = document.getElementById('hud-chopping-text');
    const choppingFill = document.getElementById('hud-chopping-fill');
    const choppingTimer = document.getElementById('hud-chopping-timer');
    
    choppingText.textContent = text;
    choppingFill.style.width = '0%';
    choppingTimer.textContent = `${(duration / 1000).toFixed(1)}s`;
    choppingContainer.style.display = 'block';
    
    // Add fade-in animation
    choppingContainer.style.opacity = '0';
    choppingContainer.style.transform = 'translateY(10px)';
    setTimeout(() => {
      choppingContainer.style.opacity = '1';
      choppingContainer.style.transform = 'translateY(0)';
    }, 10);
  }

  function updateChoppingBar(progress, text, timeLeft) {
    const choppingText = document.getElementById('hud-chopping-text');
    const choppingFill = document.getElementById('hud-chopping-fill');
    const choppingTimer = document.getElementById('hud-chopping-timer');
    
    const progressPercent = Math.max(0, Math.min(100, progress));
    choppingFill.style.width = `${progressPercent}%`;
    
    if (text) {
      choppingText.textContent = text;
    }
    
    if (timeLeft !== undefined) {
      choppingTimer.textContent = `${(timeLeft / 1000).toFixed(1)}s`;
    }
    
    // Change color as progress increases
    if (progressPercent < 25) {
      choppingFill.style.background = 'linear-gradient(90deg, #dc2626, #ef4444)';
    } else if (progressPercent < 50) {
      choppingFill.style.background = 'linear-gradient(90deg, #ea580c, #f97316)';
    } else if (progressPercent < 75) {
      choppingFill.style.background = 'linear-gradient(90deg, #ca8a04, #eab308)';
    } else {
      choppingFill.style.background = 'linear-gradient(90deg, #16a34a, #22c55e)';
    }
  }

  function hideChoppingBar() {
    const choppingContainer = document.getElementById('hud-chopping-container');
    
    // Add fade-out animation
    choppingContainer.style.opacity = '0';
    choppingContainer.style.transform = 'translateY(-10px)';
    
    setTimeout(() => {
      choppingContainer.style.display = 'none';
    }, 200);
  }

  // Tree Chopping Functions (Server Controlled)
  function startTreeChopping(treeName = 'Tree', duration = 3000) {
    const choppingContainer = document.getElementById('hud-chopping-container');
    const choppingText = document.getElementById('hud-chopping-text');
    const choppingFill = document.getElementById('hud-chopping-fill');
    const choppingTimer = document.getElementById('hud-chopping-timer');
    
    // Set initial state
    choppingText.textContent = `Chopping ${treeName}...`;
    choppingFill.style.width = '0%';
    choppingFill.style.background = 'linear-gradient(90deg, #dc2626, #ef4444)';
    choppingTimer.textContent = `${(duration / 1000).toFixed(1)}s`;
    
    // Show with animation
    choppingContainer.style.display = 'block';
    choppingContainer.style.opacity = '0';
    choppingContainer.style.transform = 'translateY(10px)';
    
    requestAnimationFrame(() => {
      choppingContainer.style.opacity = '1';
      choppingContainer.style.transform = 'translateY(0)';
    });
  }

  function updateTreeChopping(progress, timeLeft) {
    const choppingFill = document.getElementById('hud-chopping-fill');
    const choppingTimer = document.getElementById('hud-chopping-timer');
    
    // Update progress bar
    const progressPercent = Math.max(0, Math.min(100, progress));
    choppingFill.style.width = `${progressPercent}%`;
    
    // Update timer
    if (timeLeft !== undefined) {
      choppingTimer.textContent = `${(timeLeft / 1000).toFixed(1)}s`;
    }
    
    // Dynamic color based on progress
    if (progressPercent < 25) {
      choppingFill.style.background = 'linear-gradient(90deg, #dc2626, #ef4444)'; // Red
    } else if (progressPercent < 50) {
      choppingFill.style.background = 'linear-gradient(90deg, #ea580c, #f97316)'; // Orange
    } else if (progressPercent < 75) {
      choppingFill.style.background = 'linear-gradient(90deg, #ca8a04, #eab308)'; // Yellow
    } else {
      choppingFill.style.background = 'linear-gradient(90deg, #16a34a, #22c55e)'; // Green
    }
  }

  function stopTreeChopping() {
    const choppingContainer = document.getElementById('hud-chopping-container');
    
    // Fade out animation
    choppingContainer.style.opacity = '0';
    choppingContainer.style.transform = 'translateY(-10px)';
    
    setTimeout(() => {
      choppingContainer.style.display = 'none';
    }, 200);
  }

  function updateHotbarSlot(position, itemData) {
    if (position < 0 || position >= HUD_CONFIG.hotbarSlots) return;
    
    const hotbarSlots = document.querySelectorAll('.hud-hotbar-slot');
    const slot = hotbarSlots[position];
    const content = slot.querySelector('.hud-hotbar-slot-content');
    
    content.innerHTML = '';
    
    // Clear existing tooltip
    removeTooltip(slot);
    
    if (itemData.removed) {
      content.textContent = position + 1;
    } else {
      const icon = document.createElement('img');
      icon.src = `{{CDN_ASSETS_URL}}/${itemData.iconImageUri}`;
      icon.alt = 'Item';
      icon.className = 'hud-hotbar-slot-icon';
      content.appendChild(icon);
      
      if (itemData.quantity && itemData.quantity > 1) {
        const quantity = document.createElement('div');
        quantity.className = 'hud-hotbar-slot-quantity';
        quantity.textContent = itemData.quantity.toLocaleString();
        content.appendChild(quantity);
      }
      
      // Create tooltip
      createTooltip(slot, itemData);
    }
  }

  function showExpGainEffect(expGained) {
    const expGainEl = document.createElement('div');
    expGainEl.className = 'hud-exp-gain';
    expGainEl.textContent = `+${formatExpNumber(expGained)} XP`;
    
    const delay = expGainCount++ * HUD_CONFIG.expGainStaggerDelay;
    
    document.querySelector('.hud-status-container').appendChild(expGainEl);
    
    setTimeout(() => expGainEl.classList.add('show'), delay);
    setTimeout(() => {
      expGainEl.remove();
      expGainCount = Math.max(0, expGainCount - 1);
    }, HUD_CONFIG.expGainDuration + delay);
  }

  function showAreaBanner(areaName) {
    const banner = document.getElementById('hud-area-banner');
    const bannerText = banner.querySelector('.hud-area-banner-text');
    
    // Update text
    bannerText.textContent = areaName;
    
    // Wait 1.5 seconds before showing banner
    setTimeout(() => {
      // Show banner
      banner.classList.add('show');
      
      // Hide banner after 4 seconds
      setTimeout(() => {
        banner.classList.remove('show');
      }, 4000);
    }, 1500);
  }

  // Notification System
  function showNotification(message, type = 'success') {
    const container = document.getElementById('hud-notification-container');
    const notification = document.createElement('div');
    
    notification.className = 'hud-notification';
    notification.setAttribute('data-type', type);
    
    // Simple icon mapping
    const icons = { complete: '✓', new: '!' };
    const icon = icons[type];
    
    notification.innerHTML = `
      <div class="hud-notification-content">
        ${icon ? `<div class="hud-notification-icon">${icon}</div>` : ''}
        <div class="hud-notification-text">${message}</div>
      </div>
    `;
    
    container.appendChild(notification);
    
    // Animate in
    setTimeout(() => notification.classList.add('show'), 10);
    
    // Auto-dismiss
    setTimeout(() => {
      notification.classList.add('hide');
      setTimeout(() => notification.remove(), 400);
    }, HUD_CONFIG.notificationDuration);
  }

  // Death Overlay Functions
  function showDeathOverlay() {
    document.getElementById('hud-death-overlay').classList.add('show');
    hytopia.lockPointer(false);
  }

  function hideDeathOverlay() {
    document.getElementById('hud-death-overlay').classList.remove('show');
    hytopia.lockPointer(true);
  }

  // Utility Functions
  function fadeElement(element, opacity, duration = HUD_CONFIG.elementFadeDuration) {
    return new Promise(resolve => {
      element.style.transition = `opacity ${duration}ms ease-in-out`;
      element.style.opacity = opacity;
      setTimeout(resolve, duration);
    });
  }
  function delay(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

  async function handleRespawn() {
    const respawnFade = document.getElementById('hud-respawn-fade');
    const respawnBtn = document.getElementById('hud-death-respawn-btn');
    
    if (respawnBtn.disabled) return;
    
    try {
      respawnBtn.disabled = true;
      respawnBtn.style.opacity = '0.6';
      
      await fadeElement(respawnFade, 1);
      hideDeathOverlay();
      hytopia.sendData({ type: 'respawnPlayer' });
      await delay(HUD_CONFIG.respawnDelay);
      await fadeElement(respawnFade, 0);
      
    } finally {
      respawnBtn.disabled = false;
      respawnBtn.style.opacity = '';
    }
  }

  // Auto-attack system
  let autoAttackInterval = null;
  let lastTapTime = 0;

  function handleAttackTap() {
    const currentTime = Date.now();
    
    // Double tap detected (within 300ms)
    if (currentTime - lastTapTime < 300 && lastTapTime > 0) {
      stopAutoAttack();
      hytopia.pressInput('mr', true);
      setTimeout(() => hytopia.pressInput('mr', false), 100);
      lastTapTime = 0;
      return;
    }
    
    // Single tap - start auto attack
    lastTapTime = currentTime;
    startAutoAttack();
  }

  function startAutoAttack() {
    if (autoAttackInterval) return;
    
    // Immediate first attack
    hytopia.pressInput('ml', true);
    setTimeout(() => hytopia.pressInput('ml', false), 100);
    
    // Repeat every 500ms
    autoAttackInterval = setInterval(() => {
      hytopia.pressInput('ml', true);
      setTimeout(() => hytopia.pressInput('ml', false), 100);
    }, 500);
  }

  function stopAutoAttack() {
    if (autoAttackInterval) {
      clearInterval(autoAttackInterval);
      autoAttackInterval = null;
    }
  }

  // Initialize HUD
  initializeHUD();

  // Setup global functions
    window.lumberjackSimulator = window.lumberjackSimulator || {};
  window.lumberjackSimulator.updateHudQuestCount = updateHudQuestCount;

  // Global chopping bar functions for testing/external use
  window.lumberjackSimulator.showChoppingBar = showChoppingBar;
  window.lumberjackSimulator.updateChoppingBar = updateChoppingBar;
  window.lumberjackSimulator.hideChoppingBar = hideChoppingBar;

  // Tree chopping functions
  window.lumberjackSimulator.startTreeChopping = startTreeChopping;
  window.lumberjackSimulator.updateTreeChopping = updateTreeChopping;
  window.lumberjackSimulator.stopTreeChopping = stopTreeChopping;
</script>

<style>
  :root {
    /* Layout Variables */
    --hud-hotbar-size: 56px;
    --hud-bar-height: 20px;
    --hud-bar-width: 220px;
    --hud-hotbar-gap: 8px;
    --hud-actions-gap: 16px;
    --hud-status-gap: 12px;
    --hud-clock-size: 14px;
    
    /* Color Variables */
    --hud-primary: #2a2a2a;
    --hud-secondary: #1e1e1e;
    --hud-border: #444;
    --hud-health: #22c55e;
    --hud-exp: #ffd700;
    --hud-text: #ffffff;
    --hud-text-secondary: #cccccc;
    --hud-crosshair: rgba(255, 255, 255, 0.8);
    
    /* Font Variables */
    --hud-font: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    --hud-text-shadow: 0 1px 2px rgba(0, 0, 0, 0.9);
    
    /* Effect Variables */
    --hud-transition: 0.2s ease;
    --hud-box-shadow: 0 4px 16px rgba(0, 0, 0, 0.8);
    --hud-inset-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.1);
  }

  /* Base HUD Overlay */
  .hud-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 100;
    font-family: var(--hud-font);
    user-select: none;
  }

  /* ============================================
     AREA BANNER
     ============================================ */

  .hud-area-banner {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 1000;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.6s ease-out;
  }

  .hud-area-banner.show {
    opacity: 1;
    animation: areaBannerFade 4s ease-out;
  }

  .hud-area-banner-content {
    text-align: center;
  }

  .hud-area-banner-text {
    font-family: 'EB Garamond', serif;
    font-size: clamp(2.5rem, 6vw, 4.5rem);
    font-weight: 600;
    color: #f4f1e8;
    text-shadow: 
      0 0 30px rgba(244, 241, 232, 0.4),
      0 4px 12px rgba(0, 0, 0, 0.8);
    letter-spacing: 0.08em;
    text-transform: uppercase;
    margin: 0 0 5px 0;
    white-space: nowrap;
    transform: translateY(15px);
    opacity: 0;
  }

  .hud-area-banner.show .hud-area-banner-text {
    animation: textShow 1s ease-out 0.3s forwards;
  }

  .hud-area-banner-underline {
    width: 0;
    height: 4px;
    margin: 0 auto;
    background: linear-gradient(90deg, 
      transparent, 
      rgba(255, 215, 0, 0.6) 25%, 
      #ffd700 50%, 
      rgba(255, 215, 0, 0.6) 75%, 
      transparent);
    box-shadow: 
      0 0 20px rgba(255, 215, 0, 0.5),
      0 2px 6px rgba(0, 0, 0, 0.6);
    border-radius: 2px;
  }

  .hud-area-banner.show .hud-area-banner-underline {
    animation: underlineExpand 1.2s ease-out 0.8s forwards;
  }

  /* Animations */
  @keyframes areaBannerFade {
    0%, 85% { opacity: 1; }
    100% { opacity: 0; }
  }

  @keyframes textShow {
    to { 
      opacity: 0.8; 
      transform: translateY(0); 
    }
  }

  @keyframes underlineExpand {
    to { 
      width: min(500px, 70vw); 
      opacity: 1; 
    }
  }

  /* ============================================
     STATUS BARS
     ============================================ */

  .hud-status-container {
    position: absolute;
    bottom: 120px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    flex-direction: row;
    gap: var(--hud-status-gap);
    pointer-events: auto;
  }

  .hud-health-bar,
  .hud-chopping-bar,
  .hud-exp-bar {
    position: relative;
    width: var(--hud-bar-width);
    height: var(--hud-bar-height);
    background: rgba(0, 0, 0, 0.6);
    border: 1px solid var(--hud-border);
    border-radius: 8px;
    overflow: hidden;
    box-shadow: var(--hud-box-shadow), inset 0 1px 2px rgba(0, 0, 0, 0.5);
  }

  .hud-health-fill {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    background: linear-gradient(90deg, var(--hud-health), #16a34a);
    transition: width 0.3s ease;
    box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.2);
  }

  .hud-health-fill.health-high {
    background: linear-gradient(90deg, #4CAF50, #16a34a);
  }

  .hud-health-fill.health-medium {
    background: linear-gradient(90deg, #FFC107, #f59e0b);
  }

  .hud-health-fill.health-low {
    background: linear-gradient(90deg, #f44336, #dc2626);
  }

  .hud-chopping-fill {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    background: linear-gradient(90deg, #8b5a2b, #a0522d);
    transition: width 0.2s linear;
    box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.2);
  }

  .hud-exp-fill {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    background: linear-gradient(90deg, var(--hud-exp), #f59e0b);
    transition: width 0.5s ease;
    box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.2);
  }

  /* Progress Bar (for actions like chopping) */
  .hud-progress-container {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    margin-top: -40px; /* Position above crosshair */
    pointer-events: none;
    z-index: 5;
  }

  /* Tree Chopping Progress Bar */
  .hud-chopping-container {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    margin-top: -80px; /* Position above crosshair and progress bar */
    pointer-events: none;
    z-index: 6;
    display: none;
    transition: all 0.2s ease;
    font-family: var(--hud-font);
    user-select: none;
  }

  .hud-chopping-container .hud-chopping-bar {
    position: relative;
    width: 240px;
    height: 24px;
    background: rgba(0, 0, 0, 0.8);
    border: 2px solid rgba(139, 90, 43, 0.6);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 
      0 4px 12px rgba(0, 0, 0, 0.8),
      inset 0 1px 3px rgba(0, 0, 0, 0.6);
    margin-bottom: 6px;
  }

  .hud-chopping-container .hud-chopping-fill {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    background: linear-gradient(90deg, #dc2626, #ef4444);
    transition: width 0.1s linear, background 0.3s ease;
    box-shadow: inset 0 1px 3px rgba(255, 255, 255, 0.2);
  }

  .hud-chopping-container .hud-chopping-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 13px;
    font-weight: 700;
    color: var(--hud-text);
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.9);
    white-space: nowrap;
    z-index: 2;
    letter-spacing: 0.3px;
  }

  .hud-chopping-timer {
    text-align: center;
    font-size: 11px;
    font-weight: 600;
    color: #d97706;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.9);
    letter-spacing: 0.2px;
  }

  .hud-progress-bar {
    position: relative;
    width: 200px;
    height: 20px;
    background: rgba(0, 0, 0, 0.6);
    border: 1px solid var(--hud-border);
    border-radius: 8px;
    overflow: hidden;
    box-shadow: var(--hud-box-shadow), inset 0 1px 2px rgba(0, 0, 0, 0.5);
  }

  .hud-progress-fill {
    position: absolute;
    top: 0;
    left: 0;
    height: 100%;
    background: linear-gradient(90deg, #6b7280, #9ca3af);
    transition: width 0.1s linear;
    box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.1);
  }

  .hud-progress-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 11px;
    font-weight: 600;
    color: var(--hud-text);
    text-shadow: var(--hud-text-shadow);
    white-space: nowrap;
    z-index: 2;
  }

  .hud-health-text,
  .hud-chopping-text,
  .hud-exp-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 12px;
    font-weight: 600;
    color: var(--hud-text);
    text-shadow: var(--hud-text-shadow);
    white-space: nowrap;
    z-index: 2;
  }

  /* EXP Gain Effect */
  .hud-exp-gain {
    position: absolute;
    top: 50%;
    left: calc(var(--hud-bar-width) + var(--hud-status-gap) + var(--hud-bar-width) / 2);
    font-size: 14px;
    font-weight: 700;
    color: var(--hud-exp);
    text-shadow: var(--hud-text-shadow), 
                 0 0 8px rgba(255, 215, 0, 0.6),
                 1px 1px 0 #000, 
                 -1px -1px 0 #000;
    opacity: 0;
    transform: translate(-50%, -50%);
    pointer-events: none;
    z-index: 10;
    white-space: nowrap;
  }

  .hud-exp-gain.show {
    animation: expGainFloat 1.2s ease-out;
  }

  @keyframes expGainFloat {
    0% { 
      opacity: 0; 
      transform: translate(-50%, -50%) translateY(0) scale(0.6); 
    }
    15% { 
      opacity: 1; 
      transform: translate(-50%, -50%) translateY(-8px) scale(1.1); 
    }
    25% { 
      transform: translate(-50%, -50%) translateY(-12px) scale(1); 
    }
    100% { 
      opacity: 0; 
      transform: translate(-50%, -50%) translateY(-40px) scale(0.8); 
    }
  }

  /* ============================================
     HOTBAR
     ============================================ */

  .hud-hotbar-container {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    pointer-events: auto;
  }

  .hud-hotbar-grid {
    display: grid;
    grid-template-columns: repeat(8, 1fr);
    gap: var(--hud-hotbar-gap);
    background: linear-gradient(145deg, var(--hud-primary), var(--hud-secondary));
    padding: 12px;
    border: 2px solid var(--hud-border);
    border-radius: 12px;
    box-shadow: var(--hud-box-shadow), var(--hud-inset-shadow);
  }

  .hud-hotbar-slot {
    position: relative;
    width: var(--hud-hotbar-size);
    height: var(--hud-hotbar-size);
    background: rgba(0, 0, 0, 0.6);
    border: 2px solid #333;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all var(--hud-transition);
    overflow: visible;
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.5);
  }

  .hud-hotbar-slot:hover {
    border-color: #555;
    background: rgba(0, 0, 0, 0.8);
    transform: translateY(-2px);
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.5), 0 4px 12px rgba(0, 0, 0, 0.6);
  }

  .hud-hotbar-slot-active {
    border-color: var(--hud-text-secondary) !important;
    background: rgba(255, 255, 255, 0.05) !important;
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.5), 0 0 3px rgba(255, 255, 255, 0.2) !important;
  }

  .hud-hotbar-slot-active .hud-hotbar-slot-content {
    color: var(--hud-text-secondary);
  }

  .hud-hotbar-slot-content {
    position: relative;
    z-index: 2;
    font-size: 14px;
    font-weight: 600;
    color: #888;
    text-shadow: var(--hud-text-shadow);
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .hud-hotbar-slot-icon {
    width: 48px;
    height: 48px;
    object-fit: contain;
    image-rendering: pixelated;
    filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.8));
  }

  .hud-hotbar-slot-quantity {
    position: absolute;
    bottom: 2px;
    right: 2px;
    background: rgba(0, 0, 0, 0.8);
    color: var(--hud-text);
    font-size: 10px;
    font-weight: 700;
    padding: 1px 4px;
    border-radius: 3px;
    line-height: 1;
    text-shadow: var(--hud-text-shadow);
    border: 1px solid rgba(255, 255, 255, 0.2);
    min-width: 12px;
    text-align: center;
  }

  /* ============================================
     CLOCK
     ============================================ */

  .hud-clock-container {
    position: absolute;
    top: 20px;
    right: 20px;
    pointer-events: auto;
  }

  .hud-clock {
    background: linear-gradient(145deg, var(--hud-primary), var(--hud-secondary));
    border: 2px solid var(--hud-border);
    border-radius: 8px;
    padding: 12px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.6), var(--hud-inset-shadow);
  }

  .hud-clock-time {
    font-size: var(--hud-clock-size);
    font-weight: 600;
    color: var(--hud-text);
    text-shadow: var(--hud-text-shadow);
    text-align: center;
    font-variant-numeric: tabular-nums;
  }

  /* ============================================
     ACTION BUTTONS
     ============================================ */

  .hud-action-buttons {
    position: absolute;
    top: 80px;
    right: 20px;
    display: flex;
    flex-direction: column;
    gap: var(--hud-actions-gap);
    pointer-events: auto;
  }

  .hud-action-button {
    position: relative;
    width: var(--hud-hotbar-size);
    height: var(--hud-hotbar-size);
    background: linear-gradient(145deg, var(--hud-primary), var(--hud-secondary));
    border: 2px solid var(--hud-border);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all var(--hud-transition);
    overflow: visible;
    box-shadow: var(--hud-box-shadow), var(--hud-inset-shadow);
    padding: 0;
  }

  .hud-action-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.9), var(--hud-inset-shadow);
    border-color: #555;
  }

  .hud-action-button:hover .hud-action-tooltip {
    opacity: 1;
    visibility: visible;
    transform: translateX(-8px);
  }

  .hud-action-tooltip {
    position: absolute;
    right: 100%;
    margin-right: 12px;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    z-index: 1000;
    pointer-events: none;
  }

  .hud-action-tooltip-content {
    background: linear-gradient(145deg, var(--hud-primary), var(--hud-secondary));
    border: 2px solid var(--hud-border);
    border-radius: 8px;
    padding: 8px 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.8), var(--hud-inset-shadow);
    font-size: 11px;
    font-weight: 500;
    color: var(--hud-text);
    text-shadow: var(--hud-text-shadow);
    white-space: nowrap;
    line-height: 1.3;
    position: relative;
  }

  .hud-action-tooltip-content::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 100%;
    transform: translateY(-50%);
    width: 0;
    height: 0;
    border-top: 8px solid transparent;
    border-bottom: 8px solid transparent;
    border-left: 8px solid var(--hud-border);
  }

  .hud-action-tooltip-content::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 100%;
    transform: translateY(-50%);
    margin-left: -2px;
    width: 0;
    height: 0;
    border-top: 6px solid transparent;
    border-bottom: 6px solid transparent;
    border-left: 6px solid var(--hud-primary);
    z-index: 1;
  }

  .hud-action-button-icon {
    width: 100%;
    height: 100%;
    object-fit: contain;
    opacity: 0.8;
    border-radius: 6px;
    transition: opacity var(--hud-transition);
  }

  .hud-action-button:hover .hud-action-button-icon {
    opacity: 1;
  }

  /* Help Button Styles */
  .hud-help-icon {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    font-weight: 900;
    color: #cccccc;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.9);
    opacity: 0.8;
    transition: opacity var(--hud-transition);
  }

  .hud-action-button:hover .hud-help-icon {
    opacity: 1;
  }

  /* Key Indicators */
  .hud-action-key-indicator {
    position: absolute;
    bottom: 0px;
    right: 0px;
    width: 20px;
    height: 20px;
    background: linear-gradient(145deg, rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.6));
    border-radius: 6px;
    border-top-right-radius: 0;
    border-bottom-left-radius: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    font-weight: 700;
    color: var(--hud-text);
    text-shadow: var(--hud-text-shadow);
    z-index: 3;
    transition: all var(--hud-transition);
    pointer-events: none;
  }

  .hud-action-button:hover .hud-action-key-indicator {
    background: linear-gradient(145deg, rgba(0, 0, 0, 0.95), rgba(0, 0, 0, 0.85));
  }

  /* Hide key indicators on mobile */
  body.mobile .hud-action-key-indicator {
    display: none;
  }

  /* Hide help button on mobile */
  body.mobile .hud-help-button {
    display: none;
  }

  /* Quest Count Indicator */
  .hud-quest-count-indicator {
    position: absolute;
    top: -8px;
    left: -8px;
    width: 18px;
    height: 18px;
    background: linear-gradient(145deg, #4CAF50, #66BB6A);
    border: 1px solid rgba(76, 175, 80, 0.8);
    border-radius: 50%;
    display: none;
    align-items: center;
    justify-content: center;
    font-size: 9px;
    font-weight: 700;
    color: #ffffff;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.9);
    z-index: 4;
    box-shadow: 
      0 0 8px rgba(76, 175, 80, 0.5),
      0 1px 4px rgba(0, 0, 0, 0.8),
      inset 0 1px 0 rgba(255, 255, 255, 0.3);
    transition: all var(--hud-transition);
    pointer-events: none;
  }

  .hud-quest-count-indicator.show {
    display: flex;
  }

  .hud-action-button:hover .hud-quest-count-indicator {
    transform: scale(1.1);
    box-shadow: 
      0 0 12px rgba(76, 175, 80, 0.7),
      0 1px 4px rgba(0, 0, 0, 0.8),
      inset 0 1px 0 rgba(255, 255, 255, 0.3);
  }

  /* Help Notification Indicator */
  .hud-help-notification-indicator {
    position: absolute;
    top: -6px;
    left: -6px;
    width: 14px;
    height: 14px;
    background: #dc2626;
    border-radius: 50%;
    display: none;
    z-index: 4;
    pointer-events: none;
    animation: pulse 2s infinite;
  }

  .hud-help-notification-indicator.show {
    display: block;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
  /* ============================================
     NOTIFICATION TOASTS
     ============================================ */

  .hud-notification-container {
    position: absolute;
    top: 80px;
    right: 90px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    pointer-events: none;
    font-family: var(--hud-font);
    z-index: 100000;
  }

  .hud-notification {
    background: linear-gradient(145deg, var(--hud-primary), var(--hud-secondary));
    border: 2px solid var(--notification-color);
    border-radius: 8px;
    padding: 12px 16px;
    min-width: 200px;
    max-width: 300px;
    
    box-shadow: 
      0 4px 16px rgba(0, 0, 0, 0.8),
      0 0 8px var(--notification-glow),
      var(--hud-inset-shadow);
    
    opacity: 0;
    transform: translateX(120%) scale(0.9);
    transition: all 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    pointer-events: auto;
  }

  .hud-notification[data-type="success"],
  .hud-notification[data-type="complete"],
  .hud-notification[data-type="new"] { 
    --notification-color: #4CAF50; 
    --notification-glow: rgba(76, 175, 80, 0.3);
  }

  .hud-notification[data-type="warning"] { 
    --notification-color: #FFC107; 
    --notification-glow: rgba(255, 193, 7, 0.3);
  }

  .hud-notification[data-type="error"] { 
    --notification-color: #f44336; 
    --notification-glow: rgba(244, 67, 54, 0.3);
  }

  .hud-notification.show {
    opacity: 1;
    transform: translateX(0) scale(1);
  }

  .hud-notification.hide {
    opacity: 0;
    transform: translateX(120%) scale(0.9);
    transition: all 0.4s ease-out;
  }

  /* Notification Content Layout */
  .hud-notification-content {
    display: flex;
    align-items: center;
    gap: 10px;
    width: 100%;
  }

  .hud-notification-icon {
    width: 16px;
    height: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 900;
    color: #ffffff;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.9);
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 50%;
    flex-shrink: 0;
  }

  .hud-notification-text {
    flex: 1;
    line-height: 1.4;
  }

  /* Notification text styling */
  .hud-notification-text {
    font-size: 12px;
    font-weight: 500;
    color: var(--hud-text);
    text-shadow: var(--hud-text-shadow);
    word-wrap: break-word;
  }

  /* ============================================
     CROSSHAIR
     ============================================ */

  .hud-crosshair {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    pointer-events: none;
    z-index: 50;
  }

  .hud-crosshair-horizontal,
  .hud-crosshair-vertical {
    position: absolute;
    background: var(--hud-crosshair);
    box-shadow: 0 0 2px rgba(0, 0, 0, 0.8);
  }

  .hud-crosshair-horizontal {
    width: 12px;
    height: 2px;
    top: -1px;
    left: -6px;
  }

  .hud-crosshair-vertical {
    width: 2px;
    height: 12px;
    top: -6px;
    left: -1px;
  }

  /* ============================================
     DEATH OVERLAY
     ============================================ */

  .hud-death-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.6s ease-out;
  }

  .hud-death-overlay.show {
    opacity: 1;
    pointer-events: auto;
  }

  /* ============================================
     RESPAWN FADE OVERLAY
     ============================================ */

  .hud-respawn-fade {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: #000000;
    z-index: 15000;
    opacity: 0;
    pointer-events: none;
  }

  .hud-death-content {
    text-align: center;
    transform: translateY(15px);
    opacity: 0;
    transition: all 0.8s ease-out;
    max-width: 500px;
    margin: 0 20px;
  }

  .hud-death-overlay.show .hud-death-content {
    transform: translateY(0);
    opacity: 1;
  }

  .hud-death-title {
    font-family: 'EB Garamond', serif;
    font-size: clamp(2.5rem, 6vw, 4.5rem);
    font-weight: 600;
    color: #dc2626;
    text-shadow: 
      0 0 30px rgba(220, 38, 38, 0.4),
      0 4px 12px rgba(0, 0, 0, 0.8);
    letter-spacing: 0.08em;
    text-transform: uppercase;
    margin: 0 0 5px 0;
    white-space: nowrap;
    transform: translateY(15px);
    opacity: 0;
  }

  .hud-death-overlay.show .hud-death-title {
    animation: deathTitleShow 1s ease-out 0.3s forwards;
  }

  .hud-death-subtitle {
    font-family: var(--hud-font);
    font-size: clamp(0.9rem, 2.5vw, 1.1rem);
    font-weight: 500;
    color: var(--hud-text-secondary);
    text-shadow: var(--hud-text-shadow);
    margin: 0 0 12px 0;
    opacity: 0.8;
    line-height: 1.4;
    transform: translateY(15px);
    opacity: 0;
  }

  .hud-death-overlay.show .hud-death-subtitle {
    animation: deathSubtitleShow 1s ease-out 0.5s forwards;
  }

  .hud-death-underline {
    width: 0;
    height: 3px;
    margin: 0 auto 24px auto;
    background: linear-gradient(90deg, 
      transparent, 
      rgba(220, 38, 38, 0.6) 25%, 
      #dc2626 50%, 
      rgba(220, 38, 38, 0.6) 75%, 
      transparent);
    box-shadow: 
      0 0 20px rgba(220, 38, 38, 0.5),
      0 2px 6px rgba(0, 0, 0, 0.6);
    border-radius: 2px;
    opacity: 0;
  }

  .hud-death-overlay.show .hud-death-underline {
    animation: deathUnderlineExpand 1.2s ease-out 0.8s forwards;
  }

  .hud-death-respawn-btn {
    background: linear-gradient(145deg, #dc2626, #b91c1c);
    border: 2px solid #991b1b;
    border-radius: 8px;
    padding: 12px 24px;
    font-family: var(--hud-font);
    font-size: 14px;
    font-weight: 600;
    color: var(--hud-text);
    text-shadow: var(--hud-text-shadow);
    cursor: pointer;
    transition: all var(--hud-transition);
    box-shadow: 
      0 4px 12px rgba(220, 38, 38, 0.3),
      inset 0 1px 2px rgba(255, 255, 255, 0.1);
    text-transform: uppercase;
    letter-spacing: 0.02em;
    position: relative;
    overflow: hidden;
    min-width: 120px;
  }

  .hud-death-respawn-btn:hover {
    background: linear-gradient(145deg, #ef4444, #dc2626);
    border-color: #b91c1c;
    transform: translateY(-2px);
    box-shadow: 
      0 6px 16px rgba(220, 38, 38, 0.4),
      inset 0 1px 2px rgba(255, 255, 255, 0.1);
  }

  .hud-death-respawn-btn:active {
    transform: translateY(0);
  }

  .hud-death-respawn-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
    transition: left 0.5s ease;
  }

  .hud-death-respawn-btn:hover::before {
    left: 100%;
  }

  .hud-death-respawn-text {
    position: relative;
    z-index: 2;
  }

  @keyframes deathTitleShow {
    to { 
      opacity: 0.9; 
      transform: translateY(0); 
    }
  }

  @keyframes deathSubtitleShow {
    to { 
      opacity: 0.9; 
      transform: translateY(0); 
    }
  }

  @keyframes deathUnderlineExpand {
    to { 
      width: min(250px, 60vw); 
      opacity: 1; 
    }
  }

  /* ============================================
     MOBILE CONTROL BUTTONS
     ============================================ */

  .hud-mobile-button {
    width: 50px;
    height: 50px;
    background: linear-gradient(145deg, var(--hud-primary), var(--hud-secondary));
    border: 2px solid var(--hud-border);
    border-radius: 50%;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 0;
    position: absolute;
    overflow: hidden;
    transition: all var(--hud-transition);
    box-shadow: var(--hud-box-shadow), var(--hud-inset-shadow);
    pointer-events: auto;
    
    /* Mobile optimizations */
    -webkit-tap-highlight-color: transparent;
    -webkit-touch-callout: none;
    user-select: none;
    outline: none;
  }

  /* Individual button positioning */
  #hud-attack-btn {
    bottom: 50px;
    right: 70px;
    height: 70px;
    width: 70px;
  }

  #hud-dodge-btn {
    bottom: 50px;
    right: 155px;
  }

  #hud-jump-btn {
    bottom: 130px;
    right: 50px;
  }

  #hud-interact-btn {
    bottom: 120px;
    right: 130px;
  }

  .hud-mobile-button:active {
    transform: scale(0.95);
    box-shadow: var(--hud-box-shadow);
  }

  .hud-mobile-button-icon {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: contain;
    opacity: 0.85;
    transition: opacity var(--hud-transition);
    filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.8));
  }

  .hud-mobile-button:active .hud-mobile-button-icon {
    opacity: 1;
  }

  /* ============================================
     MOBILE RESPONSIVE
     ============================================ */

  body.mobile {
    --hud-hotbar-size: 44px;
    --hud-bar-height: 16px;
    --hud-bar-width: 160px;
    --hud-hotbar-gap: 5px;
    --hud-status-gap: 10px;
    --hud-clock-size: 10px;
    --hud-actions-gap: 10px;
  }

  /* Show mobile buttons only on mobile */
  body.mobile .hud-mobile-button {
    display: flex;
  }

  body.mobile .hud-hotbar-container {
    bottom: 8px;
  }

  body.mobile .hud-hotbar-grid {
    padding: 8px;
    border-radius: 8px;
    gap: 4px;
  }

  body.mobile .hud-status-container {
    bottom: 82px;
    gap: 16px;
  }

  body.mobile .hud-clock-container {
    top: 16px;
    right: 16px;
  }

  body.mobile .hud-clock {
    padding: 8px 10px;
    border-radius: 8px;
  }

  body.mobile .hud-hotbar-slot {
    border-radius: 8px;
    border-width: 2px;
  }

  body.mobile .hud-hotbar-slot-content {
    font-size: 12px;
  }

  body.mobile .hud-hotbar-slot-icon {
    width: 32px;
    height: 32px;
  }

  body.mobile .hud-hotbar-slot-quantity {
    font-size: 8px;
    padding: 1px 3px;
    bottom: 2px;
    right: 2px;
  }

  body.mobile .hud-health-bar,
  body.mobile .hud-exp-bar {
    border-radius: 8px;
  }

  body.mobile .hud-health-text,
  body.mobile .hud-exp-text {
    font-size: 10px;
  }

  body.mobile .hud-exp-gain {
    font-size: 12px;
    left: calc(var(--hud-bar-width) + var(--hud-status-gap) + var(--hud-bar-width) / 2);
  }

  body.mobile .hud-action-buttons {
    top: 55px;
    right: 16px;
    gap: 10px;
  }

  body.mobile .hud-action-button {
    width: 44px;
    height: 44px;
    border-radius: 8px;
    border-width: 2px;
  }

  body.mobile .hud-action-button-icon {
    width: 44px;
    height: 44px;
  }

  body.mobile .hud-action-tooltip {
    display: none;
  }

  body.mobile .hud-action-key-indicator {
    width: 16px;
    height: 16px;
    top: -6px;
    right: -6px;
    font-size: 8px;
    border-radius: 6px;
  }

  body.mobile .hud-quest-count-indicator {
    width: 16px;
    height: 16px;
    top: -6px;
    left: -6px;
    font-size: 9px;
  }

  body.mobile .hud-help-notification-indicator {
    width: 12px;
    height: 12px;
    top: -5px;
    left: -5px;
  }

  body.mobile .hud-help-icon {
    font-size: 20px;
  }

  /* Notification Mobile Adjustments */
  body.mobile .hud-notification-container {
    top: 55px;
    right: 70px;
    gap: 8px;
  }

  body.mobile .hud-notification {
    min-width: 160px;
    max-width: 240px;
    padding: 10px 12px;
    font-size: 10px;
    border-radius: 8px;
  }

  body.mobile .hud-notification-content {
    gap: 8px;
  }

  body.mobile .hud-notification-icon {
    width: 14px;
    height: 14px;
    font-size: 10px;
  }

  body.mobile .hud-notification-text {
    font-size: 10px;
  }

  body.mobile .hud-crosshair-horizontal {
    width: 10px;
    height: 2px;
    left: -5px;
    top: -1px;
  }

  body.mobile .hud-crosshair-vertical {
    width: 2px;
    height: 10px;
    top: -5px;
    left: -1px;
  }

  /* Area Banner Mobile */
  body.mobile .hud-area-banner-text {
    font-size: clamp(1.8rem, 9vw, 3rem);
    letter-spacing: 0.05em;
    margin: 0 0 4px 0;
  }

  body.mobile .hud-area-banner-underline {
    height: 4px;
  }

  body.mobile .hud-area-banner.show .hud-area-banner-underline {
    animation: underlineExpandMobile 1.2s ease-out 0.8s forwards;
  }

  @keyframes underlineExpandMobile {
    to { 
      width: min(300px, 80vw); 
      opacity: 1; 
    }
  }

  /* Death Overlay Mobile */
  body.mobile .hud-death-content {
    margin: 0 16px;
    max-width: 90vw;
  }

  body.mobile .hud-death-title {
    font-size: clamp(1.8rem, 9vw, 3.5rem);
    margin: 0 0 4px 0;
    letter-spacing: 0.05em;
  }

  body.mobile .hud-death-subtitle {
    font-size: clamp(0.8rem, 4vw, 1rem);
    margin: 0 0 10px 0;
  }

  body.mobile .hud-death-underline {
    margin: 0 auto 18px auto;
    height: 3px;
  }

  body.mobile .hud-death-overlay.show .hud-death-underline {
    animation: deathUnderlineExpandMobile 1.2s ease-out 0.8s forwards;
  }

  @keyframes deathUnderlineExpandMobile {
    to { 
      width: min(220px, 75vw); 
      opacity: 1; 
    }
  }

  body.mobile .hud-death-respawn-btn {
    font-size: 12px;
    padding: 10px 20px;
    min-width: 100px;
    border-radius: 8px;
  }

  /* ============================================
     HIGH DPI DISPLAYS
     ============================================ */

  @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
    .hud-health-text,
    .hud-exp-text,
    .hud-hotbar-slot-content {
      text-rendering: optimizeLegibility;
      -webkit-font-smoothing: antialiased;
    }
  }
</style>